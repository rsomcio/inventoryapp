"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
var _exportNames = {
  SkipPrepareToken: true,
  ProviderPlugin: true,
  ProvidedHOC: true,
  Provider: true,
  FusionContext: true,
  ServiceConsumer: true,
  ServiceContext: true,
  useService: true,
  withServices: true
};
Object.defineProperty(exports, "ProviderPlugin", {
  enumerable: true,
  get: function () {
    return _plugin.default;
  }
});
Object.defineProperty(exports, "ProvidedHOC", {
  enumerable: true,
  get: function () {
    return _hoc.default;
  }
});
Object.defineProperty(exports, "Provider", {
  enumerable: true,
  get: function () {
    return _provider.default;
  }
});
Object.defineProperty(exports, "FusionContext", {
  enumerable: true,
  get: function () {
    return _context.FusionContext;
  }
});
Object.defineProperty(exports, "ServiceConsumer", {
  enumerable: true,
  get: function () {
    return _context.ServiceConsumer;
  }
});
Object.defineProperty(exports, "ServiceContext", {
  enumerable: true,
  get: function () {
    return _context.ServiceContext;
  }
});
Object.defineProperty(exports, "useService", {
  enumerable: true,
  get: function () {
    return _context.useService;
  }
});
Object.defineProperty(exports, "withServices", {
  enumerable: true,
  get: function () {
    return _context.withServices;
  }
});
exports.default = exports.SkipPrepareToken = void 0;

var React = _interopRequireWildcard(require("react"));

var _fusionCore = _interopRequireWildcard(require("fusion-core"));

var _index = require("./async/index.js");

Object.keys(_index).forEach(function (key) {
  if (key === "default" || key === "__esModule") return;
  if (Object.prototype.hasOwnProperty.call(_exportNames, key)) return;
  Object.defineProperty(exports, key, {
    enumerable: true,
    get: function () {
      return _index[key];
    }
  });
});

var _prepareProvider = _interopRequireDefault(require("./async/prepare-provider"));

var _server = _interopRequireDefault(require("./server"));

var _plugin = _interopRequireDefault(require("./plugin"));

var _hoc = _interopRequireDefault(require("./hoc"));

var _provider = _interopRequireDefault(require("./provider"));

var _context = require("./context.js");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */

/* eslint-env browser */
const SkipPrepareToken = (0, _fusionCore.createToken)('SkipPrepareToken');
exports.SkipPrepareToken = SkipPrepareToken;

class App extends _fusionCore.default {
  constructor(root, render) {
    if (!React.isValidElement(root)) {
      throw new Error('Invalid React element. Ensure your root element is a React.Element (e.g. <Foo />) and not a React.Component (e.g. Foo)');
    }

    const getService = token => {
      // $FlowFixMe
      const provides = this.getService(token);
      const isRequiredToken = Boolean(token.optional);

      if (typeof provides === 'undefined' && isRequiredToken) {
        throw new Error(`Token ${token.name} not registered or registered plugin does not provide a service. To use an optional plugin, use \`Token.optional\`.`);
      }

      return provides;
    };

    const renderer = (0, _fusionCore.createPlugin)({
      deps: {
        criticalChunkIds: _fusionCore.CriticalChunkIdsToken.optional,
        skipPrepare: SkipPrepareToken.optional
      },

      provides({
        skipPrepare
      }) {
        return (el, ctx) => {
          return (skipPrepare ? Promise.resolve() : (0, _index.prepare)(el)).then(() => {
            if (render) {
              return render(el, ctx);
            }

            if (true) {
              return (0, _server.default)(el);
            } else {
              return clientRender(el);
            }
          });
        };
      },

      middleware({
        criticalChunkIds
      }) {
        return (ctx, next) => {
          if (true && !ctx.element) {
            return next();
          }

          const markAsCritical = true ? chunkId => {
            // Push to legacy context for backwards compat w/ legacy SSR template
            ctx.preloadChunks.push(chunkId); // Also use new service if registered

            if (criticalChunkIds) {
              let chunkIds = criticalChunkIds.from(ctx);
              chunkIds.add(chunkId);
            }
          } : noop;
          ctx.element = React.createElement(_prepareProvider.default, {
            markAsCritical: markAsCritical
          }, React.createElement(_context.FusionContext.Provider, {
            value: ctx
          }, React.createElement(_context.ServiceContext.Provider, {
            value: getService
          }, ctx.element)));
          return next();
        };
      }

    });
    super(root, renderer);
  }

}

exports.default = App;

function noop() {}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIlNraXBQcmVwYXJlVG9rZW4iLCJBcHAiLCJGdXNpb25BcHAiLCJjb25zdHJ1Y3RvciIsInJvb3QiLCJyZW5kZXIiLCJSZWFjdCIsImlzVmFsaWRFbGVtZW50IiwiRXJyb3IiLCJnZXRTZXJ2aWNlIiwidG9rZW4iLCJwcm92aWRlcyIsImlzUmVxdWlyZWRUb2tlbiIsIkJvb2xlYW4iLCJvcHRpb25hbCIsIm5hbWUiLCJyZW5kZXJlciIsImRlcHMiLCJjcml0aWNhbENodW5rSWRzIiwiQ3JpdGljYWxDaHVua0lkc1Rva2VuIiwic2tpcFByZXBhcmUiLCJlbCIsImN0eCIsIlByb21pc2UiLCJyZXNvbHZlIiwidGhlbiIsImNsaWVudFJlbmRlciIsIm1pZGRsZXdhcmUiLCJuZXh0IiwiZWxlbWVudCIsIm1hcmtBc0NyaXRpY2FsIiwiY2h1bmtJZCIsInByZWxvYWRDaHVua3MiLCJwdXNoIiwiY2h1bmtJZHMiLCJmcm9tIiwiYWRkIiwibm9vcCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBU0E7O0FBRUE7O0FBTUE7O0FBNkdBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBOztBQTVHQTs7QUFFQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFFQTs7Ozs7Ozs7QUEzQkE7Ozs7Ozs7O0FBUUE7QUEyQk8sTUFBTUEsZ0JBQWdCLEdBQUcsNkJBQXFCLGtCQUFyQixDQUF6Qjs7O0FBTVEsTUFBTUMsR0FBTixTQUFrQkMsbUJBQWxCLENBQTRCO0FBQ3pDQyxFQUFBQSxXQUFXLENBQUNDLElBQUQsRUFBeUJDLE1BQXpCLEVBQTBDO0FBQ25ELFFBQUksQ0FBQ0MsS0FBSyxDQUFDQyxjQUFOLENBQXFCSCxJQUFyQixDQUFMLEVBQWlDO0FBQy9CLFlBQU0sSUFBSUksS0FBSixDQUNKLHdIQURJLENBQU47QUFHRDs7QUFDRCxVQUFNQyxVQUFVLEdBQUdDLEtBQUssSUFBSTtBQUMxQjtBQUNBLFlBQU1DLFFBQVEsR0FBRyxLQUFLRixVQUFMLENBQWdCQyxLQUFoQixDQUFqQjtBQUNBLFlBQU1FLGVBQWUsR0FBR0MsT0FBTyxDQUFDSCxLQUFLLENBQUNJLFFBQVAsQ0FBL0I7O0FBQ0EsVUFBSSxPQUFPSCxRQUFQLEtBQW9CLFdBQXBCLElBQW1DQyxlQUF2QyxFQUF3RDtBQUN0RCxjQUFNLElBQUlKLEtBQUosQ0FDSCxTQUFRRSxLQUFLLENBQUNLLElBQUsscUhBRGhCLENBQU47QUFHRDs7QUFDRCxhQUFPSixRQUFQO0FBQ0QsS0FWRDs7QUFXQSxVQUFNSyxRQUFRLEdBQUcsOEJBQWE7QUFDNUJDLE1BQUFBLElBQUksRUFBRTtBQUNKQyxRQUFBQSxnQkFBZ0IsRUFBRUMsa0NBQXNCTCxRQURwQztBQUVKTSxRQUFBQSxXQUFXLEVBQUVwQixnQkFBZ0IsQ0FBQ2M7QUFGMUIsT0FEc0I7O0FBSzVCSCxNQUFBQSxRQUFRLENBQUM7QUFBQ1MsUUFBQUE7QUFBRCxPQUFELEVBQWdCO0FBQ3RCLGVBQU8sQ0FBQ0MsRUFBRCxFQUF1QkMsR0FBdkIsS0FBK0I7QUFDcEMsaUJBQU8sQ0FBQ0YsV0FBVyxHQUFHRyxPQUFPLENBQUNDLE9BQVIsRUFBSCxHQUF1QixvQkFBUUgsRUFBUixDQUFuQyxFQUFnREksSUFBaEQsQ0FBcUQsTUFBTTtBQUNoRSxnQkFBSXBCLE1BQUosRUFBWTtBQUNWLHFCQUFPQSxNQUFNLENBQUNnQixFQUFELEVBQUtDLEdBQUwsQ0FBYjtBQUNEOztBQUNELHNCQUFjO0FBQ1oscUJBQU8scUJBQWFELEVBQWIsQ0FBUDtBQUNELGFBRkQsTUFFTztBQUNMLHFCQUFPSyxZQUFZLENBQUNMLEVBQUQsQ0FBbkI7QUFDRDtBQUNGLFdBVE0sQ0FBUDtBQVVELFNBWEQ7QUFZRCxPQWxCMkI7O0FBbUI1Qk0sTUFBQUEsVUFBVSxDQUFDO0FBQUNULFFBQUFBO0FBQUQsT0FBRCxFQUFxQjtBQUM3QixlQUFPLENBQUNJLEdBQUQsRUFBTU0sSUFBTixLQUFlO0FBQ3BCLGNBQUksUUFBWSxDQUFDTixHQUFHLENBQUNPLE9BQXJCLEVBQThCO0FBQzVCLG1CQUFPRCxJQUFJLEVBQVg7QUFDRDs7QUFFRCxnQkFBTUUsY0FBYyxHQUFHLE9BQ25CQyxPQUFPLElBQUk7QUFDVDtBQUNBVCxZQUFBQSxHQUFHLENBQUNVLGFBQUosQ0FBa0JDLElBQWxCLENBQXVCRixPQUF2QixFQUZTLENBSVQ7O0FBQ0EsZ0JBQUliLGdCQUFKLEVBQXNCO0FBQ3BCLGtCQUFJZ0IsUUFBUSxHQUFHaEIsZ0JBQWdCLENBQUNpQixJQUFqQixDQUFzQmIsR0FBdEIsQ0FBZjtBQUNBWSxjQUFBQSxRQUFRLENBQUNFLEdBQVQsQ0FBYUwsT0FBYjtBQUNEO0FBQ0YsV0FWa0IsR0FXbkJNLElBWEo7QUFZQWYsVUFBQUEsR0FBRyxDQUFDTyxPQUFKLEdBQ0Usb0JBQUMsd0JBQUQ7QUFBaUIsWUFBQSxjQUFjLEVBQUVDO0FBQWpDLGFBQ0Usb0JBQUMsc0JBQUQsQ0FBZSxRQUFmO0FBQXdCLFlBQUEsS0FBSyxFQUFFUjtBQUEvQixhQUNFLG9CQUFDLHVCQUFELENBQWdCLFFBQWhCO0FBQXlCLFlBQUEsS0FBSyxFQUFFYjtBQUFoQyxhQUNHYSxHQUFHLENBQUNPLE9BRFAsQ0FERixDQURGLENBREY7QUFTQSxpQkFBT0QsSUFBSSxFQUFYO0FBQ0QsU0EzQkQ7QUE0QkQ7O0FBaEQyQixLQUFiLENBQWpCO0FBa0RBLFVBQU14QixJQUFOLEVBQVlZLFFBQVo7QUFDRDs7QUFyRXdDOzs7O0FBbUYzQyxTQUFTcUIsSUFBVCxHQUFnQixDQUFFIiwic291cmNlc0NvbnRlbnQiOlsiLyoqIENvcHlyaWdodCAoYykgMjAxOCBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBmbG93XG4gKi9cblxuLyogZXNsaW50LWVudiBicm93c2VyICovXG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCBGdXNpb25BcHAsIHtcbiAgY3JlYXRlVG9rZW4sXG4gIGNyZWF0ZVBsdWdpbixcbiAgQ3JpdGljYWxDaHVua0lkc1Rva2VuLFxuICB0eXBlIENvbnRleHQsXG59IGZyb20gJ2Z1c2lvbi1jb3JlJztcbmltcG9ydCB7cHJlcGFyZX0gZnJvbSAnLi9hc3luYy9pbmRleC5qcyc7XG5pbXBvcnQgUHJlcGFyZVByb3ZpZGVyIGZyb20gJy4vYXN5bmMvcHJlcGFyZS1wcm92aWRlcic7XG5cbmltcG9ydCBzZXJ2ZXJSZW5kZXIgZnJvbSAnLi9zZXJ2ZXInO1xuaW1wb3J0IGNsaWVudFJlbmRlciBmcm9tICcuL2NsaWVudCc7XG5cbmltcG9ydCBQcm92aWRlclBsdWdpbiBmcm9tICcuL3BsdWdpbic7XG5pbXBvcnQgUHJvdmlkZWRIT0MgZnJvbSAnLi9ob2MnO1xuaW1wb3J0IFByb3ZpZGVyIGZyb20gJy4vcHJvdmlkZXInO1xuXG5pbXBvcnQge1xuICBGdXNpb25Db250ZXh0LFxuICBTZXJ2aWNlQ29uc3VtZXIsXG4gIFNlcnZpY2VDb250ZXh0LFxuICB1c2VTZXJ2aWNlLFxuICB3aXRoU2VydmljZXMsXG59IGZyb20gJy4vY29udGV4dC5qcyc7XG5cbmV4cG9ydCBjb25zdCBTa2lwUHJlcGFyZVRva2VuID0gY3JlYXRlVG9rZW48Ym9vbGVhbj4oJ1NraXBQcmVwYXJlVG9rZW4nKTtcblxuZXhwb3J0IHR5cGUgUmVuZGVyID0gKGVsOiBSZWFjdC5FbGVtZW50PCo+LCBjb250ZXh0OiBDb250ZXh0KSA9PiBhbnk7XG5cbmRlY2xhcmUgdmFyIF9fTk9ERV9fOiBCb29sZWFuO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBcHAgZXh0ZW5kcyBGdXNpb25BcHAge1xuICBjb25zdHJ1Y3Rvcihyb290OiBSZWFjdC5FbGVtZW50PCo+LCByZW5kZXI6ID9SZW5kZXIpIHtcbiAgICBpZiAoIVJlYWN0LmlzVmFsaWRFbGVtZW50KHJvb3QpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdJbnZhbGlkIFJlYWN0IGVsZW1lbnQuIEVuc3VyZSB5b3VyIHJvb3QgZWxlbWVudCBpcyBhIFJlYWN0LkVsZW1lbnQgKGUuZy4gPEZvbyAvPikgYW5kIG5vdCBhIFJlYWN0LkNvbXBvbmVudCAoZS5nLiBGb28pJ1xuICAgICAgKTtcbiAgICB9XG4gICAgY29uc3QgZ2V0U2VydmljZSA9IHRva2VuID0+IHtcbiAgICAgIC8vICRGbG93Rml4TWVcbiAgICAgIGNvbnN0IHByb3ZpZGVzID0gdGhpcy5nZXRTZXJ2aWNlKHRva2VuKTtcbiAgICAgIGNvbnN0IGlzUmVxdWlyZWRUb2tlbiA9IEJvb2xlYW4odG9rZW4ub3B0aW9uYWwpO1xuICAgICAgaWYgKHR5cGVvZiBwcm92aWRlcyA9PT0gJ3VuZGVmaW5lZCcgJiYgaXNSZXF1aXJlZFRva2VuKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVG9rZW4gJHt0b2tlbi5uYW1lfSBub3QgcmVnaXN0ZXJlZCBvciByZWdpc3RlcmVkIHBsdWdpbiBkb2VzIG5vdCBwcm92aWRlIGEgc2VydmljZS4gVG8gdXNlIGFuIG9wdGlvbmFsIHBsdWdpbiwgdXNlIFxcYFRva2VuLm9wdGlvbmFsXFxgLmBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBwcm92aWRlcztcbiAgICB9O1xuICAgIGNvbnN0IHJlbmRlcmVyID0gY3JlYXRlUGx1Z2luKHtcbiAgICAgIGRlcHM6IHtcbiAgICAgICAgY3JpdGljYWxDaHVua0lkczogQ3JpdGljYWxDaHVua0lkc1Rva2VuLm9wdGlvbmFsLFxuICAgICAgICBza2lwUHJlcGFyZTogU2tpcFByZXBhcmVUb2tlbi5vcHRpb25hbCxcbiAgICAgIH0sXG4gICAgICBwcm92aWRlcyh7c2tpcFByZXBhcmV9KSB7XG4gICAgICAgIHJldHVybiAoZWw6IFJlYWN0LkVsZW1lbnQ8Kj4sIGN0eCkgPT4ge1xuICAgICAgICAgIHJldHVybiAoc2tpcFByZXBhcmUgPyBQcm9taXNlLnJlc29sdmUoKSA6IHByZXBhcmUoZWwpKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIGlmIChyZW5kZXIpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlbmRlcihlbCwgY3R4KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChfX05PREVfXykge1xuICAgICAgICAgICAgICByZXR1cm4gc2VydmVyUmVuZGVyKGVsKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiBjbGllbnRSZW5kZXIoZWwpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgfSxcbiAgICAgIG1pZGRsZXdhcmUoe2NyaXRpY2FsQ2h1bmtJZHN9KSB7XG4gICAgICAgIHJldHVybiAoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgICAgaWYgKF9fTk9ERV9fICYmICFjdHguZWxlbWVudCkge1xuICAgICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBtYXJrQXNDcml0aWNhbCA9IF9fTk9ERV9fXG4gICAgICAgICAgICA/IGNodW5rSWQgPT4ge1xuICAgICAgICAgICAgICAgIC8vIFB1c2ggdG8gbGVnYWN5IGNvbnRleHQgZm9yIGJhY2t3YXJkcyBjb21wYXQgdy8gbGVnYWN5IFNTUiB0ZW1wbGF0ZVxuICAgICAgICAgICAgICAgIGN0eC5wcmVsb2FkQ2h1bmtzLnB1c2goY2h1bmtJZCk7XG5cbiAgICAgICAgICAgICAgICAvLyBBbHNvIHVzZSBuZXcgc2VydmljZSBpZiByZWdpc3RlcmVkXG4gICAgICAgICAgICAgICAgaWYgKGNyaXRpY2FsQ2h1bmtJZHMpIHtcbiAgICAgICAgICAgICAgICAgIGxldCBjaHVua0lkcyA9IGNyaXRpY2FsQ2h1bmtJZHMuZnJvbShjdHgpO1xuICAgICAgICAgICAgICAgICAgY2h1bmtJZHMuYWRkKGNodW5rSWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgOiBub29wO1xuICAgICAgICAgIGN0eC5lbGVtZW50ID0gKFxuICAgICAgICAgICAgPFByZXBhcmVQcm92aWRlciBtYXJrQXNDcml0aWNhbD17bWFya0FzQ3JpdGljYWx9PlxuICAgICAgICAgICAgICA8RnVzaW9uQ29udGV4dC5Qcm92aWRlciB2YWx1ZT17Y3R4fT5cbiAgICAgICAgICAgICAgICA8U2VydmljZUNvbnRleHQuUHJvdmlkZXIgdmFsdWU9e2dldFNlcnZpY2V9PlxuICAgICAgICAgICAgICAgICAge2N0eC5lbGVtZW50fVxuICAgICAgICAgICAgICAgIDwvU2VydmljZUNvbnRleHQuUHJvdmlkZXI+XG4gICAgICAgICAgICAgIDwvRnVzaW9uQ29udGV4dC5Qcm92aWRlcj5cbiAgICAgICAgICAgIDwvUHJlcGFyZVByb3ZpZGVyPlxuICAgICAgICAgICk7XG4gICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgfTtcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgc3VwZXIocm9vdCwgcmVuZGVyZXIpO1xuICB9XG59XG5cbmV4cG9ydCB7XG4gIEZ1c2lvbkNvbnRleHQsXG4gIFByb3ZpZGVyUGx1Z2luLFxuICBQcm92aWRlZEhPQyxcbiAgUHJvdmlkZXIsXG4gIFNlcnZpY2VDb25zdW1lcixcbiAgU2VydmljZUNvbnRleHQsXG4gIHVzZVNlcnZpY2UsXG4gIHdpdGhTZXJ2aWNlcyxcbn07XG5cbmZ1bmN0aW9uIG5vb3AoKSB7fVxuXG5leHBvcnQgKiBmcm9tICcuL2FzeW5jL2luZGV4LmpzJztcbiJdfQ==