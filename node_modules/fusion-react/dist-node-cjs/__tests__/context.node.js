"use strict";

var React = _interopRequireWildcard(require("react"));

var _fusionCore = require("fusion-core");

var _fusionTestUtils = require("fusion-test-utils");

var _index = _interopRequireDefault(require("../index"));

var _context = require("../context.js");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */
test('context#useService', async () => {
  const TestToken = (0, _fusionCore.createToken)('test');
  const TestPlugin = (0, _fusionCore.createPlugin)({
    provides: () => 3
  });
  let didRender = false;

  function TestComponent() {
    const provides = (0, _context.useService)(TestToken);
    const ctx = React.useContext(_context.FusionContext);
    didRender = true;
    expect(provides).toBe(3);
    expect(ctx.request.url).toBe('/');
    return React.createElement('div', null, 'hello');
  }

  const element = React.createElement(TestComponent);
  const app = new _index.default(element);
  app.register(TestToken, TestPlugin);
  const sim = (0, _fusionTestUtils.getSimulator)(app);
  const ctx = await sim.render('/');
  expect(typeof ctx.body === 'string' && ctx.body.includes('hello')).toBeTruthy();
  expect(didRender).toBeTruthy();
});
test('context#useService - unregistered token', async () => {
  let didRender = false;

  function TestComponent() {
    const TestToken = (0, _fusionCore.createToken)('test');
    (0, _context.useService)(TestToken);
    didRender = true;
    return React.createElement('div', null, 'hello');
  }

  const element = React.createElement(TestComponent);
  const app = new _index.default(element);
  const sim = (0, _fusionTestUtils.getSimulator)(app);

  try {
    await sim.render('/');
  } catch (e) {
    expect(/Token .* not registered/.test(e.message)).toBeTruthy();
  }

  expect(didRender).toBeFalsy();
});
test('context#useService - optional token', async () => {
  let didRender = false;

  function TestComponent() {
    const TestToken = (0, _fusionCore.createToken)('test');
    (0, _context.useService)(TestToken.optional);
    didRender = true;
    return React.createElement('div', null, 'hello');
  }

  const element = React.createElement(TestComponent);
  const app = new _index.default(element);
  const sim = (0, _fusionTestUtils.getSimulator)(app);
  await sim.render('/');
  expect(didRender).toBeTruthy();
});
test('context#ServiceConsumer', async () => {
  const TestToken = (0, _fusionCore.createToken)('test');
  const TestPlugin = (0, _fusionCore.createPlugin)({
    provides: () => 3
  });
  let didRender = false;

  function TestComponent() {
    return React.createElement(_context.ServiceConsumer, {
      token: TestToken
    }, provides => {
      didRender = true;
      expect(provides).toBe(3);
      return React.createElement('div', null, 'hello');
    });
  }

  const element = React.createElement(TestComponent);
  const app = new _index.default(element);
  app.register(TestToken, TestPlugin);
  const sim = (0, _fusionTestUtils.getSimulator)(app);
  const ctx = await sim.render('/');
  expect(typeof ctx.body === 'string' && ctx.body.includes('hello')).toBeTruthy();
  expect(didRender).toBeTruthy();
});
test('context#withServices', async () => {
  const TestToken1 = (0, _fusionCore.createToken)('test-1');
  const TestToken2 = (0, _fusionCore.createToken)('test-2');
  const TestPlugin1 = (0, _fusionCore.createPlugin)({
    provides: () => 1
  });
  const TestPlugin2 = (0, _fusionCore.createPlugin)({
    provides: () => 2
  });
  let didRender = false;

  function TestComponent({
    mappedOne,
    mappedTwo,
    propValue
  }) {
    didRender = true;
    expect(mappedOne).toBe(1);
    expect(mappedTwo).toBe(2);
    expect(propValue).toBe(3);
    return React.createElement('div', null, 'hello');
  }

  const WrappedComponent = (0, _context.withServices)({
    test1: TestToken1,
    test2: TestToken2
  }, deps => ({
    mappedOne: deps.test1,
    mappedTwo: deps.test2
  }))(TestComponent);
  const element = React.createElement(WrappedComponent, {
    propValue: 3
  });
  const app = new _index.default(element);
  app.register(TestToken1, TestPlugin1);
  app.register(TestToken2, TestPlugin2);
  const sim = (0, _fusionTestUtils.getSimulator)(app);
  const ctx = await sim.render('/');
  expect(typeof ctx.body === 'string' && ctx.body.includes('hello')).toBeTruthy();
  expect(didRender).toBeTruthy();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbnRleHQubm9kZS5qcyJdLCJuYW1lcyI6WyJ0ZXN0IiwiVGVzdFRva2VuIiwiVGVzdFBsdWdpbiIsInByb3ZpZGVzIiwiZGlkUmVuZGVyIiwiVGVzdENvbXBvbmVudCIsImN0eCIsIlJlYWN0IiwidXNlQ29udGV4dCIsIkZ1c2lvbkNvbnRleHQiLCJleHBlY3QiLCJ0b0JlIiwicmVxdWVzdCIsInVybCIsImNyZWF0ZUVsZW1lbnQiLCJlbGVtZW50IiwiYXBwIiwiQXBwIiwicmVnaXN0ZXIiLCJzaW0iLCJyZW5kZXIiLCJib2R5IiwiaW5jbHVkZXMiLCJ0b0JlVHJ1dGh5IiwiZSIsIm1lc3NhZ2UiLCJ0b0JlRmFsc3kiLCJvcHRpb25hbCIsIlNlcnZpY2VDb25zdW1lciIsInRva2VuIiwiVGVzdFRva2VuMSIsIlRlc3RUb2tlbjIiLCJUZXN0UGx1Z2luMSIsIlRlc3RQbHVnaW4yIiwibWFwcGVkT25lIiwibWFwcGVkVHdvIiwicHJvcFZhbHVlIiwiV3JhcHBlZENvbXBvbmVudCIsInRlc3QxIiwidGVzdDIiLCJkZXBzIl0sIm1hcHBpbmdzIjoiOztBQVFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7OztBQVpBOzs7Ozs7O0FBbUJBQSxJQUFJLENBQUMsb0JBQUQsRUFBdUIsWUFBWTtBQUNyQyxRQUFNQyxTQUFTLEdBQUcsNkJBQVksTUFBWixDQUFsQjtBQUNBLFFBQU1DLFVBQVUsR0FBRyw4QkFBYTtBQUFDQyxJQUFBQSxRQUFRLEVBQUUsTUFBTTtBQUFqQixHQUFiLENBQW5CO0FBQ0EsTUFBSUMsU0FBUyxHQUFHLEtBQWhCOztBQUNBLFdBQVNDLGFBQVQsR0FBeUI7QUFDdkIsVUFBTUYsUUFBUSxHQUFHLHlCQUFXRixTQUFYLENBQWpCO0FBQ0EsVUFBTUssR0FBRyxHQUFHQyxLQUFLLENBQUNDLFVBQU4sQ0FBaUJDLHNCQUFqQixDQUFaO0FBQ0FMLElBQUFBLFNBQVMsR0FBRyxJQUFaO0FBQ0FNLElBQUFBLE1BQU0sQ0FBQ1AsUUFBRCxDQUFO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SUFBQUEsU0FBUyxFQUFFO0FBQVosR0FBdEMsQ0FBaEI7QUFDQSxRQUFNcEIsR0FBRyxHQUFHLElBQUlDLGNBQUosQ0FBUUYsT0FBUixDQUFaO0FBQ0FDLEVBQUFBLEdBQUcsQ0FBQ0UsUUFBSixDQUFhWSxVQUFiLEVBQXlCRSxXQUF6QjtBQUNBaEIsRUFBQUEsR0FBRyxDQUFDRSxRQUFKLENBQWFhLFVBQWIsRUFBeUJFLFdBQXpCO0FBQ0EsUUFBTWQsR0FBRyxHQUFHLG1DQUFhSCxHQUFiLENBQVo7QUFDQSxRQUFNVixHQUFHLEdBQUcsTUFBTWEsR0FBRyxDQUFDQyxNQUFKLENBQVcsR0FBWCxDQUFsQjtBQUNBVixFQUFBQSxNQUFNLENBQ0osT0FBT0osR0FBRyxDQUFDZSxJQUFYLEtBQW9CLFFBQXBCLElBQWdDZixHQUFHLENBQUNlLElBQUosQ0FBU0MsUUFBVCxDQUFrQixPQUFsQixDQUQ1QixDQUFOLENBRUVDLFVBRkY7QUFHQWIsRUFBQUEsTUFBTSxDQUFDTixTQUFELENBQU4sQ0FBa0JtQixVQUFsQjtBQUNELENBOUJHLENBQUoiLCJzb3VyY2VzQ29udGVudCI6WyIvKiogQ29weXJpZ2h0IChjKSAyMDE4IFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQGZsb3dcbiAqL1xuXG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQge2NyZWF0ZVRva2VuLCBjcmVhdGVQbHVnaW59IGZyb20gJ2Z1c2lvbi1jb3JlJztcbmltcG9ydCB7Z2V0U2ltdWxhdG9yfSBmcm9tICdmdXNpb24tdGVzdC11dGlscyc7XG5pbXBvcnQgQXBwIGZyb20gJy4uL2luZGV4JztcbmltcG9ydCB7XG4gIEZ1c2lvbkNvbnRleHQsXG4gIFNlcnZpY2VDb25zdW1lcixcbiAgdXNlU2VydmljZSxcbiAgd2l0aFNlcnZpY2VzLFxufSBmcm9tICcuLi9jb250ZXh0LmpzJztcblxudGVzdCgnY29udGV4dCN1c2VTZXJ2aWNlJywgYXN5bmMgKCkgPT4ge1xuICBjb25zdCBUZXN0VG9rZW4gPSBjcmVhdGVUb2tlbigndGVzdCcpO1xuICBjb25zdCBUZXN0UGx1Z2luID0gY3JlYXRlUGx1Z2luKHtwcm92aWRlczogKCkgPT4gM30pO1xuICBsZXQgZGlkUmVuZGVyID0gZmFsc2U7XG4gIGZ1bmN0aW9uIFRlc3RDb21wb25lbnQoKSB7XG4gICAgY29uc3QgcHJvdmlkZXMgPSB1c2VTZXJ2aWNlKFRlc3RUb2tlbik7XG4gICAgY29uc3QgY3R4ID0gUmVhY3QudXNlQ29udGV4dChGdXNpb25Db250ZXh0KTtcbiAgICBkaWRSZW5kZXIgPSB0cnVlO1xuICAgIGV4cGVjdChwcm92aWRlcykudG9CZSgzKTtcbiAgICBleHBlY3QoY3R4LnJlcXVlc3QudXJsKS50b0JlKCcvJyk7XG4gICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoJ2RpdicsIG51bGwsICdoZWxsbycpO1xuICB9XG4gIGNvbnN0IGVsZW1lbnQgPSBSZWFjdC5jcmVhdGVFbGVtZW50KFRlc3RDb21wb25lbnQpO1xuICBjb25zdCBhcHAgPSBuZXcgQXBwKGVsZW1lbnQpO1xuICBhcHAucmVnaXN0ZXIoVGVzdFRva2VuLCBUZXN0UGx1Z2luKTtcbiAgY29uc3Qgc2ltID0gZ2V0U2ltdWxhdG9yKGFwcCk7XG4gIGNvbnN0IGN0eCA9IGF3YWl0IHNpbS5yZW5kZXIoJy8nKTtcbiAgZXhwZWN0KFxuICAgIHR5cGVvZiBjdHguYm9keSA9PT0gJ3N0cmluZycgJiYgY3R4LmJvZHkuaW5jbHVkZXMoJ2hlbGxvJylcbiAgKS50b0JlVHJ1dGh5KCk7XG4gIGV4cGVjdChkaWRSZW5kZXIpLnRvQmVUcnV0aHkoKTtcbn0pO1xuXG50ZXN0KCdjb250ZXh0I3VzZVNlcnZpY2UgLSB1bnJlZ2lzdGVyZWQgdG9rZW4nLCBhc3luYyAoKSA9PiB7XG4gIGxldCBkaWRSZW5kZXIgPSBmYWxzZTtcbiAgZnVuY3Rpb24gVGVzdENvbXBvbmVudCgpIHtcbiAgICBjb25zdCBUZXN0VG9rZW4gPSBjcmVhdGVUb2tlbigndGVzdCcpO1xuICAgIHVzZVNlcnZpY2UoVGVzdFRva2VuKTtcbiAgICBkaWRSZW5kZXIgPSB0cnVlO1xuICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KCdkaXYnLCBudWxsLCAnaGVsbG8nKTtcbiAgfVxuICBjb25zdCBlbGVtZW50ID0gUmVhY3QuY3JlYXRlRWxlbWVudChUZXN0Q29tcG9uZW50KTtcbiAgY29uc3QgYXBwID0gbmV3IEFwcChlbGVtZW50KTtcbiAgY29uc3Qgc2ltID0gZ2V0U2ltdWxhdG9yKGFwcCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgc2ltLnJlbmRlcignLycpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgZXhwZWN0KC9Ub2tlbiAuKiBub3QgcmVnaXN0ZXJlZC8udGVzdChlLm1lc3NhZ2UpKS50b0JlVHJ1dGh5KCk7XG4gIH1cbiAgZXhwZWN0KGRpZFJlbmRlcikudG9CZUZhbHN5KCk7XG59KTtcblxudGVzdCgnY29udGV4dCN1c2VTZXJ2aWNlIC0gb3B0aW9uYWwgdG9rZW4nLCBhc3luYyAoKSA9PiB7XG4gIGxldCBkaWRSZW5kZXIgPSBmYWxzZTtcbiAgZnVuY3Rpb24gVGVzdENvbXBvbmVudCgpIHtcbiAgICBjb25zdCBUZXN0VG9rZW4gPSBjcmVhdGVUb2tlbigndGVzdCcpO1xuICAgIHVzZVNlcnZpY2UoVGVzdFRva2VuLm9wdGlvbmFsKTtcbiAgICBkaWRSZW5kZXIgPSB0cnVlO1xuICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KCdkaXYnLCBudWxsLCAnaGVsbG8nKTtcbiAgfVxuICBjb25zdCBlbGVtZW50ID0gUmVhY3QuY3JlYXRlRWxlbWVudChUZXN0Q29tcG9uZW50KTtcbiAgY29uc3QgYXBwID0gbmV3IEFwcChlbGVtZW50KTtcbiAgY29uc3Qgc2ltID0gZ2V0U2ltdWxhdG9yKGFwcCk7XG4gIGF3YWl0IHNpbS5yZW5kZXIoJy8nKTtcbiAgZXhwZWN0KGRpZFJlbmRlcikudG9CZVRydXRoeSgpO1xufSk7XG5cbnRlc3QoJ2NvbnRleHQjU2VydmljZUNvbnN1bWVyJywgYXN5bmMgKCkgPT4ge1xuICBjb25zdCBUZXN0VG9rZW4gPSBjcmVhdGVUb2tlbigndGVzdCcpO1xuICBjb25zdCBUZXN0UGx1Z2luID0gY3JlYXRlUGx1Z2luKHtwcm92aWRlczogKCkgPT4gM30pO1xuICBsZXQgZGlkUmVuZGVyID0gZmFsc2U7XG4gIGZ1bmN0aW9uIFRlc3RDb21wb25lbnQoKSB7XG4gICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoXG4gICAgICBTZXJ2aWNlQ29uc3VtZXIsXG4gICAgICB7dG9rZW46IFRlc3RUb2tlbn0sXG4gICAgICBwcm92aWRlcyA9PiB7XG4gICAgICAgIGRpZFJlbmRlciA9IHRydWU7XG4gICAgICAgIGV4cGVjdChwcm92aWRlcykudG9CZSgzKTtcbiAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoJ2RpdicsIG51bGwsICdoZWxsbycpO1xuICAgICAgfVxuICAgICk7XG4gIH1cbiAgY29uc3QgZWxlbWVudCA9IFJlYWN0LmNyZWF0ZUVsZW1lbnQoVGVzdENvbXBvbmVudCk7XG4gIGNvbnN0IGFwcCA9IG5ldyBBcHAoZWxlbWVudCk7XG4gIGFwcC5yZWdpc3RlcihUZXN0VG9rZW4sIFRlc3RQbHVnaW4pO1xuICBjb25zdCBzaW0gPSBnZXRTaW11bGF0b3IoYXBwKTtcbiAgY29uc3QgY3R4ID0gYXdhaXQgc2ltLnJlbmRlcignLycpO1xuICBleHBlY3QoXG4gICAgdHlwZW9mIGN0eC5ib2R5ID09PSAnc3RyaW5nJyAmJiBjdHguYm9keS5pbmNsdWRlcygnaGVsbG8nKVxuICApLnRvQmVUcnV0aHkoKTtcbiAgZXhwZWN0KGRpZFJlbmRlcikudG9CZVRydXRoeSgpO1xufSk7XG5cbnRlc3QoJ2NvbnRleHQjd2l0aFNlcnZpY2VzJywgYXN5bmMgKCkgPT4ge1xuICBjb25zdCBUZXN0VG9rZW4xID0gY3JlYXRlVG9rZW4oJ3Rlc3QtMScpO1xuICBjb25zdCBUZXN0VG9rZW4yID0gY3JlYXRlVG9rZW4oJ3Rlc3QtMicpO1xuICBjb25zdCBUZXN0UGx1Z2luMSA9IGNyZWF0ZVBsdWdpbih7cHJvdmlkZXM6ICgpID0+IDF9KTtcbiAgY29uc3QgVGVzdFBsdWdpbjIgPSBjcmVhdGVQbHVnaW4oe3Byb3ZpZGVzOiAoKSA9PiAyfSk7XG4gIGxldCBkaWRSZW5kZXIgPSBmYWxzZTtcbiAgZnVuY3Rpb24gVGVzdENvbXBvbmVudCh7bWFwcGVkT25lLCBtYXBwZWRUd28sIHByb3BWYWx1ZX0pIHtcbiAgICBkaWRSZW5kZXIgPSB0cnVlO1xuICAgIGV4cGVjdChtYXBwZWRPbmUpLnRvQmUoMSk7XG4gICAgZXhwZWN0KG1hcHBlZFR3bykudG9CZSgyKTtcbiAgICBleHBlY3QocHJvcFZhbHVlKS50b0JlKDMpO1xuICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KCdkaXYnLCBudWxsLCAnaGVsbG8nKTtcbiAgfVxuICBjb25zdCBXcmFwcGVkQ29tcG9uZW50ID0gd2l0aFNlcnZpY2VzKFxuICAgIHtcbiAgICAgIHRlc3QxOiBUZXN0VG9rZW4xLFxuICAgICAgdGVzdDI6IFRlc3RUb2tlbjIsXG4gICAgfSxcbiAgICBkZXBzID0+ICh7bWFwcGVkT25lOiBkZXBzLnRlc3QxLCBtYXBwZWRUd286IGRlcHMudGVzdDJ9KVxuICApKFRlc3RDb21wb25lbnQpO1xuICBjb25zdCBlbGVtZW50ID0gUmVhY3QuY3JlYXRlRWxlbWVudChXcmFwcGVkQ29tcG9uZW50LCB7cHJvcFZhbHVlOiAzfSk7XG4gIGNvbnN0IGFwcCA9IG5ldyBBcHAoZWxlbWVudCk7XG4gIGFwcC5yZWdpc3RlcihUZXN0VG9rZW4xLCBUZXN0UGx1Z2luMSk7XG4gIGFwcC5yZWdpc3RlcihUZXN0VG9rZW4yLCBUZXN0UGx1Z2luMik7XG4gIGNvbnN0IHNpbSA9IGdldFNpbXVsYXRvcihhcHApO1xuICBjb25zdCBjdHggPSBhd2FpdCBzaW0ucmVuZGVyKCcvJyk7XG4gIGV4cGVjdChcbiAgICB0eXBlb2YgY3R4LmJvZHkgPT09ICdzdHJpbmcnICYmIGN0eC5ib2R5LmluY2x1ZGVzKCdoZWxsbycpXG4gICkudG9CZVRydXRoeSgpO1xuICBleHBlY3QoZGlkUmVuZGVyKS50b0JlVHJ1dGh5KCk7XG59KTtcbiJdfQ==