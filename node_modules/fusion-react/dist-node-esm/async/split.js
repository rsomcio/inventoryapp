/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */
import * as React from 'react';
import PropTypes from 'prop-types';
import prepared from './prepared.js';
const contextTypes = {
  splitComponentLoaders: PropTypes.array.isRequired
};

if (true) {
  // $FlowFixMe
  contextTypes.markAsCritical = PropTypes.func;
}

export default function withAsyncComponent({
  defer,
  load,
  LoadingComponent,
  ErrorComponent
}) {
  let AsyncComponent = null;
  let error = null;
  const metadata = {
    chunkIds: [],
    i18nKeys: []
  };

  function WithAsyncComponent(props) {
    if (false) {
      let promise = load(); // $FlowFixMe

      let id = promise.__MODULE_ID;

      if (typeof __webpack_modules__ !== 'undefined' && __webpack_modules__[id]) {
        // If module is already loaded, it can be synchronously imported
        AsyncComponent = __webpack_require__(id).default;
      }
    }

    if (error) {
      return React.createElement(ErrorComponent, {
        error: error
      });
    }

    if (!AsyncComponent) {
      return React.createElement(LoadingComponent, null);
    }

    return React.createElement(AsyncComponent, props);
  }

  return prepared((props, context) => {
    if (AsyncComponent) {
      if (true && context.markAsCritical) {
        metadata.chunkIds.forEach(chunkId => {
          context.markAsCritical(chunkId);
        });
      }

      return Promise.resolve(AsyncComponent);
    }

    let componentPromise;

    try {
      componentPromise = load();
    } catch (e) {
      componentPromise = Promise.reject(e);
    } // $FlowFixMe


    metadata.chunkIds = componentPromise.__CHUNK_IDS || []; // $FlowFixMe

    metadata.i18nKeys = componentPromise.__I18N_KEYS || [];

    if (true && context.markAsCritical) {
      metadata.chunkIds.forEach(chunkId => {
        context.markAsCritical(chunkId);
      });
    }

    const loadPromises = [componentPromise, ...context.splitComponentLoaders.map(loader => loader(metadata.chunkIds, metadata))];
    return Promise.all(loadPromises).then(([asyncComponent]) => {
      // Note: .default is toolchain specific, breaks w/ CommonJS exports
      AsyncComponent = asyncComponent.default;

      if (AsyncComponent === undefined) {
        throw new Error('Bundle does not contain a default export');
      }
    }).catch(err => {
      error = err;
      if (false) setTimeout(() => {
        throw err;
      }); // log error
    });
  }, {
    defer,
    contextTypes,
    forceUpdate: true
  })(WithAsyncComponent);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNwbGl0LmpzIl0sIm5hbWVzIjpbIlJlYWN0IiwiUHJvcFR5cGVzIiwicHJlcGFyZWQiLCJjb250ZXh0VHlwZXMiLCJzcGxpdENvbXBvbmVudExvYWRlcnMiLCJhcnJheSIsImlzUmVxdWlyZWQiLCJtYXJrQXNDcml0aWNhbCIsImZ1bmMiLCJ3aXRoQXN5bmNDb21wb25lbnQiLCJkZWZlciIsImxvYWQiLCJMb2FkaW5nQ29tcG9uZW50IiwiRXJyb3JDb21wb25lbnQiLCJBc3luY0NvbXBvbmVudCIsImVycm9yIiwibWV0YWRhdGEiLCJjaHVua0lkcyIsImkxOG5LZXlzIiwiV2l0aEFzeW5jQ29tcG9uZW50IiwicHJvcHMiLCJwcm9taXNlIiwiaWQiLCJfX01PRFVMRV9JRCIsIl9fd2VicGFja19tb2R1bGVzX18iLCJfX3dlYnBhY2tfcmVxdWlyZV9fIiwiZGVmYXVsdCIsImNvbnRleHQiLCJmb3JFYWNoIiwiY2h1bmtJZCIsIlByb21pc2UiLCJyZXNvbHZlIiwiY29tcG9uZW50UHJvbWlzZSIsImUiLCJyZWplY3QiLCJfX0NIVU5LX0lEUyIsIl9fSTE4Tl9LRVlTIiwibG9hZFByb21pc2VzIiwibWFwIiwibG9hZGVyIiwiYWxsIiwidGhlbiIsImFzeW5jQ29tcG9uZW50IiwidW5kZWZpbmVkIiwiRXJyb3IiLCJjYXRjaCIsImVyciIsInNldFRpbWVvdXQiLCJmb3JjZVVwZGF0ZSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7QUFRQSxPQUFPLEtBQUtBLEtBQVosTUFBdUIsT0FBdkI7QUFDQSxPQUFPQyxTQUFQLE1BQXNCLFlBQXRCO0FBQ0EsT0FBT0MsUUFBUCxNQUFxQixlQUFyQjtBQUtBLE1BQU1DLFlBQVksR0FBRztBQUNuQkMsRUFBQUEscUJBQXFCLEVBQUVILFNBQVMsQ0FBQ0ksS0FBVixDQUFnQkM7QUFEcEIsQ0FBckI7O0FBSUEsVUFBYztBQUNaO0FBQ0FILEVBQUFBLFlBQVksQ0FBQ0ksY0FBYixHQUE4Qk4sU0FBUyxDQUFDTyxJQUF4QztBQUNE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U0FBdkIsRUFBa0M7QUFDaEMsY0FBTSxJQUFJQyxLQUFKLENBQVUsMENBQVYsQ0FBTjtBQUNEO0FBQ0YsS0FQSSxFQVFKQyxLQVJJLENBUUVDLEdBQUcsSUFBSTtBQUNaL0IsTUFBQUEsS0FBSyxHQUFHK0IsR0FBUjtBQUNBLGlCQUNFQyxVQUFVLENBQUMsTUFBTTtBQUNmLGNBQU1ELEdBQU47QUFDRCxPQUZTLENBQVYsQ0FIVSxDQUtOO0FBQ1AsS0FkSSxDQUFQO0FBZUQsR0FuRFksRUFvRGI7QUFBQ3BDLElBQUFBLEtBQUQ7QUFBUVAsSUFBQUEsWUFBUjtBQUFzQjZDLElBQUFBLFdBQVcsRUFBRTtBQUFuQyxHQXBEYSxDQUFSLENBcURMN0Isa0JBckRLLENBQVA7QUFzREQiLCJzb3VyY2VzQ29udGVudCI6WyIvKiogQ29weXJpZ2h0IChjKSAyMDE4IFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQGZsb3dcbiAqL1xuXG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IHByZXBhcmVkIGZyb20gJy4vcHJlcGFyZWQuanMnO1xuXG5kZWNsYXJlIHZhciBfX3dlYnBhY2tfbW9kdWxlc19fOiB7W3N0cmluZ106IGFueX07XG5kZWNsYXJlIHZhciBfX3dlYnBhY2tfcmVxdWlyZV9fOiBhbnkgPT4gYW55O1xuXG5jb25zdCBjb250ZXh0VHlwZXMgPSB7XG4gIHNwbGl0Q29tcG9uZW50TG9hZGVyczogUHJvcFR5cGVzLmFycmF5LmlzUmVxdWlyZWQsXG59O1xuXG5pZiAoX19OT0RFX18pIHtcbiAgLy8gJEZsb3dGaXhNZVxuICBjb250ZXh0VHlwZXMubWFya0FzQ3JpdGljYWwgPSBQcm9wVHlwZXMuZnVuYztcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gd2l0aEFzeW5jQ29tcG9uZW50PENvbmZpZz4oe1xuICBkZWZlcixcbiAgbG9hZCxcbiAgTG9hZGluZ0NvbXBvbmVudCxcbiAgRXJyb3JDb21wb25lbnQsXG59OiB7XG4gIGRlZmVyPzogYm9vbGVhbixcbiAgbG9hZDogKCkgPT4gUHJvbWlzZTx7ZGVmYXVsdDogUmVhY3QuQ29tcG9uZW50VHlwZTxDb25maWc+fT4sXG4gIExvYWRpbmdDb21wb25lbnQ6IFJlYWN0LkNvbXBvbmVudFR5cGU8YW55PixcbiAgRXJyb3JDb21wb25lbnQ6IFJlYWN0LkNvbXBvbmVudFR5cGU8YW55Pixcbn0pOiBSZWFjdC5Db21wb25lbnRUeXBlPENvbmZpZz4ge1xuICBsZXQgQXN5bmNDb21wb25lbnQgPSBudWxsO1xuICBsZXQgZXJyb3IgPSBudWxsO1xuICBjb25zdCBtZXRhZGF0YSA9IHtcbiAgICBjaHVua0lkczogW10sXG4gICAgaTE4bktleXM6IFtdLFxuICB9O1xuXG4gIGZ1bmN0aW9uIFdpdGhBc3luY0NvbXBvbmVudChwcm9wcykge1xuICAgIGlmIChfX0JST1dTRVJfXykge1xuICAgICAgbGV0IHByb21pc2UgPSBsb2FkKCk7XG4gICAgICAvLyAkRmxvd0ZpeE1lXG4gICAgICBsZXQgaWQgPSBwcm9taXNlLl9fTU9EVUxFX0lEO1xuXG4gICAgICBpZiAoXG4gICAgICAgIHR5cGVvZiBfX3dlYnBhY2tfbW9kdWxlc19fICE9PSAndW5kZWZpbmVkJyAmJlxuICAgICAgICBfX3dlYnBhY2tfbW9kdWxlc19fW2lkXVxuICAgICAgKSB7XG4gICAgICAgIC8vIElmIG1vZHVsZSBpcyBhbHJlYWR5IGxvYWRlZCwgaXQgY2FuIGJlIHN5bmNocm9ub3VzbHkgaW1wb3J0ZWRcbiAgICAgICAgQXN5bmNDb21wb25lbnQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKGlkKS5kZWZhdWx0O1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChlcnJvcikge1xuICAgICAgcmV0dXJuIDxFcnJvckNvbXBvbmVudCBlcnJvcj17ZXJyb3J9IC8+O1xuICAgIH1cbiAgICBpZiAoIUFzeW5jQ29tcG9uZW50KSB7XG4gICAgICByZXR1cm4gPExvYWRpbmdDb21wb25lbnQgLz47XG4gICAgfVxuICAgIHJldHVybiA8QXN5bmNDb21wb25lbnQgey4uLnByb3BzfSAvPjtcbiAgfVxuXG4gIHJldHVybiBwcmVwYXJlZChcbiAgICAocHJvcHMsIGNvbnRleHQpID0+IHtcbiAgICAgIGlmIChBc3luY0NvbXBvbmVudCkge1xuICAgICAgICBpZiAoX19OT0RFX18gJiYgY29udGV4dC5tYXJrQXNDcml0aWNhbCkge1xuICAgICAgICAgIG1ldGFkYXRhLmNodW5rSWRzLmZvckVhY2goY2h1bmtJZCA9PiB7XG4gICAgICAgICAgICBjb250ZXh0Lm1hcmtBc0NyaXRpY2FsKGNodW5rSWQpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoQXN5bmNDb21wb25lbnQpO1xuICAgICAgfVxuXG4gICAgICBsZXQgY29tcG9uZW50UHJvbWlzZTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbXBvbmVudFByb21pc2UgPSBsb2FkKCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbXBvbmVudFByb21pc2UgPSAoUHJvbWlzZS5yZWplY3QoZSk6IGFueSk7XG4gICAgICB9XG5cbiAgICAgIC8vICRGbG93Rml4TWVcbiAgICAgIG1ldGFkYXRhLmNodW5rSWRzID0gY29tcG9uZW50UHJvbWlzZS5fX0NIVU5LX0lEUyB8fCBbXTtcbiAgICAgIC8vICRGbG93Rml4TWVcbiAgICAgIG1ldGFkYXRhLmkxOG5LZXlzID0gY29tcG9uZW50UHJvbWlzZS5fX0kxOE5fS0VZUyB8fCBbXTtcblxuICAgICAgaWYgKF9fTk9ERV9fICYmIGNvbnRleHQubWFya0FzQ3JpdGljYWwpIHtcbiAgICAgICAgbWV0YWRhdGEuY2h1bmtJZHMuZm9yRWFjaChjaHVua0lkID0+IHtcbiAgICAgICAgICBjb250ZXh0Lm1hcmtBc0NyaXRpY2FsKGNodW5rSWQpO1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgbG9hZFByb21pc2VzID0gW1xuICAgICAgICBjb21wb25lbnRQcm9taXNlLFxuICAgICAgICAuLi5jb250ZXh0LnNwbGl0Q29tcG9uZW50TG9hZGVycy5tYXAobG9hZGVyID0+XG4gICAgICAgICAgbG9hZGVyKG1ldGFkYXRhLmNodW5rSWRzLCBtZXRhZGF0YSlcbiAgICAgICAgKSxcbiAgICAgIF07XG5cbiAgICAgIHJldHVybiBQcm9taXNlLmFsbChsb2FkUHJvbWlzZXMpXG4gICAgICAgIC50aGVuKChbYXN5bmNDb21wb25lbnRdKSA9PiB7XG4gICAgICAgICAgLy8gTm90ZTogLmRlZmF1bHQgaXMgdG9vbGNoYWluIHNwZWNpZmljLCBicmVha3Mgdy8gQ29tbW9uSlMgZXhwb3J0c1xuICAgICAgICAgIEFzeW5jQ29tcG9uZW50ID0gYXN5bmNDb21wb25lbnQuZGVmYXVsdDtcbiAgICAgICAgICBpZiAoQXN5bmNDb21wb25lbnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCdW5kbGUgZG9lcyBub3QgY29udGFpbiBhIGRlZmF1bHQgZXhwb3J0Jyk7XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICBlcnJvciA9IGVycjtcbiAgICAgICAgICBpZiAoX19CUk9XU0VSX18pXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgICAgfSk7IC8vIGxvZyBlcnJvclxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIHtkZWZlciwgY29udGV4dFR5cGVzLCBmb3JjZVVwZGF0ZTogdHJ1ZX1cbiAgKShXaXRoQXN5bmNDb21wb25lbnQpO1xufVxuIl19