/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */
import * as React from 'react';
import { createToken, createPlugin } from 'fusion-core';
import { getSimulator } from 'fusion-test-utils';
import PropTypes from 'prop-types';
import App from '../index';
import hoc from '../hoc';
import plugin from '../plugin';
import compose from 'just-compose';
test('hoc#legacy', async () => {
  const withTest = hoc.create('test');
  const testProvides = {
    hello: 'world'
  };
  let didRender = false;

  function TestComponent(props) {
    didRender = true;
    expect(props.test).toStrictEqual(testProvides);
    expect(props.ctx).toBeFalsy();
    return React.createElement('div', null, 'hello');
  }

  const testPlugin = plugin.create('test', createPlugin({
    provides: () => testProvides
  }));
  const element = React.createElement(withTest(TestComponent));
  const app = new App(element);
  app.register(testPlugin);
  const sim = getSimulator(app);
  const ctx = await sim.render('/');
  expect(typeof ctx.body === 'string' && ctx.body.includes('hello')).toBeTruthy();
  expect(didRender).toBeTruthy();
});
test('hoc#legacy with mapProvidesToProps', async () => {
  const withTest = hoc.create('test', provides => {
    return {
      mapped: provides
    };
  });
  const testProvides = {
    hello: 'world'
  };
  let didRender = false;

  function TestComponent(props) {
    didRender = true;
    expect(props.mapped).toStrictEqual(testProvides);
    return React.createElement('div', null, 'hello');
  }

  const testPlugin = plugin.create('test', createPlugin({
    provides: () => testProvides
  }));
  const element = React.createElement(withTest(TestComponent));
  const app = new App(element);
  app.register(testPlugin);
  const sim = getSimulator(app);
  const ctx = await sim.render('/');
  expect(typeof ctx.body === 'string' && ctx.body.includes('hello')).toBeTruthy();
  expect(didRender).toBeTruthy();
});
test('hoc#legacy with custom provider', async () => {
  const withTest = hoc.create('test');
  const testProvides = {
    hello: 'world'
  };
  let didRender = false;
  let didUseCustomProvider = false;

  function TestComponent(props) {
    didRender = true;
    expect(props.test).toStrictEqual(testProvides);
    return React.createElement('div', null, 'hello');
  }

  class CustomProvider extends React.Component {
    getChildContext() {
      return {
        test: this.props.provides
      };
    }

    render() {
      didUseCustomProvider = true;
      expect(this.props.ctx).toBeTruthy();
      return React.Children.only(this.props.children);
    }

  }

  CustomProvider.childContextTypes = {
    test: PropTypes.any.isRequired
  };
  const testPlugin = plugin.create('test', createPlugin({
    provides: () => testProvides
  }), CustomProvider);
  const element = React.createElement(withTest(TestComponent));
  const app = new App(element);
  app.register(testPlugin);
  const sim = getSimulator(app);
  const ctx = await sim.render('/');
  expect(typeof ctx.body === 'string' && ctx.body.includes('hello')).toBeTruthy();
  expect(didRender).toBeTruthy();
  expect(didUseCustomProvider).toBeTruthy();
});
test('hoc', async () => {
  const TestToken1 = createToken('test-token-1');
  const TestToken2 = createToken('test-token-2');
  const TestToken3 = createToken('test-token-3');
  const withTest = compose(hoc.create('test1', undefined, TestToken1), hoc.create('test2', undefined, TestToken2), hoc.create('test3', provides => ({
    mapped: provides
  }), TestToken3));
  const testProvides1 = {
    hello: 1
  };
  const testProvides2 = {
    hello: 2
  };
  const testProvides3 = {
    hello: 3
  };
  let didRender = false;

  function TestComponent(props) {
    didRender = true;
    expect(props.test1).toStrictEqual(testProvides1);
    expect(props.test2).toStrictEqual(testProvides2);
    expect(props.mapped).toStrictEqual(testProvides3);
    expect(props.ctx).toBeFalsy();
    return React.createElement('div', null, 'hello');
  }

  const testPlugin1 = createPlugin({
    provides: () => testProvides1
  });
  const testPlugin2 = plugin.create('test2', createPlugin({
    provides: () => testProvides2
  }));
  const testPlugin3 = createPlugin({
    provides: () => testProvides3
  });
  const element = React.createElement(withTest(TestComponent));
  const app = new App(element);
  app.register(TestToken1, testPlugin1);
  app.register(TestToken2, testPlugin2);
  app.register(TestToken3, testPlugin3);
  const sim = getSimulator(app);
  const ctx = await sim.render('/');
  expect(typeof ctx.body === 'string' && ctx.body.includes('hello')).toBeTruthy();
  expect(didRender).toBeTruthy();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhvYy5ub2RlLmpzIl0sIm5hbWVzIjpbIlJlYWN0IiwiY3JlYXRlVG9rZW4iLCJjcmVhdGVQbHVnaW4iLCJnZXRTaW11bGF0b3IiLCJQcm9wVHlwZXMiLCJBcHAiLCJob2MiLCJwbHVnaW4iLCJjb21wb3NlIiwidGVzdCIsIndpdGhUZXN0IiwiY3JlYXRlIiwidGVzdFByb3ZpZGVzIiwiaGVsbG8iLCJkaWRSZW5kZXIiLCJUZXN0Q29tcG9uZW50IiwicHJvcHMiLCJleHBlY3QiLCJ0b1N0cmljdEVxdWFsIiwiY3R4IiwidG9CZUZhbHN5IiwiY3JlYXRlRWxlbWVudCIsInRlc3RQbHVnaW4iLCJwcm92aWRlcyIsImVsZW1lbnQiLCJhcHAiLCJyZWdpc3RlciIsInNpbSIsInJlbmRlciIsImJvZHkiLCJpbmNsdWRlcyIsInRvQmVUcnV0aHkiLCJtYXBwZWQiLCJkaWRVc2VDdXN0b21Qcm92aWRlciIsIkN1c3RvbVByb3ZpZGVyIiwiQ29tcG9uZW50IiwiZ2V0Q2hpbGRDb250ZXh0IiwiQ2hpbGRyZW4iLCJvbmx5IiwiY2hpbGRyZW4iLCJjaGlsZENvbnRleHRUeXBlcyIsImFueSIsImlzUmVxdWlyZWQiLCJUZXN0VG9rZW4xIiwiVGVzdFRva2VuMiIsIlRlc3RUb2tlbjMiLCJ1bmRlZmluZWQiLCJ0ZXN0UHJvdmlkZXMxIiwidGVzdFByb3ZpZGVzMiIsInRlc3RQcm92aWRlczMiLCJ0ZXN0MSIsInRlc3QyIiwidGVzdFBsdWdpbjEiLCJ0ZXN0UGx1Z2luMiIsInRlc3RQbHVnaW4zIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQVFBLE9BQU8sS0FBS0EsS0FBWixNQUF1QixPQUF2QjtBQUNBLFNBQVFDLFdBQVIsRUFBcUJDLFlBQXJCLFFBQXdDLGFBQXhDO0FBQ0EsU0FBUUMsWUFBUixRQUEyQixtQkFBM0I7QUFDQSxPQUFPQyxTQUFQLE1BQXNCLFlBQXRCO0FBQ0EsT0FBT0MsR0FBUCxNQUFnQixVQUFoQjtBQUNBLE9BQU9DLEdBQVAsTUFBZ0IsUUFBaEI7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QWtCLE9BQWxCLENBRDVCLENBQU4sQ0FFRUMsVUFGRjtBQUdBZCxFQUFBQSxNQUFNLENBQUNILFNBQUQsQ0FBTixDQUFrQmlCLFVBQWxCO0FBQ0QsQ0F0Q0csQ0FBSiIsInNvdXJjZXNDb250ZW50IjpbIi8qKiBDb3B5cmlnaHQgKGMpIDIwMTggVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZmxvd1xuICovXG5cbmltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7Y3JlYXRlVG9rZW4sIGNyZWF0ZVBsdWdpbn0gZnJvbSAnZnVzaW9uLWNvcmUnO1xuaW1wb3J0IHtnZXRTaW11bGF0b3J9IGZyb20gJ2Z1c2lvbi10ZXN0LXV0aWxzJztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQgQXBwIGZyb20gJy4uL2luZGV4JztcbmltcG9ydCBob2MgZnJvbSAnLi4vaG9jJztcbmltcG9ydCBwbHVnaW4gZnJvbSAnLi4vcGx1Z2luJztcbmltcG9ydCBjb21wb3NlIGZyb20gJ2p1c3QtY29tcG9zZSc7XG5cbnRlc3QoJ2hvYyNsZWdhY3knLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IHdpdGhUZXN0ID0gaG9jLmNyZWF0ZSgndGVzdCcpO1xuICBjb25zdCB0ZXN0UHJvdmlkZXMgPSB7aGVsbG86ICd3b3JsZCd9O1xuICBsZXQgZGlkUmVuZGVyID0gZmFsc2U7XG4gIGZ1bmN0aW9uIFRlc3RDb21wb25lbnQocHJvcHMpIHtcbiAgICBkaWRSZW5kZXIgPSB0cnVlO1xuICAgIGV4cGVjdChwcm9wcy50ZXN0KS50b1N0cmljdEVxdWFsKHRlc3RQcm92aWRlcyk7XG4gICAgZXhwZWN0KHByb3BzLmN0eCkudG9CZUZhbHN5KCk7XG4gICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoJ2RpdicsIG51bGwsICdoZWxsbycpO1xuICB9XG4gIGNvbnN0IHRlc3RQbHVnaW4gPSBwbHVnaW4uY3JlYXRlKFxuICAgICd0ZXN0JyxcbiAgICBjcmVhdGVQbHVnaW4oe3Byb3ZpZGVzOiAoKSA9PiB0ZXN0UHJvdmlkZXN9KVxuICApO1xuICBjb25zdCBlbGVtZW50ID0gUmVhY3QuY3JlYXRlRWxlbWVudCh3aXRoVGVzdChUZXN0Q29tcG9uZW50KSk7XG4gIGNvbnN0IGFwcCA9IG5ldyBBcHAoZWxlbWVudCk7XG4gIGFwcC5yZWdpc3Rlcih0ZXN0UGx1Z2luKTtcbiAgY29uc3Qgc2ltID0gZ2V0U2ltdWxhdG9yKGFwcCk7XG4gIGNvbnN0IGN0eCA9IGF3YWl0IHNpbS5yZW5kZXIoJy8nKTtcbiAgZXhwZWN0KFxuICAgIHR5cGVvZiBjdHguYm9keSA9PT0gJ3N0cmluZycgJiYgY3R4LmJvZHkuaW5jbHVkZXMoJ2hlbGxvJylcbiAgKS50b0JlVHJ1dGh5KCk7XG4gIGV4cGVjdChkaWRSZW5kZXIpLnRvQmVUcnV0aHkoKTtcbn0pO1xuXG50ZXN0KCdob2MjbGVnYWN5IHdpdGggbWFwUHJvdmlkZXNUb1Byb3BzJywgYXN5bmMgKCkgPT4ge1xuICBjb25zdCB3aXRoVGVzdCA9IGhvYy5jcmVhdGUoJ3Rlc3QnLCBwcm92aWRlcyA9PiB7XG4gICAgcmV0dXJuIHttYXBwZWQ6IHByb3ZpZGVzfTtcbiAgfSk7XG5cbiAgY29uc3QgdGVzdFByb3ZpZGVzID0ge2hlbGxvOiAnd29ybGQnfTtcbiAgbGV0IGRpZFJlbmRlciA9IGZhbHNlO1xuICBmdW5jdGlvbiBUZXN0Q29tcG9uZW50KHByb3BzKSB7XG4gICAgZGlkUmVuZGVyID0gdHJ1ZTtcbiAgICBleHBlY3QocHJvcHMubWFwcGVkKS50b1N0cmljdEVxdWFsKHRlc3RQcm92aWRlcyk7XG4gICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoJ2RpdicsIG51bGwsICdoZWxsbycpO1xuICB9XG5cbiAgY29uc3QgdGVzdFBsdWdpbiA9IHBsdWdpbi5jcmVhdGUoXG4gICAgJ3Rlc3QnLFxuICAgIGNyZWF0ZVBsdWdpbih7cHJvdmlkZXM6ICgpID0+IHRlc3RQcm92aWRlc30pXG4gICk7XG4gIGNvbnN0IGVsZW1lbnQgPSBSZWFjdC5jcmVhdGVFbGVtZW50KHdpdGhUZXN0KFRlc3RDb21wb25lbnQpKTtcbiAgY29uc3QgYXBwID0gbmV3IEFwcChlbGVtZW50KTtcbiAgYXBwLnJlZ2lzdGVyKHRlc3RQbHVnaW4pO1xuICBjb25zdCBzaW0gPSBnZXRTaW11bGF0b3IoYXBwKTtcbiAgY29uc3QgY3R4ID0gYXdhaXQgc2ltLnJlbmRlcignLycpO1xuICBleHBlY3QoXG4gICAgdHlwZW9mIGN0eC5ib2R5ID09PSAnc3RyaW5nJyAmJiBjdHguYm9keS5pbmNsdWRlcygnaGVsbG8nKVxuICApLnRvQmVUcnV0aHkoKTtcbiAgZXhwZWN0KGRpZFJlbmRlcikudG9CZVRydXRoeSgpO1xufSk7XG5cbnRlc3QoJ2hvYyNsZWdhY3kgd2l0aCBjdXN0b20gcHJvdmlkZXInLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IHdpdGhUZXN0ID0gaG9jLmNyZWF0ZSgndGVzdCcpO1xuXG4gIGNvbnN0IHRlc3RQcm92aWRlcyA9IHtoZWxsbzogJ3dvcmxkJ307XG4gIGxldCBkaWRSZW5kZXIgPSBmYWxzZTtcbiAgbGV0IGRpZFVzZUN1c3RvbVByb3ZpZGVyID0gZmFsc2U7XG4gIGZ1bmN0aW9uIFRlc3RDb21wb25lbnQocHJvcHMpIHtcbiAgICBkaWRSZW5kZXIgPSB0cnVlO1xuICAgIGV4cGVjdChwcm9wcy50ZXN0KS50b1N0cmljdEVxdWFsKHRlc3RQcm92aWRlcyk7XG4gICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoJ2RpdicsIG51bGwsICdoZWxsbycpO1xuICB9XG4gIGNsYXNzIEN1c3RvbVByb3ZpZGVyIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PCo+IHtcbiAgICBnZXRDaGlsZENvbnRleHQoKSB7XG4gICAgICByZXR1cm4ge3Rlc3Q6IHRoaXMucHJvcHMucHJvdmlkZXN9O1xuICAgIH1cbiAgICByZW5kZXIoKSB7XG4gICAgICBkaWRVc2VDdXN0b21Qcm92aWRlciA9IHRydWU7XG4gICAgICBleHBlY3QodGhpcy5wcm9wcy5jdHgpLnRvQmVUcnV0aHkoKTtcbiAgICAgIHJldHVybiBSZWFjdC5DaGlsZHJlbi5vbmx5KHRoaXMucHJvcHMuY2hpbGRyZW4pO1xuICAgIH1cbiAgfVxuICBDdXN0b21Qcm92aWRlci5jaGlsZENvbnRleHRUeXBlcyA9IHtcbiAgICB0ZXN0OiBQcm9wVHlwZXMuYW55LmlzUmVxdWlyZWQsXG4gIH07XG5cbiAgY29uc3QgdGVzdFBsdWdpbiA9IHBsdWdpbi5jcmVhdGUoXG4gICAgJ3Rlc3QnLFxuICAgIGNyZWF0ZVBsdWdpbih7cHJvdmlkZXM6ICgpID0+IHRlc3RQcm92aWRlc30pLFxuICAgIEN1c3RvbVByb3ZpZGVyXG4gICk7XG4gIGNvbnN0IGVsZW1lbnQgPSBSZWFjdC5jcmVhdGVFbGVtZW50KHdpdGhUZXN0KFRlc3RDb21wb25lbnQpKTtcbiAgY29uc3QgYXBwID0gbmV3IEFwcChlbGVtZW50KTtcbiAgYXBwLnJlZ2lzdGVyKHRlc3RQbHVnaW4pO1xuICBjb25zdCBzaW0gPSBnZXRTaW11bGF0b3IoYXBwKTtcbiAgY29uc3QgY3R4ID0gYXdhaXQgc2ltLnJlbmRlcignLycpO1xuICBleHBlY3QoXG4gICAgdHlwZW9mIGN0eC5ib2R5ID09PSAnc3RyaW5nJyAmJiBjdHguYm9keS5pbmNsdWRlcygnaGVsbG8nKVxuICApLnRvQmVUcnV0aHkoKTtcbiAgZXhwZWN0KGRpZFJlbmRlcikudG9CZVRydXRoeSgpO1xuICBleHBlY3QoZGlkVXNlQ3VzdG9tUHJvdmlkZXIpLnRvQmVUcnV0aHkoKTtcbn0pO1xuXG50ZXN0KCdob2MnLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IFRlc3RUb2tlbjEgPSBjcmVhdGVUb2tlbigndGVzdC10b2tlbi0xJyk7XG4gIGNvbnN0IFRlc3RUb2tlbjIgPSBjcmVhdGVUb2tlbigndGVzdC10b2tlbi0yJyk7XG4gIGNvbnN0IFRlc3RUb2tlbjMgPSBjcmVhdGVUb2tlbigndGVzdC10b2tlbi0zJyk7XG4gIGNvbnN0IHdpdGhUZXN0ID0gY29tcG9zZShcbiAgICBob2MuY3JlYXRlKCd0ZXN0MScsIHVuZGVmaW5lZCwgVGVzdFRva2VuMSksXG4gICAgaG9jLmNyZWF0ZSgndGVzdDInLCB1bmRlZmluZWQsIFRlc3RUb2tlbjIpLFxuICAgIGhvYy5jcmVhdGUoJ3Rlc3QzJywgcHJvdmlkZXMgPT4gKHttYXBwZWQ6IHByb3ZpZGVzfSksIFRlc3RUb2tlbjMpXG4gICk7XG4gIGNvbnN0IHRlc3RQcm92aWRlczEgPSB7aGVsbG86IDF9O1xuICBjb25zdCB0ZXN0UHJvdmlkZXMyID0ge2hlbGxvOiAyfTtcbiAgY29uc3QgdGVzdFByb3ZpZGVzMyA9IHtoZWxsbzogM307XG4gIGxldCBkaWRSZW5kZXIgPSBmYWxzZTtcbiAgZnVuY3Rpb24gVGVzdENvbXBvbmVudChwcm9wcykge1xuICAgIGRpZFJlbmRlciA9IHRydWU7XG4gICAgZXhwZWN0KHByb3BzLnRlc3QxKS50b1N0cmljdEVxdWFsKHRlc3RQcm92aWRlczEpO1xuICAgIGV4cGVjdChwcm9wcy50ZXN0MikudG9TdHJpY3RFcXVhbCh0ZXN0UHJvdmlkZXMyKTtcbiAgICBleHBlY3QocHJvcHMubWFwcGVkKS50b1N0cmljdEVxdWFsKHRlc3RQcm92aWRlczMpO1xuICAgIGV4cGVjdChwcm9wcy5jdHgpLnRvQmVGYWxzeSgpO1xuICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KCdkaXYnLCBudWxsLCAnaGVsbG8nKTtcbiAgfVxuICBjb25zdCB0ZXN0UGx1Z2luMSA9IGNyZWF0ZVBsdWdpbih7cHJvdmlkZXM6ICgpID0+IHRlc3RQcm92aWRlczF9KTtcbiAgY29uc3QgdGVzdFBsdWdpbjIgPSBwbHVnaW4uY3JlYXRlKFxuICAgICd0ZXN0MicsXG4gICAgY3JlYXRlUGx1Z2luKHtwcm92aWRlczogKCkgPT4gdGVzdFByb3ZpZGVzMn0pXG4gICk7XG4gIGNvbnN0IHRlc3RQbHVnaW4zID0gY3JlYXRlUGx1Z2luKHtwcm92aWRlczogKCkgPT4gdGVzdFByb3ZpZGVzM30pO1xuICBjb25zdCBlbGVtZW50ID0gUmVhY3QuY3JlYXRlRWxlbWVudCh3aXRoVGVzdChUZXN0Q29tcG9uZW50KSk7XG4gIGNvbnN0IGFwcCA9IG5ldyBBcHAoZWxlbWVudCk7XG4gIGFwcC5yZWdpc3RlcihUZXN0VG9rZW4xLCB0ZXN0UGx1Z2luMSk7XG4gIGFwcC5yZWdpc3RlcihUZXN0VG9rZW4yLCB0ZXN0UGx1Z2luMik7XG4gIGFwcC5yZWdpc3RlcihUZXN0VG9rZW4zLCB0ZXN0UGx1Z2luMyk7XG4gIGNvbnN0IHNpbSA9IGdldFNpbXVsYXRvcihhcHApO1xuICBjb25zdCBjdHggPSBhd2FpdCBzaW0ucmVuZGVyKCcvJyk7XG4gIGV4cGVjdChcbiAgICB0eXBlb2YgY3R4LmJvZHkgPT09ICdzdHJpbmcnICYmIGN0eC5ib2R5LmluY2x1ZGVzKCdoZWxsbycpXG4gICkudG9CZVRydXRoeSgpO1xuICBleHBlY3QoZGlkUmVuZGVyKS50b0JlVHJ1dGh5KCk7XG59KTtcbiJdfQ==