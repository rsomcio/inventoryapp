/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */
import * as React from 'react';
import { createToken, createPlugin } from 'fusion-core';
import { getSimulator } from 'fusion-test-utils';
import App from '../index';
import { FusionContext, ServiceConsumer, useService, withServices } from '../context.js';
test('context#useService', async () => {
  const TestToken = createToken('test');
  const TestPlugin = createPlugin({
    provides: () => 3
  });
  let didRender = false;

  function TestComponent() {
    const provides = useService(TestToken);
    const ctx = React.useContext(FusionContext);
    didRender = true;
    expect(provides).toBe(3);
    expect(ctx.request.url).toBe('/');
    return React.createElement('div', null, 'hello');
  }

  const element = React.createElement(TestComponent);
  const app = new App(element);
  app.register(TestToken, TestPlugin);
  const sim = getSimulator(app);
  const ctx = await sim.render('/');
  expect(typeof ctx.body === 'string' && ctx.body.includes('hello')).toBeTruthy();
  expect(didRender).toBeTruthy();
});
test('context#useService - unregistered token', async () => {
  let didRender = false;

  function TestComponent() {
    const TestToken = createToken('test');
    useService(TestToken);
    didRender = true;
    return React.createElement('div', null, 'hello');
  }

  const element = React.createElement(TestComponent);
  const app = new App(element);
  const sim = getSimulator(app);

  try {
    await sim.render('/');
  } catch (e) {
    expect(/Token .* not registered/.test(e.message)).toBeTruthy();
  }

  expect(didRender).toBeFalsy();
});
test('context#useService - optional token', async () => {
  let didRender = false;

  function TestComponent() {
    const TestToken = createToken('test');
    useService(TestToken.optional);
    didRender = true;
    return React.createElement('div', null, 'hello');
  }

  const element = React.createElement(TestComponent);
  const app = new App(element);
  const sim = getSimulator(app);
  await sim.render('/');
  expect(didRender).toBeTruthy();
});
test('context#ServiceConsumer', async () => {
  const TestToken = createToken('test');
  const TestPlugin = createPlugin({
    provides: () => 3
  });
  let didRender = false;

  function TestComponent() {
    return React.createElement(ServiceConsumer, {
      token: TestToken
    }, provides => {
      didRender = true;
      expect(provides).toBe(3);
      return React.createElement('div', null, 'hello');
    });
  }

  const element = React.createElement(TestComponent);
  const app = new App(element);
  app.register(TestToken, TestPlugin);
  const sim = getSimulator(app);
  const ctx = await sim.render('/');
  expect(typeof ctx.body === 'string' && ctx.body.includes('hello')).toBeTruthy();
  expect(didRender).toBeTruthy();
});
test('context#withServices', async () => {
  const TestToken1 = createToken('test-1');
  const TestToken2 = createToken('test-2');
  const TestPlugin1 = createPlugin({
    provides: () => 1
  });
  const TestPlugin2 = createPlugin({
    provides: () => 2
  });
  let didRender = false;

  function TestComponent({
    mappedOne,
    mappedTwo,
    propValue
  }) {
    didRender = true;
    expect(mappedOne).toBe(1);
    expect(mappedTwo).toBe(2);
    expect(propValue).toBe(3);
    return React.createElement('div', null, 'hello');
  }

  const WrappedComponent = withServices({
    test1: TestToken1,
    test2: TestToken2
  }, deps => ({
    mappedOne: deps.test1,
    mappedTwo: deps.test2
  }))(TestComponent);
  const element = React.createElement(WrappedComponent, {
    propValue: 3
  });
  const app = new App(element);
  app.register(TestToken1, TestPlugin1);
  app.register(TestToken2, TestPlugin2);
  const sim = getSimulator(app);
  const ctx = await sim.render('/');
  expect(typeof ctx.body === 'string' && ctx.body.includes('hello')).toBeTruthy();
  expect(didRender).toBeTruthy();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbnRleHQubm9kZS5qcyJdLCJuYW1lcyI6WyJSZWFjdCIsImNyZWF0ZVRva2VuIiwiY3JlYXRlUGx1Z2luIiwiZ2V0U2ltdWxhdG9yIiwiQXBwIiwiRnVzaW9uQ29udGV4dCIsIlNlcnZpY2VDb25zdW1lciIsInVzZVNlcnZpY2UiLCJ3aXRoU2VydmljZXMiLCJ0ZXN0IiwiVGVzdFRva2VuIiwiVGVzdFBsdWdpbiIsInByb3ZpZGVzIiwiZGlkUmVuZGVyIiwiVGVzdENvbXBvbmVudCIsImN0eCIsInVzZUNvbnRleHQiLCJleHBlY3QiLCJ0b0JlIiwicmVxdWVzdCIsInVybCIsImNyZWF0ZUVsZW1lbnQiLCJlbGVtZW50IiwiYXBwIiwicmVnaXN0ZXIiLCJzaW0iLCJyZW5kZXIiLCJib2R5IiwiaW5jbHVkZXMiLCJ0b0JlVHJ1dGh5IiwiZSIsIm1lc3NhZ2UiLCJ0b0JlRmFsc3kiLCJvcHRpb25hbCIsInRva2VuIiwiVGVzdFRva2VuMSIsIlRlc3RUb2tlbjIiLCJUZXN0UGx1Z2luMSIsIlRlc3RQbHVnaW4yIiwibWFwcGVkT25lIiwibWFwcGVkVHdvIiwicHJvcFZhbHVlIiwiV3JhcHBlZENvbXBvbmVudCIsInRlc3QxIiwidGVzdDIiLCJkZXBzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQVFBLE9BQU8sS0FBS0EsS0FBWixNQUF1QixPQUF2QjtBQUNBLFNBQVFDLFdBQVIsRUFBcUJDLFlBQXJCLFFBQXdDLGFBQXhDO0FBQ0EsU0FBUUMsWUFBUixRQUEyQixtQkFBM0I7QUFDQSxPQUFPQyxHQUFQLE1BQWdCLFVBQWhCO0FBQ0EsU0FDRUMsYUFERixFQUVFQyxlQUZGLEVBR0VDLFVBSEYsRUFJRUMsWUFKRixRQUtPLGVBTFA7QUFPQUMsSUFBSSxDQUFDLG9CQUFELEVBQXVCLFlBQVk7QUFDckMsUUFBTUMsU0FBUyxHQUFHVCxXQUFXLENBQUMsTUFBRCxDQUE3QjtBQUNBLFFBQU1VLFVBQVUsR0FBR1QsWUFBWSxDQUFDO0FBQUNVLElBQUFBLFFBQVEs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MTggVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZmxvd1xuICovXG5cbmltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7Y3JlYXRlVG9rZW4sIGNyZWF0ZVBsdWdpbn0gZnJvbSAnZnVzaW9uLWNvcmUnO1xuaW1wb3J0IHtnZXRTaW11bGF0b3J9IGZyb20gJ2Z1c2lvbi10ZXN0LXV0aWxzJztcbmltcG9ydCBBcHAgZnJvbSAnLi4vaW5kZXgnO1xuaW1wb3J0IHtcbiAgRnVzaW9uQ29udGV4dCxcbiAgU2VydmljZUNvbnN1bWVyLFxuICB1c2VTZXJ2aWNlLFxuICB3aXRoU2VydmljZXMsXG59IGZyb20gJy4uL2NvbnRleHQuanMnO1xuXG50ZXN0KCdjb250ZXh0I3VzZVNlcnZpY2UnLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IFRlc3RUb2tlbiA9IGNyZWF0ZVRva2VuKCd0ZXN0Jyk7XG4gIGNvbnN0IFRlc3RQbHVnaW4gPSBjcmVhdGVQbHVnaW4oe3Byb3ZpZGVzOiAoKSA9PiAzfSk7XG4gIGxldCBkaWRSZW5kZXIgPSBmYWxzZTtcbiAgZnVuY3Rpb24gVGVzdENvbXBvbmVudCgpIHtcbiAgICBjb25zdCBwcm92aWRlcyA9IHVzZVNlcnZpY2UoVGVzdFRva2VuKTtcbiAgICBjb25zdCBjdHggPSBSZWFjdC51c2VDb250ZXh0KEZ1c2lvbkNvbnRleHQpO1xuICAgIGRpZFJlbmRlciA9IHRydWU7XG4gICAgZXhwZWN0KHByb3ZpZGVzKS50b0JlKDMpO1xuICAgIGV4cGVjdChjdHgucmVxdWVzdC51cmwpLnRvQmUoJy8nKTtcbiAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgnZGl2JywgbnVsbCwgJ2hlbGxvJyk7XG4gIH1cbiAgY29uc3QgZWxlbWVudCA9IFJlYWN0LmNyZWF0ZUVsZW1lbnQoVGVzdENvbXBvbmVudCk7XG4gIGNvbnN0IGFwcCA9IG5ldyBBcHAoZWxlbWVudCk7XG4gIGFwcC5yZWdpc3RlcihUZXN0VG9rZW4sIFRlc3RQbHVnaW4pO1xuICBjb25zdCBzaW0gPSBnZXRTaW11bGF0b3IoYXBwKTtcbiAgY29uc3QgY3R4ID0gYXdhaXQgc2ltLnJlbmRlcignLycpO1xuICBleHBlY3QoXG4gICAgdHlwZW9mIGN0eC5ib2R5ID09PSAnc3RyaW5nJyAmJiBjdHguYm9keS5pbmNsdWRlcygnaGVsbG8nKVxuICApLnRvQmVUcnV0aHkoKTtcbiAgZXhwZWN0KGRpZFJlbmRlcikudG9CZVRydXRoeSgpO1xufSk7XG5cbnRlc3QoJ2NvbnRleHQjdXNlU2VydmljZSAtIHVucmVnaXN0ZXJlZCB0b2tlbicsIGFzeW5jICgpID0+IHtcbiAgbGV0IGRpZFJlbmRlciA9IGZhbHNlO1xuICBmdW5jdGlvbiBUZXN0Q29tcG9uZW50KCkge1xuICAgIGNvbnN0IFRlc3RUb2tlbiA9IGNyZWF0ZVRva2VuKCd0ZXN0Jyk7XG4gICAgdXNlU2VydmljZShUZXN0VG9rZW4pO1xuICAgIGRpZFJlbmRlciA9IHRydWU7XG4gICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoJ2RpdicsIG51bGwsICdoZWxsbycpO1xuICB9XG4gIGNvbnN0IGVsZW1lbnQgPSBSZWFjdC5jcmVhdGVFbGVtZW50KFRlc3RDb21wb25lbnQpO1xuICBjb25zdCBhcHAgPSBuZXcgQXBwKGVsZW1lbnQpO1xuICBjb25zdCBzaW0gPSBnZXRTaW11bGF0b3IoYXBwKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBzaW0ucmVuZGVyKCcvJyk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBleHBlY3QoL1Rva2VuIC4qIG5vdCByZWdpc3RlcmVkLy50ZXN0KGUubWVzc2FnZSkpLnRvQmVUcnV0aHkoKTtcbiAgfVxuICBleHBlY3QoZGlkUmVuZGVyKS50b0JlRmFsc3koKTtcbn0pO1xuXG50ZXN0KCdjb250ZXh0I3VzZVNlcnZpY2UgLSBvcHRpb25hbCB0b2tlbicsIGFzeW5jICgpID0+IHtcbiAgbGV0IGRpZFJlbmRlciA9IGZhbHNlO1xuICBmdW5jdGlvbiBUZXN0Q29tcG9uZW50KCkge1xuICAgIGNvbnN0IFRlc3RUb2tlbiA9IGNyZWF0ZVRva2VuKCd0ZXN0Jyk7XG4gICAgdXNlU2VydmljZShUZXN0VG9rZW4ub3B0aW9uYWwpO1xuICAgIGRpZFJlbmRlciA9IHRydWU7XG4gICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoJ2RpdicsIG51bGwsICdoZWxsbycpO1xuICB9XG4gIGNvbnN0IGVsZW1lbnQgPSBSZWFjdC5jcmVhdGVFbGVtZW50KFRlc3RDb21wb25lbnQpO1xuICBjb25zdCBhcHAgPSBuZXcgQXBwKGVsZW1lbnQpO1xuICBjb25zdCBzaW0gPSBnZXRTaW11bGF0b3IoYXBwKTtcbiAgYXdhaXQgc2ltLnJlbmRlcignLycpO1xuICBleHBlY3QoZGlkUmVuZGVyKS50b0JlVHJ1dGh5KCk7XG59KTtcblxudGVzdCgnY29udGV4dCNTZXJ2aWNlQ29uc3VtZXInLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IFRlc3RUb2tlbiA9IGNyZWF0ZVRva2VuKCd0ZXN0Jyk7XG4gIGNvbnN0IFRlc3RQbHVnaW4gPSBjcmVhdGVQbHVnaW4oe3Byb3ZpZGVzOiAoKSA9PiAzfSk7XG4gIGxldCBkaWRSZW5kZXIgPSBmYWxzZTtcbiAgZnVuY3Rpb24gVGVzdENvbXBvbmVudCgpIHtcbiAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChcbiAgICAgIFNlcnZpY2VDb25zdW1lcixcbiAgICAgIHt0b2tlbjogVGVzdFRva2VufSxcbiAgICAgIHByb3ZpZGVzID0+IHtcbiAgICAgICAgZGlkUmVuZGVyID0gdHJ1ZTtcbiAgICAgICAgZXhwZWN0KHByb3ZpZGVzKS50b0JlKDMpO1xuICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgnZGl2JywgbnVsbCwgJ2hlbGxvJyk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuICBjb25zdCBlbGVtZW50ID0gUmVhY3QuY3JlYXRlRWxlbWVudChUZXN0Q29tcG9uZW50KTtcbiAgY29uc3QgYXBwID0gbmV3IEFwcChlbGVtZW50KTtcbiAgYXBwLnJlZ2lzdGVyKFRlc3RUb2tlbiwgVGVzdFBsdWdpbik7XG4gIGNvbnN0IHNpbSA9IGdldFNpbXVsYXRvcihhcHApO1xuICBjb25zdCBjdHggPSBhd2FpdCBzaW0ucmVuZGVyKCcvJyk7XG4gIGV4cGVjdChcbiAgICB0eXBlb2YgY3R4LmJvZHkgPT09ICdzdHJpbmcnICYmIGN0eC5ib2R5LmluY2x1ZGVzKCdoZWxsbycpXG4gICkudG9CZVRydXRoeSgpO1xuICBleHBlY3QoZGlkUmVuZGVyKS50b0JlVHJ1dGh5KCk7XG59KTtcblxudGVzdCgnY29udGV4dCN3aXRoU2VydmljZXMnLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IFRlc3RUb2tlbjEgPSBjcmVhdGVUb2tlbigndGVzdC0xJyk7XG4gIGNvbnN0IFRlc3RUb2tlbjIgPSBjcmVhdGVUb2tlbigndGVzdC0yJyk7XG4gIGNvbnN0IFRlc3RQbHVnaW4xID0gY3JlYXRlUGx1Z2luKHtwcm92aWRlczogKCkgPT4gMX0pO1xuICBjb25zdCBUZXN0UGx1Z2luMiA9IGNyZWF0ZVBsdWdpbih7cHJvdmlkZXM6ICgpID0+IDJ9KTtcbiAgbGV0IGRpZFJlbmRlciA9IGZhbHNlO1xuICBmdW5jdGlvbiBUZXN0Q29tcG9uZW50KHttYXBwZWRPbmUsIG1hcHBlZFR3bywgcHJvcFZhbHVlfSkge1xuICAgIGRpZFJlbmRlciA9IHRydWU7XG4gICAgZXhwZWN0KG1hcHBlZE9uZSkudG9CZSgxKTtcbiAgICBleHBlY3QobWFwcGVkVHdvKS50b0JlKDIpO1xuICAgIGV4cGVjdChwcm9wVmFsdWUpLnRvQmUoMyk7XG4gICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoJ2RpdicsIG51bGwsICdoZWxsbycpO1xuICB9XG4gIGNvbnN0IFdyYXBwZWRDb21wb25lbnQgPSB3aXRoU2VydmljZXMoXG4gICAge1xuICAgICAgdGVzdDE6IFRlc3RUb2tlbjEsXG4gICAgICB0ZXN0MjogVGVzdFRva2VuMixcbiAgICB9LFxuICAgIGRlcHMgPT4gKHttYXBwZWRPbmU6IGRlcHMudGVzdDEsIG1hcHBlZFR3bzogZGVwcy50ZXN0Mn0pXG4gICkoVGVzdENvbXBvbmVudCk7XG4gIGNvbnN0IGVsZW1lbnQgPSBSZWFjdC5jcmVhdGVFbGVtZW50KFdyYXBwZWRDb21wb25lbnQsIHtwcm9wVmFsdWU6IDN9KTtcbiAgY29uc3QgYXBwID0gbmV3IEFwcChlbGVtZW50KTtcbiAgYXBwLnJlZ2lzdGVyKFRlc3RUb2tlbjEsIFRlc3RQbHVnaW4xKTtcbiAgYXBwLnJlZ2lzdGVyKFRlc3RUb2tlbjIsIFRlc3RQbHVnaW4yKTtcbiAgY29uc3Qgc2ltID0gZ2V0U2ltdWxhdG9yKGFwcCk7XG4gIGNvbnN0IGN0eCA9IGF3YWl0IHNpbS5yZW5kZXIoJy8nKTtcbiAgZXhwZWN0KFxuICAgIHR5cGVvZiBjdHguYm9keSA9PT0gJ3N0cmluZycgJiYgY3R4LmJvZHkuaW5jbHVkZXMoJ2hlbGxvJylcbiAgKS50b0JlVHJ1dGh5KCk7XG4gIGV4cGVjdChkaWRSZW5kZXIpLnRvQmVUcnV0aHkoKTtcbn0pO1xuIl19