"use strict";

var React = _interopRequireWildcard(require("react"));

var _fusionCore = require("fusion-core");

var _fusionTestUtils = require("fusion-test-utils");

var _propTypes = _interopRequireDefault(require("prop-types"));

var _index = _interopRequireDefault(require("../index"));

var _hoc = _interopRequireDefault(require("../hoc"));

var _plugin = _interopRequireDefault(require("../plugin"));

var _justCompose = _interopRequireDefault(require("just-compose"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */
test('hoc#legacy', async () => {
  const withTest = _hoc.default.create('test');

  const testProvides = {
    hello: 'world'
  };
  let didRender = false;

  function TestComponent(props) {
    didRender = true;
    expect(props.test).toStrictEqual(testProvides);
    expect(props.ctx).toBeFalsy();
    return React.createElement('div', null, 'hello');
  }

  const testPlugin = _plugin.default.create('test', (0, _fusionCore.createPlugin)({
    provides: () => testProvides
  }));

  const element = React.createElement(withTest(TestComponent));
  const app = new _index.default(element);
  app.register(testPlugin);
  const sim = (0, _fusionTestUtils.getSimulator)(app);
  const ctx = await sim.render('/');
  expect(typeof ctx.body === 'string' && ctx.body.includes('hello')).toBeTruthy();
  expect(didRender).toBeTruthy();
});
test('hoc#legacy with mapProvidesToProps', async () => {
  const withTest = _hoc.default.create('test', provides => {
    return {
      mapped: provides
    };
  });

  const testProvides = {
    hello: 'world'
  };
  let didRender = false;

  function TestComponent(props) {
    didRender = true;
    expect(props.mapped).toStrictEqual(testProvides);
    return React.createElement('div', null, 'hello');
  }

  const testPlugin = _plugin.default.create('test', (0, _fusionCore.createPlugin)({
    provides: () => testProvides
  }));

  const element = React.createElement(withTest(TestComponent));
  const app = new _index.default(element);
  app.register(testPlugin);
  const sim = (0, _fusionTestUtils.getSimulator)(app);
  const ctx = await sim.render('/');
  expect(typeof ctx.body === 'string' && ctx.body.includes('hello')).toBeTruthy();
  expect(didRender).toBeTruthy();
});
test('hoc#legacy with custom provider', async () => {
  const withTest = _hoc.default.create('test');

  const testProvides = {
    hello: 'world'
  };
  let didRender = false;
  let didUseCustomProvider = false;

  function TestComponent(props) {
    didRender = true;
    expect(props.test).toStrictEqual(testProvides);
    return React.createElement('div', null, 'hello');
  }

  class CustomProvider extends React.Component {
    getChildContext() {
      return {
        test: this.props.provides
      };
    }

    render() {
      didUseCustomProvider = true;
      expect(this.props.ctx).toBeTruthy();
      return React.Children.only(this.props.children);
    }

  }

  CustomProvider.childContextTypes = {
    test: _propTypes.default.any.isRequired
  };

  const testPlugin = _plugin.default.create('test', (0, _fusionCore.createPlugin)({
    provides: () => testProvides
  }), CustomProvider);

  const element = React.createElement(withTest(TestComponent));
  const app = new _index.default(element);
  app.register(testPlugin);
  const sim = (0, _fusionTestUtils.getSimulator)(app);
  const ctx = await sim.render('/');
  expect(typeof ctx.body === 'string' && ctx.body.includes('hello')).toBeTruthy();
  expect(didRender).toBeTruthy();
  expect(didUseCustomProvider).toBeTruthy();
});
test('hoc', async () => {
  const TestToken1 = (0, _fusionCore.createToken)('test-token-1');
  const TestToken2 = (0, _fusionCore.createToken)('test-token-2');
  const TestToken3 = (0, _fusionCore.createToken)('test-token-3');
  const withTest = (0, _justCompose.default)(_hoc.default.create('test1', undefined, TestToken1), _hoc.default.create('test2', undefined, TestToken2), _hoc.default.create('test3', provides => ({
    mapped: provides
  }), TestToken3));
  const testProvides1 = {
    hello: 1
  };
  const testProvides2 = {
    hello: 2
  };
  const testProvides3 = {
    hello: 3
  };
  let didRender = false;

  function TestComponent(props) {
    didRender = true;
    expect(props.test1).toStrictEqual(testProvides1);
    expect(props.test2).toStrictEqual(testProvides2);
    expect(props.mapped).toStrictEqual(testProvides3);
    expect(props.ctx).toBeFalsy();
    return React.createElement('div', null, 'hello');
  }

  const testPlugin1 = (0, _fusionCore.createPlugin)({
    provides: () => testProvides1
  });

  const testPlugin2 = _plugin.default.create('test2', (0, _fusionCore.createPlugin)({
    provides: () => testProvides2
  }));

  const testPlugin3 = (0, _fusionCore.createPlugin)({
    provides: () => testProvides3
  });
  const element = React.createElement(withTest(TestComponent));
  const app = new _index.default(element);
  app.register(TestToken1, testPlugin1);
  app.register(TestToken2, testPlugin2);
  app.register(TestToken3, testPlugin3);
  const sim = (0, _fusionTestUtils.getSimulator)(app);
  const ctx = await sim.render('/');
  expect(typeof ctx.body === 'string' && ctx.body.includes('hello')).toBeTruthy();
  expect(didRender).toBeTruthy();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhvYy5ub2RlLmpzIl0sIm5hbWVzIjpbInRlc3QiLCJ3aXRoVGVzdCIsImhvYyIsImNyZWF0ZSIsInRlc3RQcm92aWRlcyIsImhlbGxvIiwiZGlkUmVuZGVyIiwiVGVzdENvbXBvbmVudCIsInByb3BzIiwiZXhwZWN0IiwidG9TdHJpY3RFcXVhbCIsImN0eCIsInRvQmVGYWxzeSIsIlJlYWN0IiwiY3JlYXRlRWxlbWVudCIsInRlc3RQbHVnaW4iLCJwbHVnaW4iLCJwcm92aWRlcyIsImVsZW1lbnQiLCJhcHAiLCJBcHAiLCJyZWdpc3RlciIsInNpbSIsInJlbmRlciIsImJvZHkiLCJpbmNsdWRlcyIsInRvQmVUcnV0aHkiLCJtYXBwZWQiLCJkaWRVc2VDdXN0b21Qcm92aWRlciIsIkN1c3RvbVByb3ZpZGVyIiwiQ29tcG9uZW50IiwiZ2V0Q2hpbGRDb250ZXh0IiwiQ2hpbGRyZW4iLCJvbmx5IiwiY2hpbGRyZW4iLCJjaGlsZENvbnRleHRUeXBlcyIsIlByb3BUeXBlcyIsImFueSIsImlzUmVxdWlyZWQiLCJUZXN0VG9rZW4xIiwiVGVzdFRva2VuMiIsIlRlc3RUb2tlbjMiLCJ1bmRlZmluZWQiLCJ0ZXN0UHJvdmlkZXMxIiwidGVzdFByb3ZpZGVzMiIsInRlc3RQcm92aWRlczMiLCJ0ZXN0MSIsInRlc3QyIiwidGVzdFBsdWdpbjEiLCJ0ZXN0UGx1Z2luMiIsInRlc3RQbHVnaW4zIl0sIm1hcHBpbmdzIjoiOztBQVFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7OztBQWZBOzs7Ozs7O0FBaUJBQSxJQUFJLENBQUMsWUFBRCxFQUFlLFlBQVk7QUFDN0IsUUFBTUMsUUFBUSxHQUFHQyxhQUFJQyxNQUFKLENBQVcsTUFBWCxDQUFqQjs7QUFDQSxRQUFNQyxZQUFZLEdBQUc7QUFBQ0MsSUFBQUEsS0FBSyxFQUFFO0FBQVIsR0FBckI7QUFDQSxNQUFJQyxTQUFTLEdBQUcsS0FBaEI7O0FBQ0EsV0FBU0MsYUFBVCxDQUF1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LFFBQVEsRUFBRSxNQUFNNEI7QUFBakIsR0FBYixDQUFwQjtBQUNBLFFBQU0zQixPQUFPLEdBQUdMLEtBQUssQ0FBQ0MsYUFBTixDQUFvQmIsUUFBUSxDQUFDTSxhQUFELENBQTVCLENBQWhCO0FBQ0EsUUFBTVksR0FBRyxHQUFHLElBQUlDLGNBQUosQ0FBUUYsT0FBUixDQUFaO0FBQ0FDLEVBQUFBLEdBQUcsQ0FBQ0UsUUFBSixDQUFha0IsVUFBYixFQUF5QlMsV0FBekI7QUFDQTdCLEVBQUFBLEdBQUcsQ0FBQ0UsUUFBSixDQUFhbUIsVUFBYixFQUF5QlMsV0FBekI7QUFDQTlCLEVBQUFBLEdBQUcsQ0FBQ0UsUUFBSixDQUFhb0IsVUFBYixFQUF5QlMsV0FBekI7QUFDQSxRQUFNNUIsR0FBRyxHQUFHLG1DQUFhSCxHQUFiLENBQVo7QUFDQSxRQUFNUixHQUFHLEdBQUcsTUFBTVcsR0FBRyxDQUFDQyxNQUFKLENBQVcsR0FBWCxDQUFsQjtBQUNBZCxFQUFBQSxNQUFNLENBQ0osT0FBT0UsR0FBRyxDQUFDYSxJQUFYLEtBQW9CLFFBQXBCLElBQWdDYixHQUFHLENBQUNhLElBQUosQ0FBU0MsUUFBVCxDQUFrQixPQUFsQixDQUQ1QixDQUFOLENBRUVDLFVBRkY7QUFHQWpCLEVBQUFBLE1BQU0sQ0FBQ0gsU0FBRCxDQUFOLENBQWtCb0IsVUFBbEI7QUFDRCxDQXRDRyxDQUFKIiwic291cmNlc0NvbnRlbnQiOlsiLyoqIENvcHlyaWdodCAoYykgMjAxOCBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBmbG93XG4gKi9cblxuaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHtjcmVhdGVUb2tlbiwgY3JlYXRlUGx1Z2lufSBmcm9tICdmdXNpb24tY29yZSc7XG5pbXBvcnQge2dldFNpbXVsYXRvcn0gZnJvbSAnZnVzaW9uLXRlc3QtdXRpbHMnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCBBcHAgZnJvbSAnLi4vaW5kZXgnO1xuaW1wb3J0IGhvYyBmcm9tICcuLi9ob2MnO1xuaW1wb3J0IHBsdWdpbiBmcm9tICcuLi9wbHVnaW4nO1xuaW1wb3J0IGNvbXBvc2UgZnJvbSAnanVzdC1jb21wb3NlJztcblxudGVzdCgnaG9jI2xlZ2FjeScsIGFzeW5jICgpID0+IHtcbiAgY29uc3Qgd2l0aFRlc3QgPSBob2MuY3JlYXRlKCd0ZXN0Jyk7XG4gIGNvbnN0IHRlc3RQcm92aWRlcyA9IHtoZWxsbzogJ3dvcmxkJ307XG4gIGxldCBkaWRSZW5kZXIgPSBmYWxzZTtcbiAgZnVuY3Rpb24gVGVzdENvbXBvbmVudChwcm9wcykge1xuICAgIGRpZFJlbmRlciA9IHRydWU7XG4gICAgZXhwZWN0KHByb3BzLnRlc3QpLnRvU3RyaWN0RXF1YWwodGVzdFByb3ZpZGVzKTtcbiAgICBleHBlY3QocHJvcHMuY3R4KS50b0JlRmFsc3koKTtcbiAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgnZGl2JywgbnVsbCwgJ2hlbGxvJyk7XG4gIH1cbiAgY29uc3QgdGVzdFBsdWdpbiA9IHBsdWdpbi5jcmVhdGUoXG4gICAgJ3Rlc3QnLFxuICAgIGNyZWF0ZVBsdWdpbih7cHJvdmlkZXM6ICgpID0+IHRlc3RQcm92aWRlc30pXG4gICk7XG4gIGNvbnN0IGVsZW1lbnQgPSBSZWFjdC5jcmVhdGVFbGVtZW50KHdpdGhUZXN0KFRlc3RDb21wb25lbnQpKTtcbiAgY29uc3QgYXBwID0gbmV3IEFwcChlbGVtZW50KTtcbiAgYXBwLnJlZ2lzdGVyKHRlc3RQbHVnaW4pO1xuICBjb25zdCBzaW0gPSBnZXRTaW11bGF0b3IoYXBwKTtcbiAgY29uc3QgY3R4ID0gYXdhaXQgc2ltLnJlbmRlcignLycpO1xuICBleHBlY3QoXG4gICAgdHlwZW9mIGN0eC5ib2R5ID09PSAnc3RyaW5nJyAmJiBjdHguYm9keS5pbmNsdWRlcygnaGVsbG8nKVxuICApLnRvQmVUcnV0aHkoKTtcbiAgZXhwZWN0KGRpZFJlbmRlcikudG9CZVRydXRoeSgpO1xufSk7XG5cbnRlc3QoJ2hvYyNsZWdhY3kgd2l0aCBtYXBQcm92aWRlc1RvUHJvcHMnLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IHdpdGhUZXN0ID0gaG9jLmNyZWF0ZSgndGVzdCcsIHByb3ZpZGVzID0+IHtcbiAgICByZXR1cm4ge21hcHBlZDogcHJvdmlkZXN9O1xuICB9KTtcblxuICBjb25zdCB0ZXN0UHJvdmlkZXMgPSB7aGVsbG86ICd3b3JsZCd9O1xuICBsZXQgZGlkUmVuZGVyID0gZmFsc2U7XG4gIGZ1bmN0aW9uIFRlc3RDb21wb25lbnQocHJvcHMpIHtcbiAgICBkaWRSZW5kZXIgPSB0cnVlO1xuICAgIGV4cGVjdChwcm9wcy5tYXBwZWQpLnRvU3RyaWN0RXF1YWwodGVzdFByb3ZpZGVzKTtcbiAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgnZGl2JywgbnVsbCwgJ2hlbGxvJyk7XG4gIH1cblxuICBjb25zdCB0ZXN0UGx1Z2luID0gcGx1Z2luLmNyZWF0ZShcbiAgICAndGVzdCcsXG4gICAgY3JlYXRlUGx1Z2luKHtwcm92aWRlczogKCkgPT4gdGVzdFByb3ZpZGVzfSlcbiAgKTtcbiAgY29uc3QgZWxlbWVudCA9IFJlYWN0LmNyZWF0ZUVsZW1lbnQod2l0aFRlc3QoVGVzdENvbXBvbmVudCkpO1xuICBjb25zdCBhcHAgPSBuZXcgQXBwKGVsZW1lbnQpO1xuICBhcHAucmVnaXN0ZXIodGVzdFBsdWdpbik7XG4gIGNvbnN0IHNpbSA9IGdldFNpbXVsYXRvcihhcHApO1xuICBjb25zdCBjdHggPSBhd2FpdCBzaW0ucmVuZGVyKCcvJyk7XG4gIGV4cGVjdChcbiAgICB0eXBlb2YgY3R4LmJvZHkgPT09ICdzdHJpbmcnICYmIGN0eC5ib2R5LmluY2x1ZGVzKCdoZWxsbycpXG4gICkudG9CZVRydXRoeSgpO1xuICBleHBlY3QoZGlkUmVuZGVyKS50b0JlVHJ1dGh5KCk7XG59KTtcblxudGVzdCgnaG9jI2xlZ2FjeSB3aXRoIGN1c3RvbSBwcm92aWRlcicsIGFzeW5jICgpID0+IHtcbiAgY29uc3Qgd2l0aFRlc3QgPSBob2MuY3JlYXRlKCd0ZXN0Jyk7XG5cbiAgY29uc3QgdGVzdFByb3ZpZGVzID0ge2hlbGxvOiAnd29ybGQnfTtcbiAgbGV0IGRpZFJlbmRlciA9IGZhbHNlO1xuICBsZXQgZGlkVXNlQ3VzdG9tUHJvdmlkZXIgPSBmYWxzZTtcbiAgZnVuY3Rpb24gVGVzdENvbXBvbmVudChwcm9wcykge1xuICAgIGRpZFJlbmRlciA9IHRydWU7XG4gICAgZXhwZWN0KHByb3BzLnRlc3QpLnRvU3RyaWN0RXF1YWwodGVzdFByb3ZpZGVzKTtcbiAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgnZGl2JywgbnVsbCwgJ2hlbGxvJyk7XG4gIH1cbiAgY2xhc3MgQ3VzdG9tUHJvdmlkZXIgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8Kj4ge1xuICAgIGdldENoaWxkQ29udGV4dCgpIHtcbiAgICAgIHJldHVybiB7dGVzdDogdGhpcy5wcm9wcy5wcm92aWRlc307XG4gICAgfVxuICAgIHJlbmRlcigpIHtcbiAgICAgIGRpZFVzZUN1c3RvbVByb3ZpZGVyID0gdHJ1ZTtcbiAgICAgIGV4cGVjdCh0aGlzLnByb3BzLmN0eCkudG9CZVRydXRoeSgpO1xuICAgICAgcmV0dXJuIFJlYWN0LkNoaWxkcmVuLm9ubHkodGhpcy5wcm9wcy5jaGlsZHJlbik7XG4gICAgfVxuICB9XG4gIEN1c3RvbVByb3ZpZGVyLmNoaWxkQ29udGV4dFR5cGVzID0ge1xuICAgIHRlc3Q6IFByb3BUeXBlcy5hbnkuaXNSZXF1aXJlZCxcbiAgfTtcblxuICBjb25zdCB0ZXN0UGx1Z2luID0gcGx1Z2luLmNyZWF0ZShcbiAgICAndGVzdCcsXG4gICAgY3JlYXRlUGx1Z2luKHtwcm92aWRlczogKCkgPT4gdGVzdFByb3ZpZGVzfSksXG4gICAgQ3VzdG9tUHJvdmlkZXJcbiAgKTtcbiAgY29uc3QgZWxlbWVudCA9IFJlYWN0LmNyZWF0ZUVsZW1lbnQod2l0aFRlc3QoVGVzdENvbXBvbmVudCkpO1xuICBjb25zdCBhcHAgPSBuZXcgQXBwKGVsZW1lbnQpO1xuICBhcHAucmVnaXN0ZXIodGVzdFBsdWdpbik7XG4gIGNvbnN0IHNpbSA9IGdldFNpbXVsYXRvcihhcHApO1xuICBjb25zdCBjdHggPSBhd2FpdCBzaW0ucmVuZGVyKCcvJyk7XG4gIGV4cGVjdChcbiAgICB0eXBlb2YgY3R4LmJvZHkgPT09ICdzdHJpbmcnICYmIGN0eC5ib2R5LmluY2x1ZGVzKCdoZWxsbycpXG4gICkudG9CZVRydXRoeSgpO1xuICBleHBlY3QoZGlkUmVuZGVyKS50b0JlVHJ1dGh5KCk7XG4gIGV4cGVjdChkaWRVc2VDdXN0b21Qcm92aWRlcikudG9CZVRydXRoeSgpO1xufSk7XG5cbnRlc3QoJ2hvYycsIGFzeW5jICgpID0+IHtcbiAgY29uc3QgVGVzdFRva2VuMSA9IGNyZWF0ZVRva2VuKCd0ZXN0LXRva2VuLTEnKTtcbiAgY29uc3QgVGVzdFRva2VuMiA9IGNyZWF0ZVRva2VuKCd0ZXN0LXRva2VuLTInKTtcbiAgY29uc3QgVGVzdFRva2VuMyA9IGNyZWF0ZVRva2VuKCd0ZXN0LXRva2VuLTMnKTtcbiAgY29uc3Qgd2l0aFRlc3QgPSBjb21wb3NlKFxuICAgIGhvYy5jcmVhdGUoJ3Rlc3QxJywgdW5kZWZpbmVkLCBUZXN0VG9rZW4xKSxcbiAgICBob2MuY3JlYXRlKCd0ZXN0MicsIHVuZGVmaW5lZCwgVGVzdFRva2VuMiksXG4gICAgaG9jLmNyZWF0ZSgndGVzdDMnLCBwcm92aWRlcyA9PiAoe21hcHBlZDogcHJvdmlkZXN9KSwgVGVzdFRva2VuMylcbiAgKTtcbiAgY29uc3QgdGVzdFByb3ZpZGVzMSA9IHtoZWxsbzogMX07XG4gIGNvbnN0IHRlc3RQcm92aWRlczIgPSB7aGVsbG86IDJ9O1xuICBjb25zdCB0ZXN0UHJvdmlkZXMzID0ge2hlbGxvOiAzfTtcbiAgbGV0IGRpZFJlbmRlciA9IGZhbHNlO1xuICBmdW5jdGlvbiBUZXN0Q29tcG9uZW50KHByb3BzKSB7XG4gICAgZGlkUmVuZGVyID0gdHJ1ZTtcbiAgICBleHBlY3QocHJvcHMudGVzdDEpLnRvU3RyaWN0RXF1YWwodGVzdFByb3ZpZGVzMSk7XG4gICAgZXhwZWN0KHByb3BzLnRlc3QyKS50b1N0cmljdEVxdWFsKHRlc3RQcm92aWRlczIpO1xuICAgIGV4cGVjdChwcm9wcy5tYXBwZWQpLnRvU3RyaWN0RXF1YWwodGVzdFByb3ZpZGVzMyk7XG4gICAgZXhwZWN0KHByb3BzLmN0eCkudG9CZUZhbHN5KCk7XG4gICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoJ2RpdicsIG51bGwsICdoZWxsbycpO1xuICB9XG4gIGNvbnN0IHRlc3RQbHVnaW4xID0gY3JlYXRlUGx1Z2luKHtwcm92aWRlczogKCkgPT4gdGVzdFByb3ZpZGVzMX0pO1xuICBjb25zdCB0ZXN0UGx1Z2luMiA9IHBsdWdpbi5jcmVhdGUoXG4gICAgJ3Rlc3QyJyxcbiAgICBjcmVhdGVQbHVnaW4oe3Byb3ZpZGVzOiAoKSA9PiB0ZXN0UHJvdmlkZXMyfSlcbiAgKTtcbiAgY29uc3QgdGVzdFBsdWdpbjMgPSBjcmVhdGVQbHVnaW4oe3Byb3ZpZGVzOiAoKSA9PiB0ZXN0UHJvdmlkZXMzfSk7XG4gIGNvbnN0IGVsZW1lbnQgPSBSZWFjdC5jcmVhdGVFbGVtZW50KHdpdGhUZXN0KFRlc3RDb21wb25lbnQpKTtcbiAgY29uc3QgYXBwID0gbmV3IEFwcChlbGVtZW50KTtcbiAgYXBwLnJlZ2lzdGVyKFRlc3RUb2tlbjEsIHRlc3RQbHVnaW4xKTtcbiAgYXBwLnJlZ2lzdGVyKFRlc3RUb2tlbjIsIHRlc3RQbHVnaW4yKTtcbiAgYXBwLnJlZ2lzdGVyKFRlc3RUb2tlbjMsIHRlc3RQbHVnaW4zKTtcbiAgY29uc3Qgc2ltID0gZ2V0U2ltdWxhdG9yKGFwcCk7XG4gIGNvbnN0IGN0eCA9IGF3YWl0IHNpbS5yZW5kZXIoJy8nKTtcbiAgZXhwZWN0KFxuICAgIHR5cGVvZiBjdHguYm9keSA9PT0gJ3N0cmluZycgJiYgY3R4LmJvZHkuaW5jbHVkZXMoJ2hlbGxvJylcbiAgKS50b0JlVHJ1dGh5KCk7XG4gIGV4cGVjdChkaWRSZW5kZXIpLnRvQmVUcnV0aHkoKTtcbn0pO1xuIl19