"use strict";

var React = _interopRequireWildcard(require("react"));

var _server = require("react-dom/server");

var _prepareProvider = _interopRequireDefault(require("../../prepare-provider"));

var _index = require("../../index.js");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */

/* eslint-disable react/no-multi-comp */
test('Preparing an app with an async component', async () => {
  function DeferredComponent(props) {
    return React.createElement("div", null, "Loaded");
  }

  function LoadingComponent() {
    return React.createElement("div", null, "Loading");
  }

  function ErrorComponent() {
    return React.createElement("div", null, "Failed");
  }

  const ToTest = (0, _index.split)({
    defer: false,
    load: () => Promise.resolve({
      default: DeferredComponent
    }),
    LoadingComponent,
    ErrorComponent
  });
  const app = React.createElement(_prepareProvider.default, null, React.createElement(ToTest, {
    foo: "foo"
  }));
  expect(/Loading/.test((0, _server.renderToString)(app))).toBeTruthy();
  await (0, _index.prepare)(app);
  expect(/Loaded/.test((0, _server.renderToString)(app))).toBeTruthy();

  try {
    await (0, _index.prepare)(app);
  } catch (e) {
    expect(e).toBeFalsy();
  }
});
test('Preparing an app with an errored async component', async () => {
  function LoadingComponent() {
    return React.createElement("div", null, "Loading");
  }

  function ErrorComponent() {
    return React.createElement("div", null, "Failed");
  }

  const ToTest = (0, _index.split)({
    defer: false,
    load: () => Promise.reject(new Error('failed')),
    LoadingComponent,
    ErrorComponent
  });
  const app = React.createElement(_prepareProvider.default, null, React.createElement(ToTest, null));
  expect(/Loading/.test((0, _server.renderToString)(app))).toBeTruthy();
  await (0, _index.prepare)(app);
  expect(/Failed/.test((0, _server.renderToString)(app))).toBeTruthy();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNwbGl0Lm5vZGUuanMiXSwibmFtZXMiOlsidGVzdCIsIkRlZmVycmVkQ29tcG9uZW50IiwicHJvcHMiLCJMb2FkaW5nQ29tcG9uZW50IiwiRXJyb3JDb21wb25lbnQiLCJUb1Rlc3QiLCJkZWZlciIsImxvYWQiLCJQcm9taXNlIiwicmVzb2x2ZSIsImRlZmF1bHQiLCJhcHAiLCJleHBlY3QiLCJ0b0JlVHJ1dGh5IiwiZSIsInRvQmVGYWxzeSIsInJlamVjdCIsIkVycm9yIl0sIm1hcHBpbmdzIjoiOztBQVNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7OztBQVpBOzs7Ozs7OztBQVFBO0FBTUFBLElBQUksQ0FBQywwQ0FBRCxFQUE2QyxZQUFZO0FBQzNELFdBQVNDLGlCQUFULENBQTJCQyxLQUEzQixFQUFnRDtBQUM5QyxXQUFPLDBDQUFQO0FBQ0Q7O0FBQ0QsV0FBU0MsZ0JBQVQsR0FBNEI7QUFDMUIsV0FBTywyQ0FBUDtBQUNEOztBQUNELFdBQVNDLGNBQVQsR0FBMEI7QUFDeEIsV0FBTywwQ0FBUDtBQUNEOztBQUVELFFBQU1DLE1BQU0sR0FBRyxrQkFBTTtBQUNuQkMsSUFBQUEsS0FBSyxFQUFFLEtBRFk7QUFFbkJDLElBQUFBLElBQUksRUFBRSxNQUFPQyxPQUFPLENBQUNDLE9BQVIsQ0FBZ0I7QUFBQ0MsTUFBQUEsT0FBTyxFQUFFVDtBQUFWLEtBQWhCLENBRk07QUFHbkJFLElBQUFBLGdCQUhtQjtBQUluQkMsSUFBQUE7QUFKbUIsR0FBTixDQUFmO0FBT0EsUUFBTU8sR0FBRyxHQUNQLG9CQUFDLHdCQUFELFFBQ0Usb0JBQUMsTUFBRDtBQUFRLElBQUEsR0FBRyxFQUFDO0FBQVosSUFERixDQURGO0FBTUFDLEVBQUFBLE1BQU0sQ0FBQyxVQUFVWixJQUFWLENBQWUsNEJBQWVXLEdBQWYsQ0FBZixDQUFELENBQU4sQ0FBNENFLFVBQTVDO0FBRUEsUUFBTSxvQkFBUUYsR0FBUixDQUFOO0FBRUFDLEVBQUFBLE1BQU0sQ0FBQyxTQUFTWixJQUFULENBQWMsNEJBQWVXLEdBQWYsQ0FBZCxDQUFELENBQU4sQ0FBMkNFLFVBQTNDOztBQUNBLE1BQUk7QUFDRixVQUFNLG9CQUFRRixHQUFSLENBQU47QUFDRCxHQUZELENBRUUsT0FBT0csQ0FBUCxFQUFVO0FBQ1ZGLElBQUFBLE1BQU0sQ0FBQ0UsQ0FBRCxDQUFOLENBQVVDLFNBQVY7QUFDRDtBQUNGLENBbENHLENBQUo7QUFvQ0FmLElBQUksQ0FBQyxrREFBRCxFQUFxRCxZQUFZO0FBQ25FLFdBQVNHLGdCQUFULEdBQTRCO0FBQzFCLFdBQU8sMkNBQVA7QUFDRDs7QUFDRCxXQUFTQyxjQUFULEdBQTBCO0FBQ3hCLFdBQU8sMENBQVA7QUFDRDs7QUFFRCxRQUFNQyxNQUFNLEdBQUcsa0JBQU07QUFDbkJDLElBQUFBLEtBQUssRUFBRSxLQURZO0FBRW5CQyxJQUFBQSxJQUFJLEVBQUUsTUFBT0MsT0FBTyxDQUFDUSxNQUFSLENBQWUsSUFBSUMsS0FBSixDQUFVLFFBQVYsQ0FBZixDQUZNO0FBR25CZCxJQUFBQSxnQkFIbUI7QUFJbkJDLElBQUFBO0FBSm1CLEdBQU4sQ0FBZjtBQU9BLFFBQU1PLEdBQUcsR0FDUCxvQkFBQyx3QkFBRCxRQUNFLG9CQUFDLE1BQUQsT0FERixDQURGO0FBTUFDLEVBQUFBLE1BQU0sQ0FBQyxVQUFVWixJQUFWLENBQWUsNEJBQWVXLEdBQWYsQ0FBZixDQUFELENBQU4sQ0FBNENFLFVBQTVDO0FBQ0EsUUFBTSxvQkFBUUYsR0FBUixDQUFOO0FBQ0FDLEVBQUFBLE1BQU0sQ0FBQyxTQUFTWixJQUFULENBQWMsNEJBQWVXLEdBQWYsQ0FBZCxDQUFELENBQU4sQ0FBMkNFLFVBQTNDO0FBQ0QsQ0F4QkcsQ0FBSiIsInNvdXJjZXNDb250ZW50IjpbIi8qKiBDb3B5cmlnaHQgKGMpIDIwMTggVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZmxvd1xuICovXG5cbi8qIGVzbGludC1kaXNhYmxlIHJlYWN0L25vLW11bHRpLWNvbXAgKi9cbmltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7cmVuZGVyVG9TdHJpbmd9IGZyb20gJ3JlYWN0LWRvbS9zZXJ2ZXInO1xuaW1wb3J0IFByb3ZpZGVyIGZyb20gJy4uLy4uL3ByZXBhcmUtcHJvdmlkZXInO1xuaW1wb3J0IHtwcmVwYXJlLCBzcGxpdH0gZnJvbSAnLi4vLi4vaW5kZXguanMnO1xuXG50ZXN0KCdQcmVwYXJpbmcgYW4gYXBwIHdpdGggYW4gYXN5bmMgY29tcG9uZW50JywgYXN5bmMgKCkgPT4ge1xuICBmdW5jdGlvbiBEZWZlcnJlZENvbXBvbmVudChwcm9wczoge2ZvbzogJ2Zvbyd9KSB7XG4gICAgcmV0dXJuIDxkaXY+TG9hZGVkPC9kaXY+O1xuICB9XG4gIGZ1bmN0aW9uIExvYWRpbmdDb21wb25lbnQoKSB7XG4gICAgcmV0dXJuIDxkaXY+TG9hZGluZzwvZGl2PjtcbiAgfVxuICBmdW5jdGlvbiBFcnJvckNvbXBvbmVudCgpIHtcbiAgICByZXR1cm4gPGRpdj5GYWlsZWQ8L2Rpdj47XG4gIH1cblxuICBjb25zdCBUb1Rlc3QgPSBzcGxpdCh7XG4gICAgZGVmZXI6IGZhbHNlLFxuICAgIGxvYWQ6ICgpID0+IChQcm9taXNlLnJlc29sdmUoe2RlZmF1bHQ6IERlZmVycmVkQ29tcG9uZW50fSk6IGFueSksXG4gICAgTG9hZGluZ0NvbXBvbmVudCxcbiAgICBFcnJvckNvbXBvbmVudCxcbiAgfSk7XG5cbiAgY29uc3QgYXBwID0gKFxuICAgIDxQcm92aWRlcj5cbiAgICAgIDxUb1Rlc3QgZm9vPVwiZm9vXCIgLz5cbiAgICA8L1Byb3ZpZGVyPlxuICApO1xuXG4gIGV4cGVjdCgvTG9hZGluZy8udGVzdChyZW5kZXJUb1N0cmluZyhhcHApKSkudG9CZVRydXRoeSgpO1xuXG4gIGF3YWl0IHByZXBhcmUoYXBwKTtcblxuICBleHBlY3QoL0xvYWRlZC8udGVzdChyZW5kZXJUb1N0cmluZyhhcHApKSkudG9CZVRydXRoeSgpO1xuICB0cnkge1xuICAgIGF3YWl0IHByZXBhcmUoYXBwKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGV4cGVjdChlKS50b0JlRmFsc3koKTtcbiAgfVxufSk7XG5cbnRlc3QoJ1ByZXBhcmluZyBhbiBhcHAgd2l0aCBhbiBlcnJvcmVkIGFzeW5jIGNvbXBvbmVudCcsIGFzeW5jICgpID0+IHtcbiAgZnVuY3Rpb24gTG9hZGluZ0NvbXBvbmVudCgpIHtcbiAgICByZXR1cm4gPGRpdj5Mb2FkaW5nPC9kaXY+O1xuICB9XG4gIGZ1bmN0aW9uIEVycm9yQ29tcG9uZW50KCkge1xuICAgIHJldHVybiA8ZGl2PkZhaWxlZDwvZGl2PjtcbiAgfVxuXG4gIGNvbnN0IFRvVGVzdCA9IHNwbGl0KHtcbiAgICBkZWZlcjogZmFsc2UsXG4gICAgbG9hZDogKCkgPT4gKFByb21pc2UucmVqZWN0KG5ldyBFcnJvcignZmFpbGVkJykpOiBhbnkpLFxuICAgIExvYWRpbmdDb21wb25lbnQsXG4gICAgRXJyb3JDb21wb25lbnQsXG4gIH0pO1xuXG4gIGNvbnN0IGFwcCA9IChcbiAgICA8UHJvdmlkZXI+XG4gICAgICA8VG9UZXN0IC8+XG4gICAgPC9Qcm92aWRlcj5cbiAgKTtcblxuICBleHBlY3QoL0xvYWRpbmcvLnRlc3QocmVuZGVyVG9TdHJpbmcoYXBwKSkpLnRvQmVUcnV0aHkoKTtcbiAgYXdhaXQgcHJlcGFyZShhcHApO1xuICBleHBlY3QoL0ZhaWxlZC8udGVzdChyZW5kZXJUb1N0cmluZyhhcHApKSkudG9CZVRydXRoeSgpO1xufSk7XG4iXX0=