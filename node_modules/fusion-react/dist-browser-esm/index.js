/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */

/* eslint-env browser */
import * as React from 'react';
import FusionApp, { createToken, createPlugin, CriticalChunkIdsToken } from 'fusion-core';
import { prepare } from './async/index.js';
import PrepareProvider from './async/prepare-provider';
import clientRender from './client';
import ProviderPlugin from './plugin';
import ProvidedHOC from './hoc';
import Provider from './provider';
import { FusionContext, ServiceConsumer, ServiceContext, useService, withServices } from './context.js';
export const SkipPrepareToken = createToken('SkipPrepareToken');
export default class App extends FusionApp {
  constructor(root, render) {
    if (!React.isValidElement(root)) {
      throw new Error('Invalid React element. Ensure your root element is a React.Element (e.g. <Foo />) and not a React.Component (e.g. Foo)');
    }

    const getService = token => {
      // $FlowFixMe
      const provides = this.getService(token);
      const isRequiredToken = Boolean(token.optional);

      if (typeof provides === 'undefined' && isRequiredToken) {
        throw new Error(`Token ${token.name} not registered or registered plugin does not provide a service. To use an optional plugin, use \`Token.optional\`.`);
      }

      return provides;
    };

    const renderer = createPlugin({
      deps: {
        criticalChunkIds: CriticalChunkIdsToken.optional,
        skipPrepare: SkipPrepareToken.optional
      },

      provides({
        skipPrepare
      }) {
        return (el, ctx) => {
          return (skipPrepare ? Promise.resolve() : prepare(el)).then(() => {
            if (render) {
              return render(el, ctx);
            }

            if (false) {
              return serverRender(el);
            } else {
              return clientRender(el);
            }
          });
        };
      },

      middleware({
        criticalChunkIds
      }) {
        return (ctx, next) => {
          if (false && !ctx.element) {
            return next();
          }

          const markAsCritical = false ? chunkId => {
            // Push to legacy context for backwards compat w/ legacy SSR template
            ctx.preloadChunks.push(chunkId); // Also use new service if registered

            if (criticalChunkIds) {
              let chunkIds = criticalChunkIds.from(ctx);
              chunkIds.add(chunkId);
            }
          } : noop;
          ctx.element = React.createElement(PrepareProvider, {
            markAsCritical: markAsCritical
          }, React.createElement(FusionContext.Provider, {
            value: ctx
          }, React.createElement(ServiceContext.Provider, {
            value: getService
          }, ctx.element)));
          return next();
        };
      }

    });
    super(root, renderer);
  }

}
export { FusionContext, ProviderPlugin, ProvidedHOC, Provider, ServiceConsumer, ServiceContext, useService, withServices };

function noop() {}

export * from './async/index.js';
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIlJlYWN0IiwiRnVzaW9uQXBwIiwiY3JlYXRlVG9rZW4iLCJjcmVhdGVQbHVnaW4iLCJDcml0aWNhbENodW5rSWRzVG9rZW4iLCJwcmVwYXJlIiwiUHJlcGFyZVByb3ZpZGVyIiwiY2xpZW50UmVuZGVyIiwiUHJvdmlkZXJQbHVnaW4iLCJQcm92aWRlZEhPQyIsIlByb3ZpZGVyIiwiRnVzaW9uQ29udGV4dCIsIlNlcnZpY2VDb25zdW1lciIsIlNlcnZpY2VDb250ZXh0IiwidXNlU2VydmljZSIsIndpdGhTZXJ2aWNlcyIsIlNraXBQcmVwYXJlVG9rZW4iLCJBcHAiLCJjb25zdHJ1Y3RvciIsInJvb3QiLCJyZW5kZXIiLCJpc1ZhbGlkRWxlbWVudCIsIkVycm9yIiwiZ2V0U2VydmljZSIsInRva2VuIiwicHJvdmlkZXMiLCJpc1JlcXVpcmVkVG9rZW4iLCJCb29sZWFuIiwib3B0aW9uYWwiLCJuYW1lIiwicmVuZGVyZXIiLCJkZXBzIiwiY3JpdGljYWxDaHVua0lkcyIsInNraXBQcmVwYXJlIiwiZWwiLCJjdHgiLCJQcm9taXNlIiwicmVzb2x2ZSIsInRoZW4iLCJzZXJ2ZXJSZW5kZXIiLCJtaWRkbGV3YXJlIiwibmV4dCIsImVsZW1lbnQiLCJtYXJrQXNDcml0aWNhbCIsImNodW5rSWQiLCJwcmVsb2FkQ2h1bmtzIiwicHVzaCIsImNodW5rSWRzIiwiZnJvbSIsImFkZCIsIm5vb3AiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7OztBQVFBO0FBQ0EsT0FBTyxLQUFLQSxLQUFaLE1BQXVCLE9BQXZCO0FBRUEsT0FBT0MsU0FBUCxJQUNFQyxXQURGLEVBRUVDLFlBRkYsRUFHRUMscUJBSEYsUUFLTyxhQUxQO0FBTUEsU0FBUUMsT0FBUixRQUFzQixrQkFBdEI7QUFDQSxPQUFPQyxlQUFQLE1BQTRCLDBCQUE1QjtBQUdBLE9BQU9DLFlBQVAsTUFBeUIsVUFBekI7QUFFQSxPQUFPQyxjQUFQLE1BQTJCLFVBQTNCO0FBQ0EsT0FB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QixZQUFBLEtBQUssRUFBRVo7QUFBaEMsYUFDR1ksR0FBRyxDQUFDTyxPQURQLENBREYsQ0FERixDQURGO0FBU0EsaUJBQU9ELElBQUksRUFBWDtBQUNELFNBM0JEO0FBNEJEOztBQWhEMkIsS0FBRCxDQUE3QjtBQWtEQSxVQUFNdEIsSUFBTixFQUFZVyxRQUFaO0FBQ0Q7O0FBckV3QztBQXdFM0MsU0FDRW5CLGFBREYsRUFFRUgsY0FGRixFQUdFQyxXQUhGLEVBSUVDLFFBSkYsRUFLRUUsZUFMRixFQU1FQyxjQU5GLEVBT0VDLFVBUEYsRUFRRUMsWUFSRjs7QUFXQSxTQUFTbUMsSUFBVCxHQUFnQixDQUFFOztBQUVsQixjQUFjLGtCQUFkIiwic291cmNlc0NvbnRlbnQiOlsiLyoqIENvcHlyaWdodCAoYykgMjAxOCBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBmbG93XG4gKi9cblxuLyogZXNsaW50LWVudiBicm93c2VyICovXG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCBGdXNpb25BcHAsIHtcbiAgY3JlYXRlVG9rZW4sXG4gIGNyZWF0ZVBsdWdpbixcbiAgQ3JpdGljYWxDaHVua0lkc1Rva2VuLFxuICB0eXBlIENvbnRleHQsXG59IGZyb20gJ2Z1c2lvbi1jb3JlJztcbmltcG9ydCB7cHJlcGFyZX0gZnJvbSAnLi9hc3luYy9pbmRleC5qcyc7XG5pbXBvcnQgUHJlcGFyZVByb3ZpZGVyIGZyb20gJy4vYXN5bmMvcHJlcGFyZS1wcm92aWRlcic7XG5cbmltcG9ydCBzZXJ2ZXJSZW5kZXIgZnJvbSAnLi9zZXJ2ZXInO1xuaW1wb3J0IGNsaWVudFJlbmRlciBmcm9tICcuL2NsaWVudCc7XG5cbmltcG9ydCBQcm92aWRlclBsdWdpbiBmcm9tICcuL3BsdWdpbic7XG5pbXBvcnQgUHJvdmlkZWRIT0MgZnJvbSAnLi9ob2MnO1xuaW1wb3J0IFByb3ZpZGVyIGZyb20gJy4vcHJvdmlkZXInO1xuXG5pbXBvcnQge1xuICBGdXNpb25Db250ZXh0LFxuICBTZXJ2aWNlQ29uc3VtZXIsXG4gIFNlcnZpY2VDb250ZXh0LFxuICB1c2VTZXJ2aWNlLFxuICB3aXRoU2VydmljZXMsXG59IGZyb20gJy4vY29udGV4dC5qcyc7XG5cbmV4cG9ydCBjb25zdCBTa2lwUHJlcGFyZVRva2VuID0gY3JlYXRlVG9rZW48Ym9vbGVhbj4oJ1NraXBQcmVwYXJlVG9rZW4nKTtcblxuZXhwb3J0IHR5cGUgUmVuZGVyID0gKGVsOiBSZWFjdC5FbGVtZW50PCo+LCBjb250ZXh0OiBDb250ZXh0KSA9PiBhbnk7XG5cbmRlY2xhcmUgdmFyIF9fTk9ERV9fOiBCb29sZWFuO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBcHAgZXh0ZW5kcyBGdXNpb25BcHAge1xuICBjb25zdHJ1Y3Rvcihyb290OiBSZWFjdC5FbGVtZW50PCo+LCByZW5kZXI6ID9SZW5kZXIpIHtcbiAgICBpZiAoIVJlYWN0LmlzVmFsaWRFbGVtZW50KHJvb3QpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdJbnZhbGlkIFJlYWN0IGVsZW1lbnQuIEVuc3VyZSB5b3VyIHJvb3QgZWxlbWVudCBpcyBhIFJlYWN0LkVsZW1lbnQgKGUuZy4gPEZvbyAvPikgYW5kIG5vdCBhIFJlYWN0LkNvbXBvbmVudCAoZS5nLiBGb28pJ1xuICAgICAgKTtcbiAgICB9XG4gICAgY29uc3QgZ2V0U2VydmljZSA9IHRva2VuID0+IHtcbiAgICAgIC8vICRGbG93Rml4TWVcbiAgICAgIGNvbnN0IHByb3ZpZGVzID0gdGhpcy5nZXRTZXJ2aWNlKHRva2VuKTtcbiAgICAgIGNvbnN0IGlzUmVxdWlyZWRUb2tlbiA9IEJvb2xlYW4odG9rZW4ub3B0aW9uYWwpO1xuICAgICAgaWYgKHR5cGVvZiBwcm92aWRlcyA9PT0gJ3VuZGVmaW5lZCcgJiYgaXNSZXF1aXJlZFRva2VuKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVG9rZW4gJHt0b2tlbi5uYW1lfSBub3QgcmVnaXN0ZXJlZCBvciByZWdpc3RlcmVkIHBsdWdpbiBkb2VzIG5vdCBwcm92aWRlIGEgc2VydmljZS4gVG8gdXNlIGFuIG9wdGlvbmFsIHBsdWdpbiwgdXNlIFxcYFRva2VuLm9wdGlvbmFsXFxgLmBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBwcm92aWRlcztcbiAgICB9O1xuICAgIGNvbnN0IHJlbmRlcmVyID0gY3JlYXRlUGx1Z2luKHtcbiAgICAgIGRlcHM6IHtcbiAgICAgICAgY3JpdGljYWxDaHVua0lkczogQ3JpdGljYWxDaHVua0lkc1Rva2VuLm9wdGlvbmFsLFxuICAgICAgICBza2lwUHJlcGFyZTogU2tpcFByZXBhcmVUb2tlbi5vcHRpb25hbCxcbiAgICAgIH0sXG4gICAgICBwcm92aWRlcyh7c2tpcFByZXBhcmV9KSB7XG4gICAgICAgIHJldHVybiAoZWw6IFJlYWN0LkVsZW1lbnQ8Kj4sIGN0eCkgPT4ge1xuICAgICAgICAgIHJldHVybiAoc2tpcFByZXBhcmUgPyBQcm9taXNlLnJlc29sdmUoKSA6IHByZXBhcmUoZWwpKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIGlmIChyZW5kZXIpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlbmRlcihlbCwgY3R4KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChfX05PREVfXykge1xuICAgICAgICAgICAgICByZXR1cm4gc2VydmVyUmVuZGVyKGVsKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiBjbGllbnRSZW5kZXIoZWwpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgfSxcbiAgICAgIG1pZGRsZXdhcmUoe2NyaXRpY2FsQ2h1bmtJZHN9KSB7XG4gICAgICAgIHJldHVybiAoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgICAgaWYgKF9fTk9ERV9fICYmICFjdHguZWxlbWVudCkge1xuICAgICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBtYXJrQXNDcml0aWNhbCA9IF9fTk9ERV9fXG4gICAgICAgICAgICA/IGNodW5rSWQgPT4ge1xuICAgICAgICAgICAgICAgIC8vIFB1c2ggdG8gbGVnYWN5IGNvbnRleHQgZm9yIGJhY2t3YXJkcyBjb21wYXQgdy8gbGVnYWN5IFNTUiB0ZW1wbGF0ZVxuICAgICAgICAgICAgICAgIGN0eC5wcmVsb2FkQ2h1bmtzLnB1c2goY2h1bmtJZCk7XG5cbiAgICAgICAgICAgICAgICAvLyBBbHNvIHVzZSBuZXcgc2VydmljZSBpZiByZWdpc3RlcmVkXG4gICAgICAgICAgICAgICAgaWYgKGNyaXRpY2FsQ2h1bmtJZHMpIHtcbiAgICAgICAgICAgICAgICAgIGxldCBjaHVua0lkcyA9IGNyaXRpY2FsQ2h1bmtJZHMuZnJvbShjdHgpO1xuICAgICAgICAgICAgICAgICAgY2h1bmtJZHMuYWRkKGNodW5rSWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgOiBub29wO1xuICAgICAgICAgIGN0eC5lbGVtZW50ID0gKFxuICAgICAgICAgICAgPFByZXBhcmVQcm92aWRlciBtYXJrQXNDcml0aWNhbD17bWFya0FzQ3JpdGljYWx9PlxuICAgICAgICAgICAgICA8RnVzaW9uQ29udGV4dC5Qcm92aWRlciB2YWx1ZT17Y3R4fT5cbiAgICAgICAgICAgICAgICA8U2VydmljZUNvbnRleHQuUHJvdmlkZXIgdmFsdWU9e2dldFNlcnZpY2V9PlxuICAgICAgICAgICAgICAgICAge2N0eC5lbGVtZW50fVxuICAgICAgICAgICAgICAgIDwvU2VydmljZUNvbnRleHQuUHJvdmlkZXI+XG4gICAgICAgICAgICAgIDwvRnVzaW9uQ29udGV4dC5Qcm92aWRlcj5cbiAgICAgICAgICAgIDwvUHJlcGFyZVByb3ZpZGVyPlxuICAgICAgICAgICk7XG4gICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgfTtcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgc3VwZXIocm9vdCwgcmVuZGVyZXIpO1xuICB9XG59XG5cbmV4cG9ydCB7XG4gIEZ1c2lvbkNvbnRleHQsXG4gIFByb3ZpZGVyUGx1Z2luLFxuICBQcm92aWRlZEhPQyxcbiAgUHJvdmlkZXIsXG4gIFNlcnZpY2VDb25zdW1lcixcbiAgU2VydmljZUNvbnRleHQsXG4gIHVzZVNlcnZpY2UsXG4gIHdpdGhTZXJ2aWNlcyxcbn07XG5cbmZ1bmN0aW9uIG5vb3AoKSB7fVxuXG5leHBvcnQgKiBmcm9tICcuL2FzeW5jL2luZGV4LmpzJztcbiJdfQ==