/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */
import * as React from 'react';
import { Router as DefaultProvider } from 'react-router-dom';
import { createBrowserHistory } from 'history';
import { UniversalEventsToken } from 'fusion-plugin-universal-events';
import { createPlugin, createToken, unescape, memoize, RouteTagsToken } from 'fusion-core';
import { Router as BrowserRouter } from './browser.js';
import { jsx as _jsx } from "react/jsx-runtime";
export const GetStaticContextToken = createToken('GetStaticContext');
export const RouterProviderToken = createToken('RouterProvider');
export const RouterToken = createToken('Router');
const Router = false ? ServerRouter : BrowserRouter;
// Preserve browser history instance across HMR
let browserHistory;
let noMatchingRoute = 'no-matching-route';
const plugin = createPlugin({
  deps: {
    emitter: UniversalEventsToken.optional,
    Provider: RouterProviderToken.optional,
    getStaticContext: GetStaticContextToken.optional,
    RouteTags: RouteTagsToken
  },
  middleware: ({
    RouteTags,
    emitter,
    Provider = DefaultProvider,
    getStaticContext
  }, self) => {
    return async (ctx, next) => {
      const tags = RouteTags.from(ctx);
      const prefix = ctx.prefix || '';

      if (!ctx.element) {
        return next();
      }

      const myAPI = self.from(ctx);

      if (false) {
        let pageData = {
          title: ctx.path,
          page: ctx.path
        };
        const context = getStaticContext ? getStaticContext(ctx) : {
          action: null,
          location: null,

          set status(code) {
            ctx.status = code;
          },

          set url(url) {
            const toUrl = addRoutePrefix(url, prefix);

            if (typeof toUrl === 'string') {
              ctx.redirect(toUrl);
            }
          }

        }; // Expose the history object

        const history = createServerHistory(prefix, context, prefix + ctx.url);
        myAPI.history = history;
        ctx.element = /*#__PURE__*/_jsx(Router, {
          history: history,
          Provider: Provider,
          onRoute: d => {
            pageData = d;
            tags.name = pageData.title;
            tags.page = pageData.page;
            pageData.routeMatched = true;
          },
          basename: prefix,
          context: context,
          children: ctx.element
        });
        return next().then(() => {
          ctx.template.body.push(html`
              <script id="__ROUTER_DATA__" type="application/json">
                ${JSON.stringify(pageData)}
              </script>
            `);

          if (emitter) {
            const scopedEmitter = emitter.from(ctx);

            const emitTiming = type => timing => {
              scopedEmitter.emit(type, {
                title: pageData.routeMatched ? pageData.title : noMatchingRoute,
                page: pageData.page,
                status: ctx.status,
                timing
              });
            };

            scopedEmitter.map(payload => {
              if (payload && typeof payload === 'object') {
                if (pageData.routeMatched) {
                  payload.__url__ = pageData.title;
                  payload.__urlParams__ = pageData.params;
                } else {
                  payload.__url__ = noMatchingRoute;
                  payload.__urlParams__ = {};
                }
              }

              return payload;
            });
            ctx.timing.end.then(timing => {
              emitTiming('pageview:server')(timing);
              ctx.timing.render.then(emitTiming('render:server'));
            });
          }
        });
      } else if (true) {
        // TODO(#3): We should consider adding render/downstream/upstream timings for the browser
        let pageData = {};
        const element = document.getElementById('__ROUTER_DATA__');

        if (element) {
          pageData = JSON.parse(unescape(element.textContent));
          tags.name = pageData.title;
          tags.page = pageData.page;
        }

        emitter && emitter.map(payload => {
          if (payload && typeof payload === 'object') {
            if (pageData.routeMatched) {
              payload.__url__ = pageData.title;
              payload.__urlParams__ = pageData.params;
            } else {
              payload.__url__ = noMatchingRoute;
              payload.__urlParams__ = {};
            }
          }

          return payload;
        }); // preserving browser history across hmr fixes warning "Warning: You cannot change <Router history>"
        // we don't want to preserve the `browserHistory` instance across jsdom tests however, as it will cause
        // routes to match based on the previous location information.

        if (!browserHistory || process.env.NODE_ENV !== "production" && typeof window.jsdom !== 'undefined') {
          browserHistory = createBrowserHistory({
            basename: ctx.prefix
          });
        } // Expose the history object


        myAPI.history = browserHistory;
        ctx.element = /*#__PURE__*/_jsx(Router, {
          history: browserHistory,
          Provider: Provider,
          basename: ctx.prefix,
          onRoute: payload => {
            payload.routeMatched = true;
            pageData = payload;
            tags.name = pageData.title;
            tags.page = pageData.page;
            emitter && emitter.emit('pageview:browser', payload);
          },
          children: ctx.element
        });
        return next();
      }
    };
  },

  provides() {
    return {
      from: memoize(() => {
        const api = {
          history: null
        };
        return api;
      })
    };
  }

});
export default plugin;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9wbHVnaW4uanMiXSwibmFtZXMiOlsiUmVhY3QiLCJSb3V0ZXIiLCJEZWZhdWx0UHJvdmlkZXIiLCJjcmVhdGVCcm93c2VySGlzdG9yeSIsIlVuaXZlcnNhbEV2ZW50c1Rva2VuIiwiY3JlYXRlUGx1Z2luIiwiY3JlYXRlVG9rZW4iLCJ1bmVzY2FwZSIsIm1lbW9pemUiLCJSb3V0ZVRhZ3NUb2tlbiIsIkJyb3dzZXJSb3V0ZXIiLCJHZXRTdGF0aWNDb250ZXh0VG9rZW4iLCJSb3V0ZXJQcm92aWRlclRva2VuIiwiUm91dGVyVG9rZW4iLCJTZXJ2ZXJSb3V0ZXIiLCJicm93c2VySGlzdG9yeSIsIm5vTWF0Y2hpbmdSb3V0ZSIsInBsdWdpbiIsImRlcHMiLCJlbWl0dGVyIiwib3B0aW9uYWwiLCJQcm92aWRlciIsImdldFN0YXRpY0NvbnRleHQiLCJSb3V0ZVRhZ3MiLCJtaWRkbGV3YXJlIiwic2VsZiIsImN0eCIsIm5leHQiLCJ0YWdzIiwiZnJvbSIsInByZWZpeCIsImVsZW1lbnQiLCJteUFQSSIsInBhZ2VEYXRhIiwidGl0bGUiLCJwYXRoIiwicGFnZSIsImNvbnRleHQiLCJhY3Rpb24iLCJsb2NhdGlvbiIsInN0YXR1cyIsImNvZGUiLCJ1cmwiLCJ0b1VybCIsImFkZFJvdXRlUHJlZml4IiwicmVkaXJlY3QiLCJoaXN0b3J5IiwiY3JlYXRlU2VydmVySGlzdG9yeSIsImQiLCJuYW1lIiwicm91dGVNYXRjaGVkIiwidGhlbiIsInRlbXBsYXRlIiwiYm9keSIsInB1c2giLCJodG1sIiwiSlNPTiIsInN0cmluZ2lmeSIsInNjb3BlZEVtaXR0ZXIiLCJlbWl0VGltaW5nIiwidHlwZSIsInRpbWluZyIsImVtaXQiLCJtYXAiLCJwYXlsb2FkIiwiX191cmxfXyIsIl9fdXJsUGFyYW1zX18iLCJwYXJhbXMiLCJlbmQiLCJyZW5kZXIiLCJkb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwicGFyc2UiLCJ0ZXh0Q29udGVudCIsIndpbmRvdyIsImpzZG9tIiwi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RUFBRUssR0FBRyxDQUFDSSxNQUhoQjtBQUlFLFVBQUEsT0FBTyxFQUFHa0MsT0FBRCxJQUFhO0FBQ3BCQSxZQUFBQSxPQUFPLENBQUNkLFlBQVIsR0FBdUIsSUFBdkI7QUFDQWpCLFlBQUFBLFFBQVEsR0FBRytCLE9BQVg7QUFDQXBDLFlBQUFBLElBQUksQ0FBQ3FCLElBQUwsR0FBWWhCLFFBQVEsQ0FBQ0MsS0FBckI7QUFDQU4sWUFBQUEsSUFBSSxDQUFDUSxJQUFMLEdBQVlILFFBQVEsQ0FBQ0csSUFBckI7QUFDQWpCLFlBQUFBLE9BQU8sSUFBSUEsT0FBTyxDQUFDMkMsSUFBUixDQUFhLGtCQUFiLEVBQWlDRSxPQUFqQyxDQUFYO0FBQ0QsV0FWSDtBQUFBLG9CQVlHdEMsR0FBRyxDQUFDSztBQVpQLFVBREY7QUFnQkEsZUFBT0osSUFBSSxFQUFYO0FBQ0Q7QUFDRixLQXRJRDtBQXVJRCxHQWxKMkU7O0FBbUo1RWtELEVBQUFBLFFBQVEsR0FBRztBQUNULFdBQU87QUFDTGhELE1BQUFBLElBQUksRUFBRXJCLE9BQU8sQ0FBQyxNQUFNO0FBQ2xCLGNBQU1zRSxHQUFpQyxHQUFJO0FBQ3pDaEMsVUFBQUEsT0FBTyxFQUFFO0FBRGdDLFNBQTNDO0FBR0EsZUFBT2dDLEdBQVA7QUFDRCxPQUxZO0FBRFIsS0FBUDtBQVFEOztBQTVKMkUsQ0FBRCxDQUE3RTtBQStKQSxlQUFlN0QsTUFBZiIsInNvdXJjZXNDb250ZW50IjpbIi8qKiBDb3B5cmlnaHQgKGMpIDIwMTggVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZmxvd1xuICovXG5cbmltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7Um91dGVyIGFzIERlZmF1bHRQcm92aWRlcn0gZnJvbSAncmVhY3Qtcm91dGVyLWRvbSc7XG5pbXBvcnQge2NyZWF0ZUJyb3dzZXJIaXN0b3J5fSBmcm9tICdoaXN0b3J5JztcblxuaW1wb3J0IHtVbml2ZXJzYWxFdmVudHNUb2tlbn0gZnJvbSAnZnVzaW9uLXBsdWdpbi11bml2ZXJzYWwtZXZlbnRzJztcbmltcG9ydCB7XG4gIGNyZWF0ZVBsdWdpbixcbiAgY3JlYXRlVG9rZW4sXG4gIGh0bWwsXG4gIHVuZXNjYXBlLFxuICBtZW1vaXplLFxuICBSb3V0ZVRhZ3NUb2tlbixcbn0gZnJvbSAnZnVzaW9uLWNvcmUnO1xuaW1wb3J0IHR5cGUge1Rva2VuLCBDb250ZXh0LCBGdXNpb25QbHVnaW59IGZyb20gJ2Z1c2lvbi1jb3JlJztcblxuaW1wb3J0IHtSb3V0ZXIgYXMgU2VydmVyUm91dGVyfSBmcm9tICcuL3NlcnZlci5qcyc7XG5pbXBvcnQge1JvdXRlciBhcyBCcm93c2VyUm91dGVyfSBmcm9tICcuL2Jyb3dzZXIuanMnO1xuaW1wb3J0IHtjcmVhdGVTZXJ2ZXJIaXN0b3J5fSBmcm9tICcuL21vZHVsZXMvU2VydmVySGlzdG9yeS5qcyc7XG5cbmltcG9ydCB7YWRkUm91dGVQcmVmaXh9IGZyb20gJy4vbW9kdWxlcy91dGlscy5qcyc7XG5pbXBvcnQgdHlwZSB7Um91dGVySGlzdG9yeVR5cGUsIFN0YXRpY0NvbnRleHRUeXBlfSBmcm9tICcuL3R5cGVzLmpzJztcblxudHlwZSBQcm92aWRlclByb3BzVHlwZSA9IHtcbiAgaGlzdG9yeTogUm91dGVySGlzdG9yeVR5cGUsXG4gIGNoaWxkcmVuPzogUmVhY3QuTm9kZSxcbn07XG5cbnR5cGUgSGlzdG9yeVdyYXBwZXJUeXBlID0ge1xuICBmcm9tOiAoY3R4OiBDb250ZXh0KSA9PiB7XG4gICAgaGlzdG9yeTogUm91dGVySGlzdG9yeVR5cGUsXG4gIH0sXG59O1xuXG5leHBvcnQgY29uc3QgR2V0U3RhdGljQ29udGV4dFRva2VuID1cbiAgY3JlYXRlVG9rZW48KGN0eDogQ29udGV4dCkgPT4gU3RhdGljQ29udGV4dFR5cGU+KCdHZXRTdGF0aWNDb250ZXh0Jyk7XG5cbmV4cG9ydCBjb25zdCBSb3V0ZXJQcm92aWRlclRva2VuOiBUb2tlbjxcbiAgUmVhY3QuQ29tcG9uZW50VHlwZTxQcm92aWRlclByb3BzVHlwZT5cbj4gPSBjcmVhdGVUb2tlbignUm91dGVyUHJvdmlkZXInKTtcblxuZXhwb3J0IGNvbnN0IFJvdXRlclRva2VuOiBUb2tlbjxIaXN0b3J5V3JhcHBlclR5cGU+ID0gY3JlYXRlVG9rZW4oJ1JvdXRlcicpO1xuXG5jb25zdCBSb3V0ZXIgPSBfX05PREVfXyA/IFNlcnZlclJvdXRlciA6IEJyb3dzZXJSb3V0ZXI7XG5cbnR5cGUgUGx1Z2luRGVwc1R5cGUgPSB7XG4gIGdldFN0YXRpY0NvbnRleHQ6IHR5cGVvZiBHZXRTdGF0aWNDb250ZXh0VG9rZW4ub3B0aW9uYWwsXG4gIGVtaXR0ZXI6IHR5cGVvZiBVbml2ZXJzYWxFdmVudHNUb2tlbi5vcHRpb25hbCxcbiAgUHJvdmlkZXI6IHR5cGVvZiBSb3V0ZXJQcm92aWRlclRva2VuLm9wdGlvbmFsLFxuICBSb3V0ZVRhZ3M6IHR5cGVvZiBSb3V0ZVRhZ3NUb2tlbixcbn07XG5cbi8vIFByZXNlcnZlIGJyb3dzZXIgaGlzdG9yeSBpbnN0YW5jZSBhY3Jvc3MgSE1SXG5sZXQgYnJvd3Nlckhpc3Rvcnk7XG5sZXQgbm9NYXRjaGluZ1JvdXRlID0gJ25vLW1hdGNoaW5nLXJvdXRlJztcblxuY29uc3QgcGx1Z2luOiBGdXNpb25QbHVnaW48UGx1Z2luRGVwc1R5cGUsIEhpc3RvcnlXcmFwcGVyVHlwZT4gPSBjcmVhdGVQbHVnaW4oe1xuICBkZXBzOiB7XG4gICAgZW1pdHRlcjogVW5pdmVyc2FsRXZlbnRzVG9rZW4ub3B0aW9uYWwsXG4gICAgUHJvdmlkZXI6IFJvdXRlclByb3ZpZGVyVG9rZW4ub3B0aW9uYWwsXG4gICAgZ2V0U3RhdGljQ29udGV4dDogR2V0U3RhdGljQ29udGV4dFRva2VuLm9wdGlvbmFsLFxuICAgIFJvdXRlVGFnczogUm91dGVUYWdzVG9rZW4sXG4gIH0sXG4gIG1pZGRsZXdhcmU6IChcbiAgICB7Um91dGVUYWdzLCBlbWl0dGVyLCBQcm92aWRlciA9IERlZmF1bHRQcm92aWRlciwgZ2V0U3RhdGljQ29udGV4dH0sXG4gICAgc2VsZlxuICApID0+IHtcbiAgICByZXR1cm4gYXN5bmMgKGN0eCwgbmV4dCkgPT4ge1xuICAgICAgY29uc3QgdGFncyA9IFJvdXRlVGFncy5mcm9tKGN0eCk7XG4gICAgICBjb25zdCBwcmVmaXggPSBjdHgucHJlZml4IHx8ICcnO1xuICAgICAgaWYgKCFjdHguZWxlbWVudCkge1xuICAgICAgICByZXR1cm4gbmV4dCgpO1xuICAgICAgfVxuICAgICAgY29uc3QgbXlBUEkgPSBzZWxmLmZyb20oY3R4KTtcbiAgICAgIGlmIChfX05PREVfXykge1xuICAgICAgICBsZXQgcGFnZURhdGEgPSB7XG4gICAgICAgICAgdGl0bGU6IGN0eC5wYXRoLFxuICAgICAgICAgIHBhZ2U6IGN0eC5wYXRoLFxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBjb250ZXh0ID0gZ2V0U3RhdGljQ29udGV4dFxuICAgICAgICAgID8gZ2V0U3RhdGljQ29udGV4dChjdHgpXG4gICAgICAgICAgOiB7XG4gICAgICAgICAgICAgIGFjdGlvbjogbnVsbCxcbiAgICAgICAgICAgICAgbG9jYXRpb246IG51bGwsXG4gICAgICAgICAgICAgIHNldCBzdGF0dXMoY29kZTogbnVtYmVyKSB7XG4gICAgICAgICAgICAgICAgY3R4LnN0YXR1cyA9IGNvZGU7XG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIHNldCB1cmwodXJsOiBzdHJpbmcpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB0b1VybCA9IGFkZFJvdXRlUHJlZml4KHVybCwgcHJlZml4KTtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRvVXJsID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgY3R4LnJlZGlyZWN0KHRvVXJsKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9O1xuICAgICAgICAvLyBFeHBvc2UgdGhlIGhpc3Rvcnkgb2JqZWN0XG4gICAgICAgIGNvbnN0IGhpc3RvcnkgPSBjcmVhdGVTZXJ2ZXJIaXN0b3J5KHByZWZpeCwgY29udGV4dCwgcHJlZml4ICsgY3R4LnVybCk7XG4gICAgICAgIG15QVBJLmhpc3RvcnkgPSBoaXN0b3J5O1xuICAgICAgICBjdHguZWxlbWVudCA9IChcbiAgICAgICAgICA8Um91dGVyXG4gICAgICAgICAgICBoaXN0b3J5PXtoaXN0b3J5fVxuICAgICAgICAgICAgUHJvdmlkZXI9e1Byb3ZpZGVyfVxuICAgICAgICAgICAgb25Sb3V0ZT17KGQpID0+IHtcbiAgICAgICAgICAgICAgcGFnZURhdGEgPSBkO1xuICAgICAgICAgICAgICB0YWdzLm5hbWUgPSBwYWdlRGF0YS50aXRsZTtcbiAgICAgICAgICAgICAgdGFncy5wYWdlID0gcGFnZURhdGEucGFnZTtcbiAgICAgICAgICAgICAgcGFnZURhdGEucm91dGVNYXRjaGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIH19XG4gICAgICAgICAgICBiYXNlbmFtZT17cHJlZml4fVxuICAgICAgICAgICAgY29udGV4dD17Y29udGV4dH1cbiAgICAgICAgICA+XG4gICAgICAgICAgICB7Y3R4LmVsZW1lbnR9XG4gICAgICAgICAgPC9Sb3V0ZXI+XG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiBuZXh0KCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgY3R4LnRlbXBsYXRlLmJvZHkucHVzaChcbiAgICAgICAgICAgIGh0bWxgXG4gICAgICAgICAgICAgIDxzY3JpcHQgaWQ9XCJfX1JPVVRFUl9EQVRBX19cIiB0eXBlPVwiYXBwbGljYXRpb24vanNvblwiPlxuICAgICAgICAgICAgICAgICR7SlNPTi5zdHJpbmdpZnkocGFnZURhdGEpfVxuICAgICAgICAgICAgICA8L3NjcmlwdD5cbiAgICAgICAgICAgIGBcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgaWYgKGVtaXR0ZXIpIHtcbiAgICAgICAgICAgIGNvbnN0IHNjb3BlZEVtaXR0ZXIgPSBlbWl0dGVyLmZyb20oY3R4KTtcbiAgICAgICAgICAgIGNvbnN0IGVtaXRUaW1pbmcgPSAodHlwZSkgPT4gKHRpbWluZykgPT4ge1xuICAgICAgICAgICAgICBzY29wZWRFbWl0dGVyLmVtaXQodHlwZSwge1xuICAgICAgICAgICAgICAgIHRpdGxlOiBwYWdlRGF0YS5yb3V0ZU1hdGNoZWQgPyBwYWdlRGF0YS50aXRsZSA6IG5vTWF0Y2hpbmdSb3V0ZSxcbiAgICAgICAgICAgICAgICBwYWdlOiBwYWdlRGF0YS5wYWdlLFxuICAgICAgICAgICAgICAgIHN0YXR1czogY3R4LnN0YXR1cyxcbiAgICAgICAgICAgICAgICB0aW1pbmcsXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHNjb3BlZEVtaXR0ZXIubWFwKChwYXlsb2FkKSA9PiB7XG4gICAgICAgICAgICAgIGlmIChwYXlsb2FkICYmIHR5cGVvZiBwYXlsb2FkID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgIGlmIChwYWdlRGF0YS5yb3V0ZU1hdGNoZWQpIHtcbiAgICAgICAgICAgICAgICAgIHBheWxvYWQuX191cmxfXyA9IHBhZ2VEYXRhLnRpdGxlO1xuICAgICAgICAgICAgICAgICAgcGF5bG9hZC5fX3VybFBhcmFtc19fID0gcGFnZURhdGEucGFyYW1zO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICBwYXlsb2FkLl9fdXJsX18gPSBub01hdGNoaW5nUm91dGU7XG4gICAgICAgICAgICAgICAgICBwYXlsb2FkLl9fdXJsUGFyYW1zX18gPSB7fTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgcmV0dXJuIHBheWxvYWQ7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGN0eC50aW1pbmcuZW5kLnRoZW4oKHRpbWluZykgPT4ge1xuICAgICAgICAgICAgICBlbWl0VGltaW5nKCdwYWdldmlldzpzZXJ2ZXInKSh0aW1pbmcpO1xuICAgICAgICAgICAgICBjdHgudGltaW5nLnJlbmRlci50aGVuKGVtaXRUaW1pbmcoJ3JlbmRlcjpzZXJ2ZXInKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmIChfX0JST1dTRVJfXykge1xuICAgICAgICAvLyBUT0RPKCMzKTogV2Ugc2hvdWxkIGNvbnNpZGVyIGFkZGluZyByZW5kZXIvZG93bnN0cmVhbS91cHN0cmVhbSB0aW1pbmdzIGZvciB0aGUgYnJvd3NlclxuICAgICAgICBsZXQgcGFnZURhdGEgPSB7fTtcbiAgICAgICAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdfX1JPVVRFUl9EQVRBX18nKTtcbiAgICAgICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgICAgICBwYWdlRGF0YSA9IEpTT04ucGFyc2UodW5lc2NhcGUoZWxlbWVudC50ZXh0Q29udGVudCkpO1xuICAgICAgICAgIHRhZ3MubmFtZSA9IHBhZ2VEYXRhLnRpdGxlO1xuICAgICAgICAgIHRhZ3MucGFnZSA9IHBhZ2VEYXRhLnBhZ2U7XG4gICAgICAgIH1cbiAgICAgICAgZW1pdHRlciAmJlxuICAgICAgICAgIGVtaXR0ZXIubWFwKChwYXlsb2FkKSA9PiB7XG4gICAgICAgICAgICBpZiAocGF5bG9hZCAmJiB0eXBlb2YgcGF5bG9hZCA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgICAgaWYgKHBhZ2VEYXRhLnJvdXRlTWF0Y2hlZCkge1xuICAgICAgICAgICAgICAgIHBheWxvYWQuX191cmxfXyA9IHBhZ2VEYXRhLnRpdGxlO1xuICAgICAgICAgICAgICAgIHBheWxvYWQuX191cmxQYXJhbXNfXyA9IHBhZ2VEYXRhLnBhcmFtcztcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBwYXlsb2FkLl9fdXJsX18gPSBub01hdGNoaW5nUm91dGU7XG4gICAgICAgICAgICAgICAgcGF5bG9hZC5fX3VybFBhcmFtc19fID0ge307XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBwYXlsb2FkO1xuICAgICAgICAgIH0pO1xuICAgICAgICAvLyBwcmVzZXJ2aW5nIGJyb3dzZXIgaGlzdG9yeSBhY3Jvc3MgaG1yIGZpeGVzIHdhcm5pbmcgXCJXYXJuaW5nOiBZb3UgY2Fubm90IGNoYW5nZSA8Um91dGVyIGhpc3Rvcnk+XCJcbiAgICAgICAgLy8gd2UgZG9uJ3Qgd2FudCB0byBwcmVzZXJ2ZSB0aGUgYGJyb3dzZXJIaXN0b3J5YCBpbnN0YW5jZSBhY3Jvc3MganNkb20gdGVzdHMgaG93ZXZlciwgYXMgaXQgd2lsbCBjYXVzZVxuICAgICAgICAvLyByb3V0ZXMgdG8gbWF0Y2ggYmFzZWQgb24gdGhlIHByZXZpb3VzIGxvY2F0aW9uIGluZm9ybWF0aW9uLlxuICAgICAgICBpZiAoXG4gICAgICAgICAgIWJyb3dzZXJIaXN0b3J5IHx8XG4gICAgICAgICAgKF9fREVWX18gJiYgdHlwZW9mIHdpbmRvdy5qc2RvbSAhPT0gJ3VuZGVmaW5lZCcpXG4gICAgICAgICkge1xuICAgICAgICAgIGJyb3dzZXJIaXN0b3J5ID0gY3JlYXRlQnJvd3Nlckhpc3Rvcnkoe2Jhc2VuYW1lOiBjdHgucHJlZml4fSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gRXhwb3NlIHRoZSBoaXN0b3J5IG9iamVjdFxuICAgICAgICBteUFQSS5oaXN0b3J5ID0gYnJvd3Nlckhpc3Rvcnk7XG4gICAgICAgIGN0eC5lbGVtZW50ID0gKFxuICAgICAgICAgIDxSb3V0ZXJcbiAgICAgICAgICAgIGhpc3Rvcnk9e2Jyb3dzZXJIaXN0b3J5fVxuICAgICAgICAgICAgUHJvdmlkZXI9e1Byb3ZpZGVyfVxuICAgICAgICAgICAgYmFzZW5hbWU9e2N0eC5wcmVmaXh9XG4gICAgICAgICAgICBvblJvdXRlPXsocGF5bG9hZCkgPT4ge1xuICAgICAgICAgICAgICBwYXlsb2FkLnJvdXRlTWF0Y2hlZCA9IHRydWU7XG4gICAgICAgICAgICAgIHBhZ2VEYXRhID0gcGF5bG9hZDtcbiAgICAgICAgICAgICAgdGFncy5uYW1lID0gcGFnZURhdGEudGl0bGU7XG4gICAgICAgICAgICAgIHRhZ3MucGFnZSA9IHBhZ2VEYXRhLnBhZ2U7XG4gICAgICAgICAgICAgIGVtaXR0ZXIgJiYgZW1pdHRlci5lbWl0KCdwYWdldmlldzpicm93c2VyJywgcGF5bG9hZCk7XG4gICAgICAgICAgICB9fVxuICAgICAgICAgID5cbiAgICAgICAgICAgIHtjdHguZWxlbWVudH1cbiAgICAgICAgICA8L1JvdXRlcj5cbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgIH1cbiAgICB9O1xuICB9LFxuICBwcm92aWRlcygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgZnJvbTogbWVtb2l6ZSgoKSA9PiB7XG4gICAgICAgIGNvbnN0IGFwaToge2hpc3Rvcnk6IFJvdXRlckhpc3RvcnlUeXBlfSA9ICh7XG4gICAgICAgICAgaGlzdG9yeTogbnVsbCxcbiAgICAgICAgfTogYW55KTtcbiAgICAgICAgcmV0dXJuIGFwaTtcbiAgICAgIH0pLFxuICAgIH07XG4gIH0sXG59KTtcblxuZXhwb3J0IGRlZmF1bHQgcGx1Z2luO1xuIl19