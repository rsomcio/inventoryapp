"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.RouterToken = exports.RouterProviderToken = exports.GetStaticContextToken = void 0;

var React = _interopRequireWildcard(require("react"));

var _reactRouterDom = require("react-router-dom");

var _fusionPluginUniversalEvents = require("fusion-plugin-universal-events");

var _fusionCore = require("fusion-core");

var _server = require("./server.js");

var _ServerHistory = require("./modules/ServerHistory.js");

var _utils = require("./modules/utils.js");

var _jsxRuntime = require("react/jsx-runtime");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */
const GetStaticContextToken = (0, _fusionCore.createToken)('GetStaticContext');
exports.GetStaticContextToken = GetStaticContextToken;
const RouterProviderToken = (0, _fusionCore.createToken)('RouterProvider');
exports.RouterProviderToken = RouterProviderToken;
const RouterToken = (0, _fusionCore.createToken)('Router');
exports.RouterToken = RouterToken;
const Router = true ? _server.Router : BrowserRouter;
// Preserve browser history instance across HMR
let browserHistory;
let noMatchingRoute = 'no-matching-route';
const plugin = (0, _fusionCore.createPlugin)({
  deps: {
    emitter: _fusionPluginUniversalEvents.UniversalEventsToken.optional,
    Provider: RouterProviderToken.optional,
    getStaticContext: GetStaticContextToken.optional,
    RouteTags: _fusionCore.RouteTagsToken
  },
  middleware: ({
    RouteTags,
    emitter,
    Provider = _reactRouterDom.Router,
    getStaticContext
  }, self) => {
    return async (ctx, next) => {
      const tags = RouteTags.from(ctx);
      const prefix = ctx.prefix || '';

      if (!ctx.element) {
        return next();
      }

      const myAPI = self.from(ctx);

      if (true) {
        let pageData = {
          title: ctx.path,
          page: ctx.path
        };
        const context = getStaticContext ? getStaticContext(ctx) : {
          action: null,
          location: null,

          set status(code) {
            ctx.status = code;
          },

          set url(url) {
            const toUrl = (0, _utils.addRoutePrefix)(url, prefix);

            if (typeof toUrl === 'string') {
              ctx.redirect(toUrl);
            }
          }

        }; // Expose the history object

        const history = (0, _ServerHistory.createServerHistory)(prefix, context, prefix + ctx.url);
        myAPI.history = history;
        ctx.element = /*#__PURE__*/(0, _jsxRuntime.jsx)(Router, {
          history: history,
          Provider: Provider,
          onRoute: d => {
            pageData = d;
            tags.name = pageData.title;
            tags.page = pageData.page;
            pageData.routeMatched = true;
          },
          basename: prefix,
          context: context,
          children: ctx.element
        });
        return next().then(() => {
          ctx.template.body.push((0, _fusionCore.html)`
              <script id="__ROUTER_DATA__" type="application/json">
                ${JSON.stringify(pageData)}
              </script>
            `);

          if (emitter) {
            const scopedEmitter = emitter.from(ctx);

            const emitTiming = type => timing => {
              scopedEmitter.emit(type, {
                title: pageData.routeMatched ? pageData.title : noMatchingRoute,
                page: pageData.page,
                status: ctx.status,
                timing
              });
            };

            scopedEmitter.map(payload => {
              if (payload && typeof payload === 'object') {
                if (pageData.routeMatched) {
                  payload.__url__ = pageData.title;
                  payload.__urlParams__ = pageData.params;
                } else {
                  payload.__url__ = noMatchingRoute;
                  payload.__urlParams__ = {};
                }
              }

              return payload;
            });
            ctx.timing.end.then(timing => {
              emitTiming('pageview:server')(timing);
              ctx.timing.render.then(emitTiming('render:server'));
            });
          }
        });
      } else if (false) {
        // TODO(#3): We should consider adding render/downstream/upstream timings for the browser
        let pageData = {};
        const element = document.getElementById('__ROUTER_DATA__');

        if (element) {
          pageData = JSON.parse(unescape(element.textContent));
          tags.name = pageData.title;
          tags.page = pageData.page;
        }

        emitter && emitter.map(payload => {
          if (payload && typeof payload === 'object') {
            if (pageData.routeMatched) {
              payload.__url__ = pageData.title;
              payload.__urlParams__ = pageData.params;
            } else {
              payload.__url__ = noMatchingRoute;
              payload.__urlParams__ = {};
            }
          }

          return payload;
        }); // preserving browser history across hmr fixes warning "Warning: You cannot change <Router history>"
        // we don't want to preserve the `browserHistory` instance across jsdom tests however, as it will cause
        // routes to match based on the previous location information.

        if (!browserHistory || process.env.NODE_ENV !== "production" && typeof window.jsdom !== 'undefined') {
          browserHistory = createBrowserHistory({
            basename: ctx.prefix
          });
        } // Expose the history object


        myAPI.history = browserHistory;
        ctx.element = /*#__PURE__*/(0, _jsxRuntime.jsx)(Router, {
          history: browserHistory,
          Provider: Provider,
          basename: ctx.prefix,
          onRoute: payload => {
            payload.routeMatched = true;
            pageData = payload;
            tags.name = pageData.title;
            tags.page = pageData.page;
            emitter && emitter.emit('pageview:browser', payload);
          },
          children: ctx.element
        });
        return next();
      }
    };
  },

  provides() {
    return {
      from: (0, _fusionCore.memoize)(() => {
        const api = {
          history: null
        };
        return api;
      })
    };
  }

});
var _default = plugin;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9wbHVnaW4uanMiXSwibmFtZXMiOlsiR2V0U3RhdGljQ29udGV4dFRva2VuIiwiUm91dGVyUHJvdmlkZXJUb2tlbiIsIlJvdXRlclRva2VuIiwiUm91dGVyIiwiU2VydmVyUm91dGVyIiwiQnJvd3NlclJvdXRlciIsImJyb3dzZXJIaXN0b3J5Iiwibm9NYXRjaGluZ1JvdXRlIiwicGx1Z2luIiwiZGVwcyIsImVtaXR0ZXIiLCJVbml2ZXJzYWxFdmVudHNUb2tlbiIsIm9wdGlvbmFsIiwiUHJvdmlkZXIiLCJnZXRTdGF0aWNDb250ZXh0IiwiUm91dGVUYWdzIiwiUm91dGVUYWdzVG9rZW4iLCJtaWRkbGV3YXJlIiwiRGVmYXVsdFByb3ZpZGVyIiwic2VsZiIsImN0eCIsIm5leHQiLCJ0YWdzIiwiZnJvbSIsInByZWZpeCIsImVsZW1lbnQiLCJteUFQSSIsInBhZ2VEYXRhIiwidGl0bGUiLCJwYXRoIiwicGFnZSIsImNvbnRleHQiLCJhY3Rpb24iLCJsb2NhdGlvbiIsInN0YXR1cyIsImNvZGUiLCJ1cmwiLCJ0b1VybCIsInJlZGlyZWN0IiwiaGlzdG9yeSIsImQiLCJuYW1lIiwicm91dGVNYXRjaGVkIiwidGhlbiIsInRlbXBsYXRlIiwiYm9keSIsInB1c2giLCJKU09OIiwic3RyaW5naWZ5Iiwic2NvcGVkRW1pdHRlciIsImVtaXRUaW1pbmciLCJ0eXBlIiwidGltaW5nIiwiZW1pdCIsIm1hcCIsInBheWxvYWQiLCJfX3VybF9fIiwiX191cmxQYXJhbXNfXyIsInBhcmFtcyIsImVuZCIsInJlbmRlciIsImRvY3VtZW50IiwiZ2V0RWxlbWVudEJ5SWQiLCJwYXJzZSIsInVuZXNjYXBlIiwidGV4dENvbnRlbnQiLCJ3aW5kb3ciLCJqc2RvbSIsImNyZWF0ZUJyb3dzZXJIaXN0b3J5IiwiYmFzZW5hbWUiLCJwcm92aWRlcyIsImFwaSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQVFBOztBQUNBOztBQUdBOztBQUNBOztBQVVBOztBQUVBOztBQUVBOzs7Ozs7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O0FBWlAsVUFERjtBQWdCQSxlQUFPSixJQUFJLEVBQVg7QUFDRDtBQUNGLEtBdElEO0FBdUlELEdBbEoyRTs7QUFtSjVFaUQsRUFBQUEsUUFBUSxHQUFHO0FBQ1QsV0FBTztBQUNML0MsTUFBQUEsSUFBSSxFQUFFLHlCQUFRLE1BQU07QUFDbEIsY0FBTWdELEdBQWlDLEdBQUk7QUFDekNoQyxVQUFBQSxPQUFPLEVBQUU7QUFEZ0MsU0FBM0M7QUFHQSxlQUFPZ0MsR0FBUDtBQUNELE9BTEs7QUFERCxLQUFQO0FBUUQ7O0FBNUoyRSxDQUFiLENBQWpFO2VBK0plL0QsTSIsInNvdXJjZXNDb250ZW50IjpbIi8qKiBDb3B5cmlnaHQgKGMpIDIwMTggVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZmxvd1xuICovXG5cbmltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7Um91dGVyIGFzIERlZmF1bHRQcm92aWRlcn0gZnJvbSAncmVhY3Qtcm91dGVyLWRvbSc7XG5pbXBvcnQge2NyZWF0ZUJyb3dzZXJIaXN0b3J5fSBmcm9tICdoaXN0b3J5JztcblxuaW1wb3J0IHtVbml2ZXJzYWxFdmVudHNUb2tlbn0gZnJvbSAnZnVzaW9uLXBsdWdpbi11bml2ZXJzYWwtZXZlbnRzJztcbmltcG9ydCB7XG4gIGNyZWF0ZVBsdWdpbixcbiAgY3JlYXRlVG9rZW4sXG4gIGh0bWwsXG4gIHVuZXNjYXBlLFxuICBtZW1vaXplLFxuICBSb3V0ZVRhZ3NUb2tlbixcbn0gZnJvbSAnZnVzaW9uLWNvcmUnO1xuaW1wb3J0IHR5cGUge1Rva2VuLCBDb250ZXh0LCBGdXNpb25QbHVnaW59IGZyb20gJ2Z1c2lvbi1jb3JlJztcblxuaW1wb3J0IHtSb3V0ZXIgYXMgU2VydmVyUm91dGVyfSBmcm9tICcuL3NlcnZlci5qcyc7XG5pbXBvcnQge1JvdXRlciBhcyBCcm93c2VyUm91dGVyfSBmcm9tICcuL2Jyb3dzZXIuanMnO1xuaW1wb3J0IHtjcmVhdGVTZXJ2ZXJIaXN0b3J5fSBmcm9tICcuL21vZHVsZXMvU2VydmVySGlzdG9yeS5qcyc7XG5cbmltcG9ydCB7YWRkUm91dGVQcmVmaXh9IGZyb20gJy4vbW9kdWxlcy91dGlscy5qcyc7XG5pbXBvcnQgdHlwZSB7Um91dGVySGlzdG9yeVR5cGUsIFN0YXRpY0NvbnRleHRUeXBlfSBmcm9tICcuL3R5cGVzLmpzJztcblxudHlwZSBQcm92aWRlclByb3BzVHlwZSA9IHtcbiAgaGlzdG9yeTogUm91dGVySGlzdG9yeVR5cGUsXG4gIGNoaWxkcmVuPzogUmVhY3QuTm9kZSxcbn07XG5cbnR5cGUgSGlzdG9yeVdyYXBwZXJUeXBlID0ge1xuICBmcm9tOiAoY3R4OiBDb250ZXh0KSA9PiB7XG4gICAgaGlzdG9yeTogUm91dGVySGlzdG9yeVR5cGUsXG4gIH0sXG59O1xuXG5leHBvcnQgY29uc3QgR2V0U3RhdGljQ29udGV4dFRva2VuID1cbiAgY3JlYXRlVG9rZW48KGN0eDogQ29udGV4dCkgPT4gU3RhdGljQ29udGV4dFR5cGU+KCdHZXRTdGF0aWNDb250ZXh0Jyk7XG5cbmV4cG9ydCBjb25zdCBSb3V0ZXJQcm92aWRlclRva2VuOiBUb2tlbjxcbiAgUmVhY3QuQ29tcG9uZW50VHlwZTxQcm92aWRlclByb3BzVHlwZT5cbj4gPSBjcmVhdGVUb2tlbignUm91dGVyUHJvdmlkZXInKTtcblxuZXhwb3J0IGNvbnN0IFJvdXRlclRva2VuOiBUb2tlbjxIaXN0b3J5V3JhcHBlclR5cGU+ID0gY3JlYXRlVG9rZW4oJ1JvdXRlcicpO1xuXG5jb25zdCBSb3V0ZXIgPSBfX05PREVfXyA/IFNlcnZlclJvdXRlciA6IEJyb3dzZXJSb3V0ZXI7XG5cbnR5cGUgUGx1Z2luRGVwc1R5cGUgPSB7XG4gIGdldFN0YXRpY0NvbnRleHQ6IHR5cGVvZiBHZXRTdGF0aWNDb250ZXh0VG9rZW4ub3B0aW9uYWwsXG4gIGVtaXR0ZXI6IHR5cGVvZiBVbml2ZXJzYWxFdmVudHNUb2tlbi5vcHRpb25hbCxcbiAgUHJvdmlkZXI6IHR5cGVvZiBSb3V0ZXJQcm92aWRlclRva2VuLm9wdGlvbmFsLFxuICBSb3V0ZVRhZ3M6IHR5cGVvZiBSb3V0ZVRhZ3NUb2tlbixcbn07XG5cbi8vIFByZXNlcnZlIGJyb3dzZXIgaGlzdG9yeSBpbnN0YW5jZSBhY3Jvc3MgSE1SXG5sZXQgYnJvd3Nlckhpc3Rvcnk7XG5sZXQgbm9NYXRjaGluZ1JvdXRlID0gJ25vLW1hdGNoaW5nLXJvdXRlJztcblxuY29uc3QgcGx1Z2luOiBGdXNpb25QbHVnaW48UGx1Z2luRGVwc1R5cGUsIEhpc3RvcnlXcmFwcGVyVHlwZT4gPSBjcmVhdGVQbHVnaW4oe1xuICBkZXBzOiB7XG4gICAgZW1pdHRlcjogVW5pdmVyc2FsRXZlbnRzVG9rZW4ub3B0aW9uYWwsXG4gICAgUHJvdmlkZXI6IFJvdXRlclByb3ZpZGVyVG9rZW4ub3B0aW9uYWwsXG4gICAgZ2V0U3RhdGljQ29udGV4dDogR2V0U3RhdGljQ29udGV4dFRva2VuLm9wdGlvbmFsLFxuICAgIFJvdXRlVGFnczogUm91dGVUYWdzVG9rZW4sXG4gIH0sXG4gIG1pZGRsZXdhcmU6IChcbiAgICB7Um91dGVUYWdzLCBlbWl0dGVyLCBQcm92aWRlciA9IERlZmF1bHRQcm92aWRlciwgZ2V0U3RhdGljQ29udGV4dH0sXG4gICAgc2VsZlxuICApID0+IHtcbiAgICByZXR1cm4gYXN5bmMgKGN0eCwgbmV4dCkgPT4ge1xuICAgICAgY29uc3QgdGFncyA9IFJvdXRlVGFncy5mcm9tKGN0eCk7XG4gICAgICBjb25zdCBwcmVmaXggPSBjdHgucHJlZml4IHx8ICcnO1xuICAgICAgaWYgKCFjdHguZWxlbWVudCkge1xuICAgICAgICByZXR1cm4gbmV4dCgpO1xuICAgICAgfVxuICAgICAgY29uc3QgbXlBUEkgPSBzZWxmLmZyb20oY3R4KTtcbiAgICAgIGlmIChfX05PREVfXykge1xuICAgICAgICBsZXQgcGFnZURhdGEgPSB7XG4gICAgICAgICAgdGl0bGU6IGN0eC5wYXRoLFxuICAgICAgICAgIHBhZ2U6IGN0eC5wYXRoLFxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBjb250ZXh0ID0gZ2V0U3RhdGljQ29udGV4dFxuICAgICAgICAgID8gZ2V0U3RhdGljQ29udGV4dChjdHgpXG4gICAgICAgICAgOiB7XG4gICAgICAgICAgICAgIGFjdGlvbjogbnVsbCxcbiAgICAgICAgICAgICAgbG9jYXRpb246IG51bGwsXG4gICAgICAgICAgICAgIHNldCBzdGF0dXMoY29kZTogbnVtYmVyKSB7XG4gICAgICAgICAgICAgICAgY3R4LnN0YXR1cyA9IGNvZGU7XG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIHNldCB1cmwodXJsOiBzdHJpbmcpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB0b1VybCA9IGFkZFJvdXRlUHJlZml4KHVybCwgcHJlZml4KTtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRvVXJsID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgY3R4LnJlZGlyZWN0KHRvVXJsKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9O1xuICAgICAgICAvLyBFeHBvc2UgdGhlIGhpc3Rvcnkgb2JqZWN0XG4gICAgICAgIGNvbnN0IGhpc3RvcnkgPSBjcmVhdGVTZXJ2ZXJIaXN0b3J5KHByZWZpeCwgY29udGV4dCwgcHJlZml4ICsgY3R4LnVybCk7XG4gICAgICAgIG15QVBJLmhpc3RvcnkgPSBoaXN0b3J5O1xuICAgICAgICBjdHguZWxlbWVudCA9IChcbiAgICAgICAgICA8Um91dGVyXG4gICAgICAgICAgICBoaXN0b3J5PXtoaXN0b3J5fVxuICAgICAgICAgICAgUHJvdmlkZXI9e1Byb3ZpZGVyfVxuICAgICAgICAgICAgb25Sb3V0ZT17KGQpID0+IHtcbiAgICAgICAgICAgICAgcGFnZURhdGEgPSBkO1xuICAgICAgICAgICAgICB0YWdzLm5hbWUgPSBwYWdlRGF0YS50aXRsZTtcbiAgICAgICAgICAgICAgdGFncy5wYWdlID0gcGFnZURhdGEucGFnZTtcbiAgICAgICAgICAgICAgcGFnZURhdGEucm91dGVNYXRjaGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIH19XG4gICAgICAgICAgICBiYXNlbmFtZT17cHJlZml4fVxuICAgICAgICAgICAgY29udGV4dD17Y29udGV4dH1cbiAgICAgICAgICA+XG4gICAgICAgICAgICB7Y3R4LmVsZW1lbnR9XG4gICAgICAgICAgPC9Sb3V0ZXI+XG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiBuZXh0KCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgY3R4LnRlbXBsYXRlLmJvZHkucHVzaChcbiAgICAgICAgICAgIGh0bWxgXG4gICAgICAgICAgICAgIDxzY3JpcHQgaWQ9XCJfX1JPVVRFUl9EQVRBX19cIiB0eXBlPVwiYXBwbGljYXRpb24vanNvblwiPlxuICAgICAgICAgICAgICAgICR7SlNPTi5zdHJpbmdpZnkocGFnZURhdGEpfVxuICAgICAgICAgICAgICA8L3NjcmlwdD5cbiAgICAgICAgICAgIGBcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgaWYgKGVtaXR0ZXIpIHtcbiAgICAgICAgICAgIGNvbnN0IHNjb3BlZEVtaXR0ZXIgPSBlbWl0dGVyLmZyb20oY3R4KTtcbiAgICAgICAgICAgIGNvbnN0IGVtaXRUaW1pbmcgPSAodHlwZSkgPT4gKHRpbWluZykgPT4ge1xuICAgICAgICAgICAgICBzY29wZWRFbWl0dGVyLmVtaXQodHlwZSwge1xuICAgICAgICAgICAgICAgIHRpdGxlOiBwYWdlRGF0YS5yb3V0ZU1hdGNoZWQgPyBwYWdlRGF0YS50aXRsZSA6IG5vTWF0Y2hpbmdSb3V0ZSxcbiAgICAgICAgICAgICAgICBwYWdlOiBwYWdlRGF0YS5wYWdlLFxuICAgICAgICAgICAgICAgIHN0YXR1czogY3R4LnN0YXR1cyxcbiAgICAgICAgICAgICAgICB0aW1pbmcsXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHNjb3BlZEVtaXR0ZXIubWFwKChwYXlsb2FkKSA9PiB7XG4gICAgICAgICAgICAgIGlmIChwYXlsb2FkICYmIHR5cGVvZiBwYXlsb2FkID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgIGlmIChwYWdlRGF0YS5yb3V0ZU1hdGNoZWQpIHtcbiAgICAgICAgICAgICAgICAgIHBheWxvYWQuX191cmxfXyA9IHBhZ2VEYXRhLnRpdGxlO1xuICAgICAgICAgICAgICAgICAgcGF5bG9hZC5fX3VybFBhcmFtc19fID0gcGFnZURhdGEucGFyYW1zO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICBwYXlsb2FkLl9fdXJsX18gPSBub01hdGNoaW5nUm91dGU7XG4gICAgICAgICAgICAgICAgICBwYXlsb2FkLl9fdXJsUGFyYW1zX18gPSB7fTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgcmV0dXJuIHBheWxvYWQ7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGN0eC50aW1pbmcuZW5kLnRoZW4oKHRpbWluZykgPT4ge1xuICAgICAgICAgICAgICBlbWl0VGltaW5nKCdwYWdldmlldzpzZXJ2ZXInKSh0aW1pbmcpO1xuICAgICAgICAgICAgICBjdHgudGltaW5nLnJlbmRlci50aGVuKGVtaXRUaW1pbmcoJ3JlbmRlcjpzZXJ2ZXInKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmIChfX0JST1dTRVJfXykge1xuICAgICAgICAvLyBUT0RPKCMzKTogV2Ugc2hvdWxkIGNvbnNpZGVyIGFkZGluZyByZW5kZXIvZG93bnN0cmVhbS91cHN0cmVhbSB0aW1pbmdzIGZvciB0aGUgYnJvd3NlclxuICAgICAgICBsZXQgcGFnZURhdGEgPSB7fTtcbiAgICAgICAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdfX1JPVVRFUl9EQVRBX18nKTtcbiAgICAgICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgICAgICBwYWdlRGF0YSA9IEpTT04ucGFyc2UodW5lc2NhcGUoZWxlbWVudC50ZXh0Q29udGVudCkpO1xuICAgICAgICAgIHRhZ3MubmFtZSA9IHBhZ2VEYXRhLnRpdGxlO1xuICAgICAgICAgIHRhZ3MucGFnZSA9IHBhZ2VEYXRhLnBhZ2U7XG4gICAgICAgIH1cbiAgICAgICAgZW1pdHRlciAmJlxuICAgICAgICAgIGVtaXR0ZXIubWFwKChwYXlsb2FkKSA9PiB7XG4gICAgICAgICAgICBpZiAocGF5bG9hZCAmJiB0eXBlb2YgcGF5bG9hZCA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgICAgaWYgKHBhZ2VEYXRhLnJvdXRlTWF0Y2hlZCkge1xuICAgICAgICAgICAgICAgIHBheWxvYWQuX191cmxfXyA9IHBhZ2VEYXRhLnRpdGxlO1xuICAgICAgICAgICAgICAgIHBheWxvYWQuX191cmxQYXJhbXNfXyA9IHBhZ2VEYXRhLnBhcmFtcztcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBwYXlsb2FkLl9fdXJsX18gPSBub01hdGNoaW5nUm91dGU7XG4gICAgICAgICAgICAgICAgcGF5bG9hZC5fX3VybFBhcmFtc19fID0ge307XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBwYXlsb2FkO1xuICAgICAgICAgIH0pO1xuICAgICAgICAvLyBwcmVzZXJ2aW5nIGJyb3dzZXIgaGlzdG9yeSBhY3Jvc3MgaG1yIGZpeGVzIHdhcm5pbmcgXCJXYXJuaW5nOiBZb3UgY2Fubm90IGNoYW5nZSA8Um91dGVyIGhpc3Rvcnk+XCJcbiAgICAgICAgLy8gd2UgZG9uJ3Qgd2FudCB0byBwcmVzZXJ2ZSB0aGUgYGJyb3dzZXJIaXN0b3J5YCBpbnN0YW5jZSBhY3Jvc3MganNkb20gdGVzdHMgaG93ZXZlciwgYXMgaXQgd2lsbCBjYXVzZVxuICAgICAgICAvLyByb3V0ZXMgdG8gbWF0Y2ggYmFzZWQgb24gdGhlIHByZXZpb3VzIGxvY2F0aW9uIGluZm9ybWF0aW9uLlxuICAgICAgICBpZiAoXG4gICAgICAgICAgIWJyb3dzZXJIaXN0b3J5IHx8XG4gICAgICAgICAgKF9fREVWX18gJiYgdHlwZW9mIHdpbmRvdy5qc2RvbSAhPT0gJ3VuZGVmaW5lZCcpXG4gICAgICAgICkge1xuICAgICAgICAgIGJyb3dzZXJIaXN0b3J5ID0gY3JlYXRlQnJvd3Nlckhpc3Rvcnkoe2Jhc2VuYW1lOiBjdHgucHJlZml4fSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gRXhwb3NlIHRoZSBoaXN0b3J5IG9iamVjdFxuICAgICAgICBteUFQSS5oaXN0b3J5ID0gYnJvd3Nlckhpc3Rvcnk7XG4gICAgICAgIGN0eC5lbGVtZW50ID0gKFxuICAgICAgICAgIDxSb3V0ZXJcbiAgICAgICAgICAgIGhpc3Rvcnk9e2Jyb3dzZXJIaXN0b3J5fVxuICAgICAgICAgICAgUHJvdmlkZXI9e1Byb3ZpZGVyfVxuICAgICAgICAgICAgYmFzZW5hbWU9e2N0eC5wcmVmaXh9XG4gICAgICAgICAgICBvblJvdXRlPXsocGF5bG9hZCkgPT4ge1xuICAgICAgICAgICAgICBwYXlsb2FkLnJvdXRlTWF0Y2hlZCA9IHRydWU7XG4gICAgICAgICAgICAgIHBhZ2VEYXRhID0gcGF5bG9hZDtcbiAgICAgICAgICAgICAgdGFncy5uYW1lID0gcGFnZURhdGEudGl0bGU7XG4gICAgICAgICAgICAgIHRhZ3MucGFnZSA9IHBhZ2VEYXRhLnBhZ2U7XG4gICAgICAgICAgICAgIGVtaXR0ZXIgJiYgZW1pdHRlci5lbWl0KCdwYWdldmlldzpicm93c2VyJywgcGF5bG9hZCk7XG4gICAgICAgICAgICB9fVxuICAgICAgICAgID5cbiAgICAgICAgICAgIHtjdHguZWxlbWVudH1cbiAgICAgICAgICA8L1JvdXRlcj5cbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgIH1cbiAgICB9O1xuICB9LFxuICBwcm92aWRlcygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgZnJvbTogbWVtb2l6ZSgoKSA9PiB7XG4gICAgICAgIGNvbnN0IGFwaToge2hpc3Rvcnk6IFJvdXRlckhpc3RvcnlUeXBlfSA9ICh7XG4gICAgICAgICAgaGlzdG9yeTogbnVsbCxcbiAgICAgICAgfTogYW55KTtcbiAgICAgICAgcmV0dXJuIGFwaTtcbiAgICAgIH0pLFxuICAgIH07XG4gIH0sXG59KTtcblxuZXhwb3J0IGRlZmF1bHQgcGx1Z2luO1xuIl19