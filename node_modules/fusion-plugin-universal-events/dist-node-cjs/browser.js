"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.UniversalEmitter = void 0;
var _emitter = _interopRequireDefault(require("./emitter"));
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

/* eslint-env browser */

// The Beacon API rejects requests with big payloads and the size limit
// depends on the user agent. The limit in Chrome is 64KB and it is supposed
// to be at least the same also for the other browsers, even if they did not
// release any official information.
const BEACON_PAYLOAD_SIZE_LIMIT = 60000;

// The bodyparser used server-side has a default 1mb limit
const XHR_PAYLOAD_SIZE_LIMIT = 1048576;
class UniversalEmitter extends _emitter.default {
  isFlushInProgress = false;
  hasFlushBeenScheduled = false;
  constructor(fetch, storage, interval = 5000, limit = 1000) {
    super();
    //privates
    this.storage = storage;
    this.flush = this.flushInternal.bind(this);
    this.fetch = fetch;
    this.setFrequency(interval);
    this.limit = limit;
    window.addEventListener('visibilitychange', this.flushBeforeTerminated);
  }
  setFrequency(frequency) {
    window.clearInterval(this.interval);
    this.interval = setInterval(this.flush, frequency);
  }
  emit(type, payload) {
    payload = super.mapEvent(type, payload);
    super.handleEvent(type, payload);
    this.storage.add({
      type,
      payload
    });
  }
  // match server api
  from() {
    return this;
  }
  flushBeforeTerminated = () => document.visibilityState === 'hidden' && this.flushInternal();
  async flushInternal() {
    if (!this.startFlush()) {
      return;
    }
    // this is workaround to 'get' items and keep them in the storage
    const items = this.storage.getAndClear(this.limit);
    this.storage.addToStart(...items);
    if (items.length === 0) {
      this.finishFlush();
      return;
    }

    // Navigator has to be bound to ensure it does not error in some browsers
    // https://xgwang.me/posts/you-may-not-know-beacon/#it-may-throw-error%2C-be-sure-to-catch
    const sendBeacon = navigator.sendBeacon && navigator.sendBeacon.bind(navigator);
    const payloadSizelimit = sendBeacon ? BEACON_PAYLOAD_SIZE_LIMIT : XHR_PAYLOAD_SIZE_LIMIT;
    const itemsToSend = [];
    let isLargePayload = false;
    let jsonSize = 12; // Base payload is `{"items":[]}`
    for (let i = 0, l = items.length; i < l; i += 1) {
      const itemJSON = JSON.stringify(items[i]);
      const jsonItemSize = new Blob([itemJSON]).size;
      if (jsonItemSize + jsonSize < payloadSizelimit) {
        itemsToSend.push(itemJSON);
        jsonSize += jsonItemSize + (itemsToSend.length > 1 ? 1 : 0);
      } else {
        if (i === 0) {
          // single item is larger than payload size limit
          isLargePayload = true;
          itemsToSend.push(itemJSON);
        }
        break;
      }
    }
    const payload = `{"items":[${itemsToSend.join(',')}]}`;
    if (sendBeacon && !isLargePayload) {
      // Not sending Blob with Content-Type: 'application/json' because it throws in some old browsers.
      // It has been temporary disabled due to a CORS-related bug - CORS preflight checks were not
      // performed in sendBeacon using Blob with a not-simple content type.
      // See http://crbug.com/490015
      const prefix = window.__ROUTE_PREFIX__ || '';
      const eventsURL = prefix + '/_events';
      let sendBeaconResult = false;
      try {
        // Only wrap this line inside try catch just to be surgical.
        sendBeaconResult = sendBeacon(eventsURL, payload);
      } catch (e) {
        // Do nothing. If sendBeaconResult is false, we will fallback to using `this.fetch` below.
      }
      if (sendBeaconResult) {
        this.storage.getAndClear(itemsToSend.length);
        this.finishFlush();
        return;
      }
    }
    try {
      const res = await this.fetch('/_events', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: payload
      });
      if (res.ok) {
        // clear only events that were sent, preserve ones that might be added while request was executed
        this.storage.getAndClear(itemsToSend.length);
        this.finishFlush();
      } else {
        // If the server responds with a 413, it means the size of the payload was too large.
        // We handle this by cutting our limit in half for the next attempt.
        if (res.status === 413) {
          this.limit = this.limit / 2;
        }
        this.finishFlush();
      }
    } catch (e) {
      // do nothing here, items are still in the storage and will be sent on the next attempt
      this.finishFlush();
    }
  }
  teardown() {
    window.removeEventListener('visibilitychange', this.flushBeforeTerminated);
    clearInterval(this.interval);
    this.interval = null;
  }
  startFlush() {
    if (this.isFlushInProgress) {
      this.hasFlushBeenScheduled = true;
      return false;
    }
    this.isFlushInProgress = true;
    return true;
  }
  finishFlush() {
    this.isFlushInProgress = false;
    if (this.hasFlushBeenScheduled) {
      this.hasFlushBeenScheduled = false;
      this.flushInternal();
    }
  }
}
exports.UniversalEmitter = UniversalEmitter;
const plugin = false && createPlugin({
  deps: {
    fetch: FetchToken,
    storage: UniversalEventsBatchStorageToken.optional
  },
  provides: ({
    fetch,
    storage
  }) => {
    return new UniversalEmitter(fetch, storage || inMemoryBatchStorage);
  },
  cleanup: async emitter => {
    return emitter.teardown();
  }
});
var _default = plugin;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCRUFDT05fUEFZTE9BRF9TSVpFX0xJTUlUIiwiWEhSX1BBWUxPQURfU0laRV9MSU1JVCIsIlVuaXZlcnNhbEVtaXR0ZXIiLCJFbWl0dGVyIiwiaXNGbHVzaEluUHJvZ3Jlc3MiLCJoYXNGbHVzaEJlZW5TY2hlZHVsZWQiLCJjb25zdHJ1Y3RvciIsImZldGNoIiwic3RvcmFnZSIsImludGVydmFsIiwibGltaXQiLCJmbHVzaCIsImZsdXNoSW50ZXJuYWwiLCJiaW5kIiwic2V0RnJlcXVlbmN5Iiwid2luZG93IiwiYWRkRXZlbnRMaXN0ZW5lciIsImZsdXNoQmVmb3JlVGVybWluYXRlZCIsImZyZXF1ZW5jeSIsImNsZWFySW50ZXJ2YWwiLCJzZXRJbnRlcnZhbCIsImVtaXQiLCJ0eXBlIiwicGF5bG9hZCIsIm1hcEV2ZW50IiwiaGFuZGxlRXZlbnQiLCJhZGQiLCJmcm9tIiwiZG9jdW1lbnQiLCJ2aXNpYmlsaXR5U3RhdGUiLCJzdGFydEZsdXNoIiwiaXRlbXMiLCJnZXRBbmRDbGVhciIsImFkZFRvU3RhcnQiLCJsZW5ndGgiLCJmaW5pc2hGbHVzaCIsInNlbmRCZWFjb24iLCJuYXZpZ2F0b3IiLCJwYXlsb2FkU2l6ZWxpbWl0IiwiaXRlbXNUb1NlbmQiLCJpc0xhcmdlUGF5bG9hZCIsImpzb25TaXplIiwiaSIsImwiLCJpdGVtSlNPTiIsIkpTT04iLCJzdHJpbmdpZnkiLCJqc29uSXRlbVNpemUiLCJCbG9iIiwic2l6ZSIsInB1c2giLCJqb2luIiwicHJlZml4IiwiX19ST1VURV9QUkVGSVhfXyIsImV2ZW50c1VSTCIsInNlbmRCZWFjb25SZXN1bHQiLCJlIiwicmVzIiwibWV0aG9kIiwiaGVhZGVycyIsImJvZHkiLCJvayIsInN0YXR1cyIsInRlYXJkb3duIiwicmVtb3ZlRXZlbnRMaXN0ZW5lciIsInBsdWdpbiIsImNyZWF0ZVBsdWdpbiIsImRlcHMiLCJGZXRjaFRva2VuIiwiVW5pdmVyc2FsRXZlbnRzQmF0Y2hTdG9yYWdlVG9rZW4iLCJvcHRpb25hbCIsInByb3ZpZGVzIiwiaW5NZW1vcnlCYXRjaFN0b3JhZ2UiLCJjbGVhbnVwIiwiZW1pdHRlciJdLCJzb3VyY2VzIjpbInNyYy9icm93c2VyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKiBDb3B5cmlnaHQgKGMpIDIwMTggVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKi9cblxuLyogZXNsaW50LWVudiBicm93c2VyICovXG5pbXBvcnQge2NyZWF0ZVBsdWdpbn0gZnJvbSAnZnVzaW9uLWNvcmUnO1xuaW1wb3J0IHR5cGUge0Z1c2lvblBsdWdpbn0gZnJvbSAnZnVzaW9uLWNvcmUnO1xuaW1wb3J0IHtGZXRjaFRva2VufSBmcm9tICdmdXNpb24tdG9rZW5zJztcbmltcG9ydCB0eXBlIHtGZXRjaH0gZnJvbSAnZnVzaW9uLXRva2Vucyc7XG5pbXBvcnQgRW1pdHRlciBmcm9tICcuL2VtaXR0ZXInO1xuaW1wb3J0IHR5cGUge1xuICBJRW1pdHRlcixcbiAgVW5pdmVyc2FsRXZlbnRzUGx1Z2luRGVwc1R5cGUgYXMgRGVwc1R5cGUsXG4gIEJhdGNoU3RvcmFnZSxcbn0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQge1VuaXZlcnNhbEV2ZW50c0JhdGNoU3RvcmFnZVRva2VufSBmcm9tICcuL3N0b3JhZ2UvaW5kZXgnO1xuaW1wb3J0IHtpbk1lbW9yeUJhdGNoU3RvcmFnZX0gZnJvbSAnLi9zdG9yYWdlL2luLW1lbW9yeSc7XG5cbi8vIFRoZSBCZWFjb24gQVBJIHJlamVjdHMgcmVxdWVzdHMgd2l0aCBiaWcgcGF5bG9hZHMgYW5kIHRoZSBzaXplIGxpbWl0XG4vLyBkZXBlbmRzIG9uIHRoZSB1c2VyIGFnZW50LiBUaGUgbGltaXQgaW4gQ2hyb21lIGlzIDY0S0IgYW5kIGl0IGlzIHN1cHBvc2VkXG4vLyB0byBiZSBhdCBsZWFzdCB0aGUgc2FtZSBhbHNvIGZvciB0aGUgb3RoZXIgYnJvd3NlcnMsIGV2ZW4gaWYgdGhleSBkaWQgbm90XG4vLyByZWxlYXNlIGFueSBvZmZpY2lhbCBpbmZvcm1hdGlvbi5cbmNvbnN0IEJFQUNPTl9QQVlMT0FEX1NJWkVfTElNSVQgPSA2MDAwMDtcblxuLy8gVGhlIGJvZHlwYXJzZXIgdXNlZCBzZXJ2ZXItc2lkZSBoYXMgYSBkZWZhdWx0IDFtYiBsaW1pdFxuY29uc3QgWEhSX1BBWUxPQURfU0laRV9MSU1JVCA9IDEwNDg1NzY7XG5cbmRlY2xhcmUgZ2xvYmFsIHtcbiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3ViZXIvZnVzaW9uanMvaXNzdWVzLzE1NzdcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVudXNlZC12YXJzXG4gIGludGVyZmFjZSBXaW5kb3cge1xuICAgIF9fUk9VVEVfUFJFRklYX18/OiBzdHJpbmc7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFVuaXZlcnNhbEVtaXR0ZXIgZXh0ZW5kcyBFbWl0dGVyIHtcbiAgZmx1c2g6IGFueTtcbiAgZmV0Y2g6IEZldGNoO1xuICBpbnRlcnZhbDogYW55O1xuICBzdG9yYWdlOiBCYXRjaFN0b3JhZ2U7XG4gIGxpbWl0OiBudW1iZXI7XG4gIGlzRmx1c2hJblByb2dyZXNzID0gZmFsc2U7XG4gIGhhc0ZsdXNoQmVlblNjaGVkdWxlZCA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGZldGNoOiBGZXRjaCxcbiAgICBzdG9yYWdlOiBCYXRjaFN0b3JhZ2UsXG4gICAgaW50ZXJ2YWw6IG51bWJlciA9IDUwMDAsXG4gICAgbGltaXQ6IG51bWJlciA9IDEwMDBcbiAgKSB7XG4gICAgc3VwZXIoKTtcbiAgICAvL3ByaXZhdGVzXG4gICAgdGhpcy5zdG9yYWdlID0gc3RvcmFnZTtcbiAgICB0aGlzLmZsdXNoID0gdGhpcy5mbHVzaEludGVybmFsLmJpbmQodGhpcyk7XG4gICAgdGhpcy5mZXRjaCA9IGZldGNoO1xuICAgIHRoaXMuc2V0RnJlcXVlbmN5KGludGVydmFsKTtcbiAgICB0aGlzLmxpbWl0ID0gbGltaXQ7XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Zpc2liaWxpdHljaGFuZ2UnLCB0aGlzLmZsdXNoQmVmb3JlVGVybWluYXRlZCk7XG4gIH1cbiAgc2V0RnJlcXVlbmN5KGZyZXF1ZW5jeTogbnVtYmVyKTogdm9pZCB7XG4gICAgd2luZG93LmNsZWFySW50ZXJ2YWwodGhpcy5pbnRlcnZhbCk7XG4gICAgdGhpcy5pbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuZmx1c2gsIGZyZXF1ZW5jeSk7XG4gIH1cbiAgZW1pdCh0eXBlOiBzdHJpbmcsIHBheWxvYWQ6IHVua25vd24pOiB2b2lkIHtcbiAgICBwYXlsb2FkID0gc3VwZXIubWFwRXZlbnQodHlwZSwgcGF5bG9hZCk7XG4gICAgc3VwZXIuaGFuZGxlRXZlbnQodHlwZSwgcGF5bG9hZCk7XG4gICAgdGhpcy5zdG9yYWdlLmFkZCh7dHlwZSwgcGF5bG9hZH0pO1xuICB9XG4gIC8vIG1hdGNoIHNlcnZlciBhcGlcbiAgZnJvbSgpOiBVbml2ZXJzYWxFbWl0dGVyIHtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGZsdXNoQmVmb3JlVGVybWluYXRlZCA9ICgpID0+XG4gICAgZG9jdW1lbnQudmlzaWJpbGl0eVN0YXRlID09PSAnaGlkZGVuJyAmJiB0aGlzLmZsdXNoSW50ZXJuYWwoKTtcblxuICBhc3luYyBmbHVzaEludGVybmFsKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy5zdGFydEZsdXNoKCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgLy8gdGhpcyBpcyB3b3JrYXJvdW5kIHRvICdnZXQnIGl0ZW1zIGFuZCBrZWVwIHRoZW0gaW4gdGhlIHN0b3JhZ2VcbiAgICBjb25zdCBpdGVtcyA9IHRoaXMuc3RvcmFnZS5nZXRBbmRDbGVhcih0aGlzLmxpbWl0KTtcbiAgICB0aGlzLnN0b3JhZ2UuYWRkVG9TdGFydCguLi5pdGVtcyk7XG5cbiAgICBpZiAoaXRlbXMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLmZpbmlzaEZsdXNoKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gTmF2aWdhdG9yIGhhcyB0byBiZSBib3VuZCB0byBlbnN1cmUgaXQgZG9lcyBub3QgZXJyb3IgaW4gc29tZSBicm93c2Vyc1xuICAgIC8vIGh0dHBzOi8veGd3YW5nLm1lL3Bvc3RzL3lvdS1tYXktbm90LWtub3ctYmVhY29uLyNpdC1tYXktdGhyb3ctZXJyb3IlMkMtYmUtc3VyZS10by1jYXRjaFxuICAgIGNvbnN0IHNlbmRCZWFjb24gPVxuICAgICAgbmF2aWdhdG9yLnNlbmRCZWFjb24gJiYgbmF2aWdhdG9yLnNlbmRCZWFjb24uYmluZChuYXZpZ2F0b3IpO1xuXG4gICAgY29uc3QgcGF5bG9hZFNpemVsaW1pdCA9IHNlbmRCZWFjb25cbiAgICAgID8gQkVBQ09OX1BBWUxPQURfU0laRV9MSU1JVFxuICAgICAgOiBYSFJfUEFZTE9BRF9TSVpFX0xJTUlUO1xuXG4gICAgY29uc3QgaXRlbXNUb1NlbmQgPSBbXTtcbiAgICBsZXQgaXNMYXJnZVBheWxvYWQgPSBmYWxzZTtcbiAgICBsZXQganNvblNpemUgPSAxMjsgLy8gQmFzZSBwYXlsb2FkIGlzIGB7XCJpdGVtc1wiOltdfWBcbiAgICBmb3IgKGxldCBpID0gMCwgbCA9IGl0ZW1zLmxlbmd0aDsgaSA8IGw7IGkgKz0gMSkge1xuICAgICAgY29uc3QgaXRlbUpTT04gPSBKU09OLnN0cmluZ2lmeShpdGVtc1tpXSk7XG4gICAgICBjb25zdCBqc29uSXRlbVNpemUgPSBuZXcgQmxvYihbaXRlbUpTT05dKS5zaXplO1xuICAgICAgaWYgKGpzb25JdGVtU2l6ZSArIGpzb25TaXplIDwgcGF5bG9hZFNpemVsaW1pdCkge1xuICAgICAgICBpdGVtc1RvU2VuZC5wdXNoKGl0ZW1KU09OKTtcbiAgICAgICAganNvblNpemUgKz0ganNvbkl0ZW1TaXplICsgKGl0ZW1zVG9TZW5kLmxlbmd0aCA+IDEgPyAxIDogMCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoaSA9PT0gMCkge1xuICAgICAgICAgIC8vIHNpbmdsZSBpdGVtIGlzIGxhcmdlciB0aGFuIHBheWxvYWQgc2l6ZSBsaW1pdFxuICAgICAgICAgIGlzTGFyZ2VQYXlsb2FkID0gdHJ1ZTtcbiAgICAgICAgICBpdGVtc1RvU2VuZC5wdXNoKGl0ZW1KU09OKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgcGF5bG9hZCA9IGB7XCJpdGVtc1wiOlske2l0ZW1zVG9TZW5kLmpvaW4oJywnKX1dfWA7XG5cbiAgICBpZiAoc2VuZEJlYWNvbiAmJiAhaXNMYXJnZVBheWxvYWQpIHtcbiAgICAgIC8vIE5vdCBzZW5kaW5nIEJsb2Igd2l0aCBDb250ZW50LVR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJyBiZWNhdXNlIGl0IHRocm93cyBpbiBzb21lIG9sZCBicm93c2Vycy5cbiAgICAgIC8vIEl0IGhhcyBiZWVuIHRlbXBvcmFyeSBkaXNhYmxlZCBkdWUgdG8gYSBDT1JTLXJlbGF0ZWQgYnVnIC0gQ09SUyBwcmVmbGlnaHQgY2hlY2tzIHdlcmUgbm90XG4gICAgICAvLyBwZXJmb3JtZWQgaW4gc2VuZEJlYWNvbiB1c2luZyBCbG9iIHdpdGggYSBub3Qtc2ltcGxlIGNvbnRlbnQgdHlwZS5cbiAgICAgIC8vIFNlZSBodHRwOi8vY3JidWcuY29tLzQ5MDAxNVxuICAgICAgY29uc3QgcHJlZml4ID0gd2luZG93Ll9fUk9VVEVfUFJFRklYX18gfHwgJyc7XG4gICAgICBjb25zdCBldmVudHNVUkwgPSBwcmVmaXggKyAnL19ldmVudHMnO1xuXG4gICAgICBsZXQgc2VuZEJlYWNvblJlc3VsdCA9IGZhbHNlO1xuICAgICAgdHJ5IHtcbiAgICAgICAgLy8gT25seSB3cmFwIHRoaXMgbGluZSBpbnNpZGUgdHJ5IGNhdGNoIGp1c3QgdG8gYmUgc3VyZ2ljYWwuXG4gICAgICAgIHNlbmRCZWFjb25SZXN1bHQgPSBzZW5kQmVhY29uKGV2ZW50c1VSTCwgcGF5bG9hZCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIC8vIERvIG5vdGhpbmcuIElmIHNlbmRCZWFjb25SZXN1bHQgaXMgZmFsc2UsIHdlIHdpbGwgZmFsbGJhY2sgdG8gdXNpbmcgYHRoaXMuZmV0Y2hgIGJlbG93LlxuICAgICAgfVxuXG4gICAgICBpZiAoc2VuZEJlYWNvblJlc3VsdCkge1xuICAgICAgICB0aGlzLnN0b3JhZ2UuZ2V0QW5kQ2xlYXIoaXRlbXNUb1NlbmQubGVuZ3RoKTtcbiAgICAgICAgdGhpcy5maW5pc2hGbHVzaCgpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuZmV0Y2goJy9fZXZlbnRzJywge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgIH0sXG4gICAgICAgIGJvZHk6IHBheWxvYWQsXG4gICAgICB9KTtcblxuICAgICAgaWYgKHJlcy5vaykge1xuICAgICAgICAvLyBjbGVhciBvbmx5IGV2ZW50cyB0aGF0IHdlcmUgc2VudCwgcHJlc2VydmUgb25lcyB0aGF0IG1pZ2h0IGJlIGFkZGVkIHdoaWxlIHJlcXVlc3Qgd2FzIGV4ZWN1dGVkXG4gICAgICAgIHRoaXMuc3RvcmFnZS5nZXRBbmRDbGVhcihpdGVtc1RvU2VuZC5sZW5ndGgpO1xuICAgICAgICB0aGlzLmZpbmlzaEZsdXNoKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBJZiB0aGUgc2VydmVyIHJlc3BvbmRzIHdpdGggYSA0MTMsIGl0IG1lYW5zIHRoZSBzaXplIG9mIHRoZSBwYXlsb2FkIHdhcyB0b28gbGFyZ2UuXG4gICAgICAgIC8vIFdlIGhhbmRsZSB0aGlzIGJ5IGN1dHRpbmcgb3VyIGxpbWl0IGluIGhhbGYgZm9yIHRoZSBuZXh0IGF0dGVtcHQuXG4gICAgICAgIGlmIChyZXMuc3RhdHVzID09PSA0MTMpIHtcbiAgICAgICAgICB0aGlzLmxpbWl0ID0gdGhpcy5saW1pdCAvIDI7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5maW5pc2hGbHVzaCgpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIC8vIGRvIG5vdGhpbmcgaGVyZSwgaXRlbXMgYXJlIHN0aWxsIGluIHRoZSBzdG9yYWdlIGFuZCB3aWxsIGJlIHNlbnQgb24gdGhlIG5leHQgYXR0ZW1wdFxuICAgICAgdGhpcy5maW5pc2hGbHVzaCgpO1xuICAgIH1cbiAgfVxuICB0ZWFyZG93bigpOiB2b2lkIHtcbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigndmlzaWJpbGl0eWNoYW5nZScsIHRoaXMuZmx1c2hCZWZvcmVUZXJtaW5hdGVkKTtcbiAgICBjbGVhckludGVydmFsKHRoaXMuaW50ZXJ2YWwpO1xuICAgIHRoaXMuaW50ZXJ2YWwgPSBudWxsO1xuICB9XG4gIHN0YXJ0Rmx1c2goKSB7XG4gICAgaWYgKHRoaXMuaXNGbHVzaEluUHJvZ3Jlc3MpIHtcbiAgICAgIHRoaXMuaGFzRmx1c2hCZWVuU2NoZWR1bGVkID0gdHJ1ZTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgdGhpcy5pc0ZsdXNoSW5Qcm9ncmVzcyA9IHRydWU7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgZmluaXNoRmx1c2goKSB7XG4gICAgdGhpcy5pc0ZsdXNoSW5Qcm9ncmVzcyA9IGZhbHNlO1xuICAgIGlmICh0aGlzLmhhc0ZsdXNoQmVlblNjaGVkdWxlZCkge1xuICAgICAgdGhpcy5oYXNGbHVzaEJlZW5TY2hlZHVsZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMuZmx1c2hJbnRlcm5hbCgpO1xuICAgIH1cbiAgfVxufVxuXG5jb25zdCBwbHVnaW4gPVxuICBfX0JST1dTRVJfXyAmJlxuICBjcmVhdGVQbHVnaW48XG4gICAge1xuICAgICAgZmV0Y2g6IHR5cGVvZiBGZXRjaFRva2VuO1xuICAgICAgc3RvcmFnZTogdHlwZW9mIFVuaXZlcnNhbEV2ZW50c0JhdGNoU3RvcmFnZVRva2VuLm9wdGlvbmFsO1xuICAgIH0sXG4gICAgSUVtaXR0ZXJcbiAgPih7XG4gICAgZGVwczoge1xuICAgICAgZmV0Y2g6IEZldGNoVG9rZW4sXG4gICAgICBzdG9yYWdlOiBVbml2ZXJzYWxFdmVudHNCYXRjaFN0b3JhZ2VUb2tlbi5vcHRpb25hbCxcbiAgICB9LFxuICAgIHByb3ZpZGVzOiAoe2ZldGNoLCBzdG9yYWdlfSkgPT4ge1xuICAgICAgcmV0dXJuIG5ldyBVbml2ZXJzYWxFbWl0dGVyKGZldGNoLCBzdG9yYWdlIHx8IGluTWVtb3J5QmF0Y2hTdG9yYWdlKTtcbiAgICB9LFxuICAgIGNsZWFudXA6IGFzeW5jIChlbWl0dGVyKSA9PiB7XG4gICAgICByZXR1cm4gZW1pdHRlci50ZWFyZG93bigpO1xuICAgIH0sXG4gIH0pO1xuXG5leHBvcnQgZGVmYXVsdCBwbHVnaW4gYXMgYW55IGFzIEZ1c2lvblBsdWdpbjxEZXBzVHlwZSwgSUVtaXR0ZXI+O1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFZQTtBQUFnQztBQVpoQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBY0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNQSx5QkFBeUIsR0FBRyxLQUFLOztBQUV2QztBQUNBLE1BQU1DLHNCQUFzQixHQUFHLE9BQU87QUFVL0IsTUFBTUMsZ0JBQWdCLFNBQVNDLGdCQUFPLENBQUM7RUFNNUNDLGlCQUFpQixHQUFHLEtBQUs7RUFDekJDLHFCQUFxQixHQUFHLEtBQUs7RUFFN0JDLFdBQVcsQ0FDVEMsS0FBWSxFQUNaQyxPQUFxQixFQUNyQkMsUUFBZ0IsR0FBRyxJQUFJLEVBQ3ZCQyxLQUFhLEdBQUcsSUFBSSxFQUNwQjtJQUNBLEtBQUssRUFBRTtJQUNQO0lBQ0EsSUFBSSxDQUFD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