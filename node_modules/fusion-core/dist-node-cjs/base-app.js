"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _createPlugin = require("./create-plugin");
var _createToken = require("./create-token");
var _tokens = require("./tokens");
var _ssr = require("./plugins/ssr");
var _routeTags = _interopRequireDefault(require("./plugins/route-tags"));
var _stackTrace = require("./stack-trace");
var _core = require("./core");
var _legacyCompat = require("./legacy-compat");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

/* eslint-disable require-yield */

class BaseApp extends _core.App {
  constructor(el, render) {
    super();
    this.registered = new Map(); // getTokenRef(token) -> {value, aliases, enhancers}
    this.plugins = []; // Token
    el && this.register(_tokens.ElementToken, el);
    if (render) {
      this.renderer = render;
    }
    this.register(_tokens.SSRDeciderToken, _ssr.SSRDecider);
    this.register(_tokens.RouteTagsToken, _routeTags.default);
    this.done = false;
  }

  // eslint-disable-next-line

  register(tokenOrValue, maybeValue) {
    const hasToken = tokenOrValue instanceof _createToken.TokenImpl;
    const token = hasToken ? tokenOrValue : (0, _createToken.createToken)('UnnamedPlugin');
    const value = hasToken ? maybeValue : tokenOrValue;
    if (!hasToken && (value == null || !(0, _createPlugin.getPluginFn)(value))) {
      throw new _stackTrace.DIError({
        message: process.env.NODE_ENV !== "production" ? `Cannot register ${String(tokenOrValue)} without a token. Did you accidentally register a ${true ? 'browser' : 'server'} plugin on the ${true ? 'server' : 'browser'}?` : 'Invalid configuration registration',
        errorDoc: 'value-without-token',
        caller: this.register
      });
    }
    // the renderer is a special case, since it needs to be always run last
    if (token === _tokens.RenderToken) {
      this.renderer = value;
      const alias = () => {
        throw new _stackTrace.DIError({
          message: 'Aliasing for RenderToken not supported',
          caller: alias
        });
      };
      return {
        alias
      };
    }
    token.stacks.push({
      type: 'register',
      stack: (0, _stackTrace.captureStackTrace)(this.register)
    });
    if (value && value.__plugin__) {
      token.stacks.push({
        type: 'plugin',
        stack: value.stack
      });
    }
    return this._register(token, value);
  }
  _register(token, value) {
    const foundPluginFn = (0, _createPlugin.getPluginFn)(value);

    // const registerResult = super.registerPlugin(token, value);

    const registerResult = super.registerPlugin(token, foundPluginFn ? foundPluginFn : (0, _createPlugin.declarePlugin)(function* () {
      return value;
    }));

    // getPluginFn(valaue)
    //   ? super.registerPlugin(token, value.__fn__)
    //   : super.registerPlugin(
    //       token,
    //       declarePlugin(function* () {
    //         return value;
    //       })
    //     );

    // For introspect plugin
    const {
      aliases,
      enhancers
    } = this.registered.get((0, _createToken.getTokenRef)(token)) || {
      aliases: new Map(),
      enhancers: []
    };
    this.registered.set((0, _createToken.getTokenRef)(token), {
      value,
      aliases,
      enhancers,
      token
    });
    const alias = (sourceToken, destToken) => {
      registerResult.alias(sourceToken, destToken);
      const stack = (0, _stackTrace.captureStackTrace)(alias);
      sourceToken.stacks.push({
        type: 'alias-from',
        stack
      });
      destToken.stacks.push({
        type: 'alias-to',
        stack
      });
      return {
        alias
      };
    };
    return {
      alias
    };
  }
  middleware(deps, middleware) {
    if (middleware === undefined) {
      middleware = () => deps;
    }
    this.register((0, _createPlugin.createPlugin)({
      deps: deps,
      middleware
    }));
  }
  enhance(token, enhancer) {
    token.stacks.push({
      type: 'enhance',
      stack: (0, _stackTrace.captureStackTrace)(this.enhance)
    });

    // For introspect plugin
    const {
      value,
      aliases,
      enhancers
    } = this.registered.get((0, _createToken.getTokenRef)(token)) || {
      aliases: new Map(),
      enhancers: [],
      value: undefined
    };
    if (enhancers && Array.isArray(enhancers)) {
      // @ts-ignore (Remove once references are used)
      enhancers.push(enhancer);
    }
    this.registered.set((0, _createToken.getTokenRef)(token), {
      value,
      aliases,
      enhancers,
      token
    });
    return super.enhance(token, enhancer);
  }
  cleanup() {
    return Promise.all(this.cleanups.map(fn => fn()));
  }
  resolve() {
    if (!this.renderer) {
      throw new Error('Missing registration for RenderToken');
    }
    this._register(_tokens.RenderToken, this.renderer);
    if (this.registeredTokens.has((0, _createToken.getTokenRef)(_tokens.EnableMiddlewareTimingToken))) {
      this.enableMiddlewareTiming = true;
    }

    // Note that core init actually returns a promise.
    // However, core init will synchronously complete as long as there is no
    // async tasks. The only planned async hook is withStartup(), which is not
    // currently implemented. Introducing async startup is technically a
    // breaking change, which we are avoiding initially. When we want to make
    // this breaking change and introduce withStartup(), we should add an await
    // to the statement below
    super.init();
    (0, _legacyCompat.sortLegacy)(this); // Preserve legacy order for compatibility

    this.done = true;
  }

  // @ts-ignore (Remove once references are used)
  getService(token) {
    if (!this.done) {
      throw new _stackTrace.DIError({
        message: 'Cannot get service from unresolved app',
        caller: this.getService
      });
    }
    const result = (0, _core.getResolvedDep)(this, token);
    if (result.resolved) {
      return result.value;
    }
  }
  callback(...args) {}
}
var _default = BaseApp;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCYXNlQXBwIiwiQ29yZSIsImNvbnN0cnVjdG9yIiwiZWwiLCJyZW5kZXIiLCJyZWdpc3RlcmVkIiwiTWFwIiwicGx1Z2lucyIsInJlZ2lzdGVyIiwiRWxlbWVudFRva2VuIiwicmVuZGVyZXIiLCJTU1JEZWNpZGVyVG9rZW4iLCJTU1JEZWNpZGVyIiwiUm91dGVUYWdzVG9rZW4iLCJSb3V0ZVRhZ3NQbHVnaW4iLCJkb25lIiwidG9rZW5PclZhbHVlIiwibWF5YmVWYWx1ZSIsImhhc1Rva2VuIiwiVG9rZW5JbXBsIiwidG9rZW4iLCJjcmVhdGVUb2tlbiIsInZhbHVlIiwiZ2V0UGx1Z2luRm4iLCJESUVycm9yIiwibWVzc2FnZSIsIlN0cmluZyIsImVycm9yRG9jIiwiY2FsbGVyIiwiUmVuZGVyVG9rZW4iLCJhbGlhcyIsInN0YWNrcyIsInB1c2giLCJ0eXBlIiwic3RhY2siLCJjYXB0dXJlU3RhY2tUcmFjZSIsIl9fcGx1Z2luX18iLCJfcmVnaXN0ZXIiLCJmb3VuZFBsdWdpbkZuIiwicmVnaXN0ZXJSZXN1bHQiLCJyZWdpc3RlclBsdWdpbiIsImRlY2xhcmVQbHVnaW4iLCJhbGlhc2VzIiwiZW5oYW5jZXJzIiwiZ2V0IiwiZ2V0VG9rZW5SZWYiLCJzZXQiLCJzb3VyY2VUb2tlbiIsImRlc3RUb2tlbiIsIm1pZGRsZXdhcmUiLCJkZXBzIiwidW5kZWZpbmVkIiwiY3JlYXRlUGx1Z2luIiwiZW5oYW5jZSIsImVuaGFuY2VyIiwiQXJyYXkiLCJpc0FycmF5IiwiY2xlYW51cCIsIlByb21pc2UiLCJhbGwiLCJjbGVhbnVwcyIsIm1hcCIsImZuIiwicmVzb2x2ZSIsIkVycm9yIiwicmVnaXN0ZXJlZFRva2VucyIsImhhcyIsIkVuYWJsZU1pZGRsZXdhcmVUaW1pbmdUb2tlbiIsImVuYWJsZU1pZGRsZXdhcmVUaW1pbmciLCJpbml0Iiwic29ydExlZ2FjeSIsImdldFNlcnZpY2UiLCJyZXN1bHQiLCJnZXRSZXNvbHZlZERlcCIsInJlc29sdmVkIiwiY2FsbGJhY2siLCJhcmdzIl0sInNvdXJjZXMiOlsic3JjL2Jhc2UtYXBwLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKiBDb3B5cmlnaHQgKGMpIDIwMTggVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKi9cblxuLyogZXNsaW50LWRpc2FibGUgcmVxdWlyZS15aWVsZCAqL1xuaW1wb3J0IHtjcmVhdGVQbHVnaW4sIGRlY2xhcmVQbHVnaW4sIGdldFBsdWdpbkZufSBmcm9tICcuL2NyZWF0ZS1wbHVnaW4nO1xuaW1wb3J0IHtjcmVhdGVUb2tlbiwgZ2V0VG9rZW5SZWYsIFRva2VuSW1wbH0gZnJvbSAnLi9jcmVhdGUtdG9rZW4nO1xuaW1wb3J0IHtcbiAgRWxlbWVudFRva2VuLFxuICBSZW5kZXJUb2tlbixcbiAgU1NSRGVjaWRlclRva2VuLFxuICBSb3V0ZVRhZ3NUb2tlbixcbiAgRW5hYmxlTWlkZGxld2FyZVRpbWluZ1Rva2VuLFxufSBmcm9tICcuL3Rva2Vucyc7XG5pbXBvcnQge1NTUkRlY2lkZXJ9IGZyb20gJy4vcGx1Z2lucy9zc3InO1xuaW1wb3J0IFJvdXRlVGFnc1BsdWdpbiBmcm9tICcuL3BsdWdpbnMvcm91dGUtdGFncyc7XG5pbXBvcnQge2NhcHR1cmVTdGFja1RyYWNlLCBESUVycm9yfSBmcm9tICcuL3N0YWNrLXRyYWNlJztcblxuaW1wb3J0IHtBcHAgYXMgQ29yZSwgZ2V0UmVzb2x2ZWREZXB9IGZyb20gJy4vY29yZSc7XG5pbXBvcnQge3NvcnRMZWdhY3l9IGZyb20gJy4vbGVnYWN5LWNvbXBhdCc7XG5cbmltcG9ydCB0eXBlIHtcbiAgYWxpYXNlcixcbiAgRXh0cmFjdERlcHNUeXBlLFxuICBGdXNpb25QbHVnaW4sXG4gIE1pZGRsZXdhcmUsXG4gIFRva2VuLFxufSBmcm9tICcuL3R5cGVzJztcblxuY2xhc3MgQmFzZUFwcCBleHRlbmRzIENvcmUge1xuICBjb25zdHJ1Y3RvcihlbDogYW55LCByZW5kZXI6IGFueSkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5yZWdpc3RlcmVkID0gbmV3IE1hcCgpOyAvLyBnZXRUb2tlblJlZih0b2tlbikgLT4ge3ZhbHVlLCBhbGlhc2VzLCBlbmhhbmNlcnN9XG4gICAgdGhpcy5wbHVnaW5zID0gW107IC8vIFRva2VuXG4gICAgZWwgJiYgdGhpcy5yZWdpc3RlcihFbGVtZW50VG9rZW4sIGVsKTtcbiAgICBpZiAocmVuZGVyKSB7XG4gICAgICB0aGlzLnJlbmRlcmVyID0gcmVuZGVyO1xuICAgIH1cbiAgICB0aGlzLnJlZ2lzdGVyKFNTUkRlY2lkZXJUb2tlbiwgU1NSRGVjaWRlcik7XG4gICAgdGhpcy5yZWdpc3RlcihSb3V0ZVRhZ3NUb2tlbiwgUm91dGVUYWdzUGx1Z2luKTtcbiAgICB0aGlzLmRvbmUgPSBmYWxzZTtcbiAgfVxuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZVxuICByZWdpc3RlcmVkOiBNYXA8YW55LCB7XG4gICAgICBhbGlhc2VzPzogTWFwPGFueSwgYW55PjtcbiAgICAgIGVuaGFuY2Vycz86IEFycmF5PGFueT47XG4gICAgICB0b2tlbjogYW55O1xuICAgICAgdmFsdWU/OiBGdXNpb25QbHVnaW48YW55LCBhbnk+O1xuICAgIH1cbiAgPjtcbiAgZW5oYW5jZXJUb1Rva2VuOiBNYXA8YW55LCBhbnk+O1xuICBwbHVnaW5zOiBBcnJheTxhbnk+O1xuICByZW5kZXJlcjogYW55O1xuICBfZ2V0U2VydmljZTogKGE6IGFueSkgPT4gYW55O1xuICBfZGVwZW5kZWRPbjogU2V0PGFueT47XG4gIGRvbmU6IGJvb2xlYW47XG4gIGVuYWJsZU1pZGRsZXdhcmVUaW1pbmc6IGJvb2xlYW47XG5cbiAgcmVnaXN0ZXI8VD4oXG4gICAgdG9rZW5PclZhbHVlOiBUb2tlbjxUPiB8IEZ1c2lvblBsdWdpbjxhbnksIFQ+LFxuICAgIG1heWJlVmFsdWU/OiBGdXNpb25QbHVnaW48YW55LCBUPiB8IFRcbiAgKTogYWxpYXNlciB7XG4gICAgY29uc3QgaGFzVG9rZW4gPSB0b2tlbk9yVmFsdWUgaW5zdGFuY2VvZiBUb2tlbkltcGw7XG4gICAgY29uc3QgdG9rZW4gPSBoYXNUb2tlblxuICAgICAgPyAodG9rZW5PclZhbHVlIGFzIGFueSBhcyBUb2tlbjxUPilcbiAgICAgIDogY3JlYXRlVG9rZW48VD4oJ1VubmFtZWRQbHVnaW4nKTtcbiAgICBjb25zdCB2YWx1ZTogYW55ID0gaGFzVG9rZW4gPyBtYXliZVZhbHVlIDogdG9rZW5PclZhbHVlO1xuICAgIGlmICghaGFzVG9rZW4gJiYgKHZhbHVlID09IG51bGwgfHwgIWdldFBsdWdpbkZuKHZhbHVlKSkpIHtcbiAgICAgIHRocm93IG5ldyBESUVycm9yKHtcbiAgICAgICAgbWVzc2FnZTogX19ERVZfX1xuICAgICAgICAgID8gYENhbm5vdCByZWdpc3RlciAke1N0cmluZyhcbiAgICAgICAgICAgICAgdG9rZW5PclZhbHVlXG4gICAgICAgICAgICApfSB3aXRob3V0IGEgdG9rZW4uIERpZCB5b3UgYWNjaWRlbnRhbGx5IHJlZ2lzdGVyIGEgJHtcbiAgICAgICAgICAgICAgX19OT0RFX18gPyAnYnJvd3NlcicgOiAnc2VydmVyJ1xuICAgICAgICAgICAgfSBwbHVnaW4gb24gdGhlICR7X19OT0RFX18gPyAnc2VydmVyJyA6ICdicm93c2VyJ30/YFxuICAgICAgICAgIDogJ0ludmFsaWQgY29uZmlndXJhdGlvbiByZWdpc3RyYXRpb24nLFxuICAgICAgICBlcnJvckRvYzogJ3ZhbHVlLXdpdGhvdXQtdG9rZW4nLFxuICAgICAgICBjYWxsZXI6IHRoaXMucmVnaXN0ZXIsXG4gICAgICB9KTtcbiAgICB9XG4gICAgLy8gdGhlIHJlbmRlcmVyIGlzIGEgc3BlY2lhbCBjYXNlLCBzaW5jZSBpdCBuZWVkcyB0byBiZSBhbHdheXMgcnVuIGxhc3RcbiAgICBpZiAodG9rZW4gPT09IFJlbmRlclRva2VuKSB7XG4gICAgICB0aGlzLnJlbmRlcmVyID0gdmFsdWU7XG4gICAgICBjb25zdCBhbGlhcyA9ICgpID0+IHtcbiAgICAgICAgdGhyb3cgbmV3IERJRXJyb3Ioe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBbGlhc2luZyBmb3IgUmVuZGVyVG9rZW4gbm90IHN1cHBvcnRlZCcsXG4gICAgICAgICAgY2FsbGVyOiBhbGlhcyxcbiAgICAgICAgfSk7XG4gICAgICB9O1xuICAgICAgcmV0dXJuIHthbGlhc307XG4gICAgfVxuICAgIHRva2VuLnN0YWNrcy5wdXNoKHtcbiAgICAgIHR5cGU6ICdyZWdpc3RlcicsXG4gICAgICBzdGFjazogY2FwdHVyZVN0YWNrVHJhY2UodGhpcy5yZWdpc3RlciksXG4gICAgfSk7XG4gICAgaWYgKHZhbHVlICYmIHZhbHVlLl9fcGx1Z2luX18pIHtcbiAgICAgIHRva2VuLnN0YWNrcy5wdXNoKHt0eXBlOiAncGx1Z2luJywgc3RhY2s6IHZhbHVlLnN0YWNrfSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9yZWdpc3RlcjxUPih0b2tlbiwgdmFsdWUpO1xuICB9XG5cbiAgX3JlZ2lzdGVyPFQ+KHRva2VuOiBUb2tlbjxUPiwgdmFsdWU6IGFueSk6IGFsaWFzZXIge1xuICAgIGNvbnN0IGZvdW5kUGx1Z2luRm4gPSBnZXRQbHVnaW5Gbih2YWx1ZSk7XG5cbiAgICAvLyBjb25zdCByZWdpc3RlclJlc3VsdCA9IHN1cGVyLnJlZ2lzdGVyUGx1Z2luKHRva2VuLCB2YWx1ZSk7XG5cbiAgICBjb25zdCByZWdpc3RlclJlc3VsdCA9IHN1cGVyLnJlZ2lzdGVyUGx1Z2luKFxuICAgICAgdG9rZW4sXG4gICAgICBmb3VuZFBsdWdpbkZuXG4gICAgICAgID8gZm91bmRQbHVnaW5GblxuICAgICAgICA6IGRlY2xhcmVQbHVnaW4oZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICAgICAgICB9KVxuICAgICk7XG5cbiAgICAvLyBnZXRQbHVnaW5Gbih2YWxhdWUpXG4gICAgLy8gICA/IHN1cGVyLnJlZ2lzdGVyUGx1Z2luKHRva2VuLCB2YWx1ZS5fX2ZuX18pXG4gICAgLy8gICA6IHN1cGVyLnJlZ2lzdGVyUGx1Z2luKFxuICAgIC8vICAgICAgIHRva2VuLFxuICAgIC8vICAgICAgIGRlY2xhcmVQbHVnaW4oZnVuY3Rpb24qICgpIHtcbiAgICAvLyAgICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICAvLyAgICAgICB9KVxuICAgIC8vICAgICApO1xuXG4gICAgLy8gRm9yIGludHJvc3BlY3QgcGx1Z2luXG4gICAgY29uc3Qge2FsaWFzZXMsIGVuaGFuY2Vyc30gPSB0aGlzLnJlZ2lzdGVyZWQuZ2V0KGdldFRva2VuUmVmKHRva2VuKSkgfHwge1xuICAgICAgYWxpYXNlczogbmV3IE1hcCgpLFxuICAgICAgZW5oYW5jZXJzOiBbXSxcbiAgICB9O1xuICAgIHRoaXMucmVnaXN0ZXJlZC5zZXQoZ2V0VG9rZW5SZWYodG9rZW4pLCB7XG4gICAgICB2YWx1ZSxcbiAgICAgIGFsaWFzZXMsXG4gICAgICBlbmhhbmNlcnMsXG4gICAgICB0b2tlbixcbiAgICB9KTtcblxuICAgIGNvbnN0IGFsaWFzID0gKHNvdXJjZVRva2VuLCBkZXN0VG9rZW4pID0+IHtcbiAgICAgIHJlZ2lzdGVyUmVzdWx0LmFsaWFzKHNvdXJjZVRva2VuLCBkZXN0VG9rZW4pO1xuICAgICAgY29uc3Qgc3RhY2sgPSBjYXB0dXJlU3RhY2tUcmFjZShhbGlhcyk7XG4gICAgICBzb3VyY2VUb2tlbi5zdGFja3MucHVzaCh7dHlwZTogJ2FsaWFzLWZyb20nLCBzdGFja30pO1xuICAgICAgZGVzdFRva2VuLnN0YWNrcy5wdXNoKHt0eXBlOiAnYWxpYXMtdG8nLCBzdGFja30pO1xuICAgICAgcmV0dXJuIHthbGlhc307XG4gICAgfTtcbiAgICByZXR1cm4ge2FsaWFzfTtcbiAgfVxuXG4gIG1pZGRsZXdhcmU8VERlcHMgZXh0ZW5kcyB7fSA9IHt9PihcbiAgICBkZXBzOiBURGVwcyB8IE1pZGRsZXdhcmUsXG4gICAgbWlkZGxld2FyZT86IChEZXBzOiBFeHRyYWN0RGVwc1R5cGU8VERlcHM+KSA9PiBNaWRkbGV3YXJlXG4gICkge1xuICAgIGlmIChtaWRkbGV3YXJlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIG1pZGRsZXdhcmUgPSAoKSA9PiBkZXBzIGFzIGFueSBhcyBNaWRkbGV3YXJlO1xuICAgIH1cbiAgICB0aGlzLnJlZ2lzdGVyKGNyZWF0ZVBsdWdpbih7ZGVwczogZGVwcyBhcyBhbnkgYXMgVERlcHMsIG1pZGRsZXdhcmV9KSk7XG4gIH1cblxuICBlbmhhbmNlPFRSZXNvbHZlZD4odG9rZW46IFRva2VuPFRSZXNvbHZlZD4sIGVuaGFuY2VyOiBGdW5jdGlvbikge1xuICAgIHRva2VuLnN0YWNrcy5wdXNoKHtcbiAgICAgIHR5cGU6ICdlbmhhbmNlJyxcbiAgICAgIHN0YWNrOiBjYXB0dXJlU3RhY2tUcmFjZSh0aGlzLmVuaGFuY2UpLFxuICAgIH0pO1xuXG4gICAgLy8gRm9yIGludHJvc3BlY3QgcGx1Z2luXG4gICAgY29uc3Qge3ZhbHVlLCBhbGlhc2VzLCBlbmhhbmNlcnN9ID0gdGhpcy5yZWdpc3RlcmVkLmdldChcbiAgICAgIGdldFRva2VuUmVmKHRva2VuKVxuICAgICkgfHwge1xuICAgICAgYWxpYXNlczogbmV3IE1hcCgpLFxuICAgICAgZW5oYW5jZXJzOiBbXSxcbiAgICAgIHZhbHVlOiB1bmRlZmluZWQsXG4gICAgfTtcblxuICAgIGlmIChlbmhhbmNlcnMgJiYgQXJyYXkuaXNBcnJheShlbmhhbmNlcnMpKSB7XG4gICAgICAvLyBAdHMtaWdub3JlIChSZW1vdmUgb25jZSByZWZlcmVuY2VzIGFyZSB1c2VkKVxuICAgICAgZW5oYW5jZXJzLnB1c2goZW5oYW5jZXIpO1xuICAgIH1cbiAgICB0aGlzLnJlZ2lzdGVyZWQuc2V0KGdldFRva2VuUmVmKHRva2VuKSwge1xuICAgICAgdmFsdWUsXG4gICAgICBhbGlhc2VzLFxuICAgICAgZW5oYW5jZXJzLFxuICAgICAgdG9rZW4sXG4gICAgfSk7XG5cbiAgICByZXR1cm4gc3VwZXIuZW5oYW5jZSh0b2tlbiwgZW5oYW5jZXIpO1xuICB9XG5cbiAgY2xlYW51cCgpOiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiBQcm9taXNlLmFsbCh0aGlzLmNsZWFudXBzLm1hcCgoZm4pID0+IGZuKCkpKTtcbiAgfVxuXG4gIHJlc29sdmUoKSB7XG4gICAgaWYgKCF0aGlzLnJlbmRlcmVyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ01pc3NpbmcgcmVnaXN0cmF0aW9uIGZvciBSZW5kZXJUb2tlbicpO1xuICAgIH1cbiAgICB0aGlzLl9yZWdpc3RlcihSZW5kZXJUb2tlbiwgdGhpcy5yZW5kZXJlcik7XG5cbiAgICBpZiAodGhpcy5yZWdpc3RlcmVkVG9rZW5zLmhhcyhnZXRUb2tlblJlZihFbmFibGVNaWRkbGV3YXJlVGltaW5nVG9rZW4pKSkge1xuICAgICAgdGhpcy5lbmFibGVNaWRkbGV3YXJlVGltaW5nID0gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyBOb3RlIHRoYXQgY29yZSBpbml0IGFjdHVhbGx5IHJldHVybnMgYSBwcm9taXNlLlxuICAgIC8vIEhvd2V2ZXIsIGNvcmUgaW5pdCB3aWxsIHN5bmNocm9ub3VzbHkgY29tcGxldGUgYXMgbG9uZyBhcyB0aGVyZSBpcyBub1xuICAgIC8vIGFzeW5jIHRhc2tzLiBUaGUgb25seSBwbGFubmVkIGFzeW5jIGhvb2sgaXMgd2l0aFN0YXJ0dXAoKSwgd2hpY2ggaXMgbm90XG4gICAgLy8gY3VycmVudGx5IGltcGxlbWVudGVkLiBJbnRyb2R1Y2luZyBhc3luYyBzdGFydHVwIGlzIHRlY2huaWNhbGx5IGFcbiAgICAvLyBicmVha2luZyBjaGFuZ2UsIHdoaWNoIHdlIGFyZSBhdm9pZGluZyBpbml0aWFsbHkuIFdoZW4gd2Ugd2FudCB0byBtYWtlXG4gICAgLy8gdGhpcyBicmVha2luZyBjaGFuZ2UgYW5kIGludHJvZHVjZSB3aXRoU3RhcnR1cCgpLCB3ZSBzaG91bGQgYWRkIGFuIGF3YWl0XG4gICAgLy8gdG8gdGhlIHN0YXRlbWVudCBiZWxvd1xuICAgIHN1cGVyLmluaXQoKTtcblxuICAgIHNvcnRMZWdhY3kodGhpcyk7IC8vIFByZXNlcnZlIGxlZ2FjeSBvcmRlciBmb3IgY29tcGF0aWJpbGl0eVxuXG4gICAgdGhpcy5kb25lID0gdHJ1ZTtcbiAgfVxuXG4gIC8vIEB0cy1pZ25vcmUgKFJlbW92ZSBvbmNlIHJlZmVyZW5jZXMgYXJlIHVzZWQpXG4gIGdldFNlcnZpY2U8VFJlc29sdmVkPih0b2tlbjogVG9rZW48VFJlc29sdmVkPik6IFRSZXNvbHZlZCB7XG4gICAgaWYgKCF0aGlzLmRvbmUpIHtcbiAgICAgIHRocm93IG5ldyBESUVycm9yKHtcbiAgICAgICAgbWVzc2FnZTogJ0Nhbm5vdCBnZXQgc2VydmljZSBmcm9tIHVucmVzb2x2ZWQgYXBwJyxcbiAgICAgICAgY2FsbGVyOiB0aGlzLmdldFNlcnZpY2UsXG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc3QgcmVzdWx0ID0gZ2V0UmVzb2x2ZWREZXAodGhpcywgdG9rZW4pO1xuICAgIGlmIChyZXN1bHQucmVzb2x2ZWQpIHtcbiAgICAgIHJldHVybiByZXN1bHQudmFsdWU7XG4gICAgfVxuICB9XG5cbiAgY2FsbGJhY2soLi4uYXJnczogYW55W10pOiBQcm9taXNlPHZvaWQ+IHwgYW55IHt9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEJhc2VBcHA7XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQVFBO0FBQ0E7QUFDQTtBQU9BO0FBQ0E7QUFDQTtBQUVBO0FBQ0E7QUFBMkM7QUF0QjNDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUF5QkEsTUFBTUEsT0FBTyxTQUFTQyxTQUFJLENBQUM7RUFDekJDLFdBQVcsQ0FBQ0MsRUFBTyxFQUFFQyxNQUFXLEVBQUU7SUFDaEMsS0FBSyxFQUFFO0lBQ1AsSUFBSSxDQUFDQyxVQUFVLEdBQUcsSUFBSUMsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUM3QixJ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