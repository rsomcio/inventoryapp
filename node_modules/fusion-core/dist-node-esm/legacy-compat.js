import { withDeps, withUniversalMiddleware, withCleanup } from './core';
import { declarePlugin } from './create-plugin';
import { getTokenRef } from './create-token';
export function createPlugin(opts) {
  function* LegacyPlugin() {
    let resolvedDeps = {};
    const depKeys = opts.deps ? Object.keys(opts.deps) : [];
    if (depKeys.length) {
      const deps = yield withDeps(depKeys.map(key => opts.deps[key]));
      deps.forEach((dep, i) => {
        resolvedDeps[depKeys[i]] = dep;
      });
    }
    let providedValue;
    if (opts.provides) {
      providedValue = opts.provides(resolvedDeps);
    }
    if (opts.middleware) {
      let legacyMiddleware = opts.middleware(resolvedDeps, providedValue);
      withUniversalMiddleware(legacyMiddleware);
    }
    if (opts.cleanup && typeof opts.cleanup === 'function') {
      withCleanup(() => {
        opts.cleanup(providedValue);
      });
    }
    return providedValue;
  }
  return declarePlugin(LegacyPlugin);
}

// The core implementation yields a topological order of middleware, however
// it differs from the old implementation. In order to maintain compatibility
// with existing apps, we should sort this in the same way
export function sortLegacy(app) {
  let legacySorted = [];
  const seen = new Set();
  function visit(task) {
    if (seen.has(task)) {
      return;
    }
    seen.add(task);
    let requested = new Set(task.requested);
    for (let t of app.taskMap.values()) {
      if (requested.has(getTokenRef(t.id))) {
        visit(t);
      }
    }
    if (task.child) {
      visit(task.child);
    }
    if (task.middleware) {
      // @ts-ignore (Remove once references are used)
      legacySorted.push(task.middleware);
    }
    if (app.enhancerChainTails.has(getTokenRef(task.id))) {
      visit(app.taskMap.get(app.enhancerChainTails.get(getTokenRef(task.id))));
    }
  }
  for (let task of app.taskMap.values()) {
    if (!app.enhancerTokens.has(task.id)) {
      visit(task);
    }
  }
  app.plugins = legacySorted;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJ3aXRoRGVwcyIsIndpdGhVbml2ZXJzYWxNaWRkbGV3YXJlIiwid2l0aENsZWFudXAiLCJkZWNsYXJlUGx1Z2luIiwiZ2V0VG9rZW5SZWYiLCJjcmVhdGVQbHVnaW4iLCJvcHRzIiwiTGVnYWN5UGx1Z2luIiwicmVzb2x2ZWREZXBzIiwiZGVwS2V5cyIsImRlcHMiLCJPYmplY3QiLCJrZXlzIiwibGVuZ3RoIiwibWFwIiwia2V5IiwiZm9yRWFjaCIsImRlcCIsImkiLCJwcm92aWRlZFZhbHVlIiwicHJvdmlkZXMiLCJtaWRkbGV3YXJlIiwibGVnYWN5TWlkZGxld2FyZSIsImNsZWFudXAiLCJzb3J0TGVnYWN5IiwiYXBwIiwibGVnYWN5U29ydGVkIiwic2VlbiIsIlNldCIsInZpc2l0IiwidGFzayIsImhhcyIsImFkZCIsInJlcXVlc3RlZCIsInQiLCJ0YXNrTWFwIiwidmFsdWVzIiwiaWQiLCJjaGlsZCIsInB1c2giLCJlbmhhbmNlckNoYWluVGFpbHMiLCJnZXQiLCJlbmhhbmNlclRva2VucyIsInBsdWdpbnMiXSwic291cmNlcyI6WyJzcmMvbGVnYWN5LWNvbXBhdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge3dpdGhEZXBzLCB3aXRoVW5pdmVyc2FsTWlkZGxld2FyZSwgd2l0aENsZWFudXB9IGZyb20gJy4vY29yZSc7XG5pbXBvcnQge2RlY2xhcmVQbHVnaW59IGZyb20gJy4vY3JlYXRlLXBsdWdpbic7XG5cbmltcG9ydCB7Z2V0VG9rZW5SZWZ9IGZyb20gJy4vY3JlYXRlLXRva2VuJztcblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVBsdWdpbihvcHRzKSB7XG4gIGZ1bmN0aW9uKiBMZWdhY3lQbHVnaW4oKSB7XG4gICAgbGV0IHJlc29sdmVkRGVwcyA9IHt9O1xuICAgIGNvbnN0IGRlcEtleXMgPSBvcHRzLmRlcHMgPyBPYmplY3Qua2V5cyhvcHRzLmRlcHMpIDogW107XG4gICAgaWYgKGRlcEtleXMubGVuZ3RoKSB7XG4gICAgICBjb25zdCBkZXBzID0geWllbGQgd2l0aERlcHMoZGVwS2V5cy5tYXAoKGtleSkgPT4gb3B0cy5kZXBzW2tleV0pKTtcbiAgICAgIGRlcHMuZm9yRWFjaCgoZGVwLCBpKSA9PiB7XG4gICAgICAgIHJlc29sdmVkRGVwc1tkZXBLZXlzW2ldXSA9IGRlcDtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBsZXQgcHJvdmlkZWRWYWx1ZTtcbiAgICBpZiAob3B0cy5wcm92aWRlcykge1xuICAgICAgcHJvdmlkZWRWYWx1ZSA9IG9wdHMucHJvdmlkZXMocmVzb2x2ZWREZXBzKTtcbiAgICB9XG4gICAgaWYgKG9wdHMubWlkZGxld2FyZSkge1xuICAgICAgbGV0IGxlZ2FjeU1pZGRsZXdhcmUgPSBvcHRzLm1pZGRsZXdhcmUocmVzb2x2ZWREZXBzLCBwcm92aWRlZFZhbHVlKTtcbiAgICAgIHdpdGhVbml2ZXJzYWxNaWRkbGV3YXJlKGxlZ2FjeU1pZGRsZXdhcmUpO1xuICAgIH1cbiAgICBpZiAob3B0cy5jbGVhbnVwICYmIHR5cGVvZiBvcHRzLmNsZWFudXAgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHdpdGhDbGVhbnVwKCgpID0+IHtcbiAgICAgICAgb3B0cy5jbGVhbnVwKHByb3ZpZGVkVmFsdWUpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBwcm92aWRlZFZhbHVlO1xuICB9XG5cbiAgcmV0dXJuIGRlY2xhcmVQbHVnaW4oTGVnYWN5UGx1Z2luKTtcbn1cblxuLy8gVGhlIGNvcmUgaW1wbGVtZW50YXRpb24geWllbGRzIGEgdG9wb2xvZ2ljYWwgb3JkZXIgb2YgbWlkZGxld2FyZSwgaG93ZXZlclxuLy8gaXQgZGlmZmVycyBmcm9tIHRoZSBvbGQgaW1wbGVtZW50YXRpb24uIEluIG9yZGVyIHRvIG1haW50YWluIGNvbXBhdGliaWxpdHlcbi8vIHdpdGggZXhpc3RpbmcgYXBwcywgd2Ugc2hvdWxkIHNvcnQgdGhpcyBpbiB0aGUgc2FtZSB3YXlcbmV4cG9ydCBmdW5jdGlvbiBzb3J0TGVnYWN5KGFwcCkge1xuICBsZXQgbGVnYWN5U29ydGVkID0gW107XG5cbiAgY29uc3Qgc2VlbiA9IG5ldyBTZXQoKTtcbiAgZnVuY3Rpb24gdmlzaXQodGFzaykge1xuICAgIGlmIChzZWVuLmhhcyh0YXNrKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBzZWVuLmFkZCh0YXNrKTtcbiAgICBsZXQgcmVxdWVzdGVkID0gbmV3IFNldCh0YXNrLnJlcXVlc3RlZCk7XG4gICAgZm9yIChsZXQgdCBvZiBhcHAudGFza01hcC52YWx1ZXMoKSkge1xuICAgICAgaWYgKHJlcXVlc3RlZC5oYXMoZ2V0VG9rZW5SZWYodC5pZCkpKSB7XG4gICAgICAgIHZpc2l0KHQpO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAodGFzay5jaGlsZCkge1xuICAgICAgdmlzaXQodGFzay5jaGlsZCk7XG4gICAgfVxuXG4gICAgaWYgKHRhc2subWlkZGxld2FyZSkge1xuICAgICAgLy8gQHRzLWlnbm9yZSAoUmVtb3ZlIG9uY2UgcmVmZXJlbmNlcyBhcmUgdXNlZClcbiAgICAgIGxlZ2FjeVNvcnRlZC5wdXNoKHRhc2subWlkZGxld2FyZSk7XG4gICAgfVxuXG4gICAgaWYgKGFwcC5lbmhhbmNlckNoYWluVGFpbHMuaGFzKGdldFRva2VuUmVmKHRhc2suaWQpKSkge1xuICAgICAgdmlzaXQoYXBwLnRhc2tNYXAuZ2V0KGFwcC5lbmhhbmNlckNoYWluVGFpbHMuZ2V0KGdldFRva2VuUmVmKHRhc2suaWQpKSkpO1xuICAgIH1cbiAgfVxuXG4gIGZvciAobGV0IHRhc2sgb2YgYXBwLnRhc2tNYXAudmFsdWVzKCkpIHtcbiAgICBpZiAoIWFwcC5lbmhhbmNlclRva2Vucy5oYXModGFzay5pZCkpIHtcbiAgICAgIHZpc2l0KHRhc2spO1xuICAgIH1cbiAgfVxuXG4gIGFwcC5wbHVnaW5zID0gbGVnYWN5U29ydGVkO1xufVxuIl0sIm1hcHBpbmdzIjoiQUFBQSxTQUFRQSxRQUFRLEVBQUVDLHVCQUF1QixFQUFFQyxXQUFXLFFBQU8sUUFBUTtBQUNy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