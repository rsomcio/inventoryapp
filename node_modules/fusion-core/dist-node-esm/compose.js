/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

// inline version of koa-compose to get around Rollup/CUP commonjs-related issue
export function compose(middleware) {
  if (!Array.isArray(middleware)) {
    throw new TypeError('Middleware stack must be an array!');
  }
  for (const fn of middleware) {
    if (typeof fn !== 'function') {
      throw new TypeError(`Expected middleware function, received: ${typeof fn}`);
    }
  }
  return function (context, next) {
    let index = -1;
    return dispatch(0);
    function dispatch(i) {
      if (i <= index) {
        return Promise.reject(new Error('next() called multiple times'));
      }
      index = i;
      let fn = middleware[i];
      if (i === middleware.length) fn = next;
      if (!fn) return Promise.resolve();
      try {
        return fn(context, function next() {
          return dispatch(i + 1);
        });
      } catch (err) {
        return Promise.reject(err);
      }
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb21wb3NlIiwibWlkZGxld2FyZSIsIkFycmF5IiwiaXNBcnJheSIsIlR5cGVFcnJvciIsImZuIiwiY29udGV4dCIsIm5leHQiLCJpbmRleCIsImRpc3BhdGNoIiwiaSIsIlByb21pc2UiLCJyZWplY3QiLCJFcnJvciIsImxlbmd0aCIsInJlc29sdmUiLCJlcnIiXSwic291cmNlcyI6WyJzcmMvY29tcG9zZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKiogQ29weXJpZ2h0IChjKSAyMDE4IFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICovXG5cbmltcG9ydCB0eXBlIHtNaWRkbGV3YXJlfSBmcm9tICcuL3R5cGVzJztcblxuLy8gaW5saW5lIHZlcnNpb24gb2Yga29hLWNvbXBvc2UgdG8gZ2V0IGFyb3VuZCBSb2xsdXAvQ1VQIGNvbW1vbmpzLXJlbGF0ZWQgaXNzdWVcbmV4cG9ydCBmdW5jdGlvbiBjb21wb3NlKG1pZGRsZXdhcmU6IEFycmF5PE1pZGRsZXdhcmU+KTogTWlkZGxld2FyZSB7XG4gIGlmICghQXJyYXkuaXNBcnJheShtaWRkbGV3YXJlKSkge1xuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ01pZGRsZXdhcmUgc3RhY2sgbXVzdCBiZSBhbiBhcnJheSEnKTtcbiAgfVxuICBmb3IgKGNvbnN0IGZuIG9mIG1pZGRsZXdhcmUpIHtcbiAgICBpZiAodHlwZW9mIGZuICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFxuICAgICAgICBgRXhwZWN0ZWQgbWlkZGxld2FyZSBmdW5jdGlvbiwgcmVjZWl2ZWQ6ICR7dHlwZW9mIGZufWBcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGZ1bmN0aW9uIChjb250ZXh0LCBuZXh0KSB7XG4gICAgbGV0IGluZGV4ID0gLTE7XG4gICAgcmV0dXJuIGRpc3BhdGNoKDApO1xuICAgIGZ1bmN0aW9uIGRpc3BhdGNoKGkpIHtcbiAgICAgIGlmIChpIDw9IGluZGV4KSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ25leHQoKSBjYWxsZWQgbXVsdGlwbGUgdGltZXMnKSk7XG4gICAgICB9XG4gICAgICBpbmRleCA9IGk7XG4gICAgICBsZXQgZm4gPSBtaWRkbGV3YXJlW2ldO1xuICAgICAgaWYgKGkgPT09IG1pZGRsZXdhcmUubGVuZ3RoKSBmbiA9IG5leHQ7XG4gICAgICBpZiAoIWZuKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICB0cnkge1xuICAgICAgICByZXR1cm4gZm4oY29udGV4dCwgZnVuY3Rpb24gbmV4dCgpIHtcbiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2goaSArIDEpO1xuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG59XG4iXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFJQTtBQUNBLE9BQU8sU0FBU0EsT0FBTyxDQUFDQyxVQUE2QixFQUFjO0VBQ2pFLElBQUksQ0FBQ0MsS0FBSyxDQUFDQyxPQUFPLENBQUNGLFVBQVUsQ0FBQyxFQUFFO0lBQzlCLE1BQU0sSUFBSUcsU0FBUyxDQUFDLG9DQUFvQyxDQUFDO0VBQzNEO0VBQ0EsS0FBSyxNQUFNQyxFQUFFLElBQUlKLFVBQVUsRUFBRTtJQUMzQixJQUFJLE9BQU9JLEVBQUUsS0FBSyxVQUFVLEVBQUU7TUFDNUIsTUFBTSxJQUFJRCxTQUFTLENBQ2hCLDJDQUEwQyxPQUFPQyxFQUFHLEVBQUMsQ0FDdkQ7SUFDSDtFQUNGO0VBRUEsT0FBTyxVQUFVQyxPQUFPLEVBQUVDLElBQUksRUFBRTtJQUM5QixJQUFJQyxLQUFLLEdBQUcsQ0FBQyxDQUFDO0lBQ2QsT0FBT0MsUUFBUSxDQUFDLENBQUMsQ0FBQztJQUNsQixTQUFTQSxRQUFRLENBQUNDLENBQUMsRUFBRTtNQUNuQixJQUFJQSxDQUFDLElBQUlGLEtBQUssRUFBRTtRQUNkLE9BQU9HLE9BQU8sQ0FBQ0MsTUFBTSxDQUFDLElBQUlDLEtBQUssQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO01BQ2xFO01BQ0FMLEtBQUssR0FBR0UsQ0FBQztNQUNULElBQUlMLEVBQUUsR0FBR0osVUFBVSxDQUFDUyxDQUFDLENBQUM7TUFDdEIsSUFBSUEsQ0FBQyxLQUFLVCxVQUFVLENBQUNhLE1BQU0sRUFBRVQsRUFBRSxHQUFHRSxJQUFJO01BQ3RDLElBQUksQ0FBQ0YsRUFBRSxFQUFFLE9BQU9NLE9BQU8sQ0FBQ0ksT0FBTyxFQUFFO01BQ2pDLElBQUk7UUFDRixPQUFPVixFQUFFLENBQUNDLE9BQU8sRUFBRSxTQUFTQyxJQUFJLEdBQUc7VUFDakMsT0FBT0UsUUFBUSxDQUFDQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3hCLENBQUMsQ0FBQztNQUNKLENBQUMsQ0FBQyxPQUFPTSxHQUFHLEVBQUU7UUFDWixPQUFPTCxPQUFPLENBQUNDLE1BQU0sQ0FBQ0ksR0FBRyxDQUFDO01BQzVCO0lBQ0Y7RUFDRixDQUFDO0FBQ0gifQ==