/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

import { now } from './now';
const getSources = stacks => {
  // stack is of format: 'at file_xyz.js (/some/file/system/path.js:30:1)\n'
  return stacks.map(({
    type,
    stack = ''
  }) => {
    return {
      type,
      source: stack.split('\n').map(line => line.match(/\((.*?)\)/)).filter(match => match && match[1]).map(match => match[1]).map(to => false ? path.relative(process.cwd(), to) : to).shift()
    };
  });
};

// Wraps middleware for measuring middleware timing
export default function wrapMiddleware(existingMiddleware, token) {
  return async (ctx, next) => {
    const downstreamStart = now();
    let upstreamStart = 0;
    const timing = {
      token: token.name,
      source: JSON.stringify(getSources(token.stacks)),
      downstream: -1,
      upstream: -1
    };
    if (ctx.timing) {
      ctx.timing.middleware.push(timing);
    }
    const wrapNext = async () => {
      timing.downstream = now() - downstreamStart;
      await next();
      upstreamStart = now();
    };
    await existingMiddleware(ctx, wrapNext);
    timing.upstream = now() - upstreamStart;
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJub3ciLCJnZXRTb3VyY2VzIiwic3RhY2tzIiwibWFwIiwidHlwZSIsInN0YWNrIiwic291cmNlIiwic3BsaXQiLCJsaW5lIiwibWF0Y2giLCJmaWx0ZXIiLCJ0byIsInBhdGgiLCJyZWxhdGl2ZSIsInByb2Nlc3MiLCJjd2QiLCJzaGlmdCIsIndyYXBNaWRkbGV3YXJlIiwiZXhpc3RpbmdNaWRkbGV3YXJlIiwidG9rZW4iLCJjdHgiLCJuZXh0IiwiZG93bnN0cmVhbVN0YXJ0IiwidXBzdHJlYW1TdGFydCIsInRpbWluZyIsIm5hbWUiLCJKU09OIiwic3RyaW5naWZ5IiwiZG93bnN0cmVhbSIsInVwc3RyZWFtIiwibWlkZGxld2FyZSIsInB1c2giLCJ3cmFwTmV4dCJdLCJzb3VyY2VzIjpbInNyYy91dGlscy93cmFwLW1pZGRsZXdhcmUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqIENvcHlyaWdodCAoYykgMjAxOCBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqL1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQge25vd30gZnJvbSAnLi9ub3cnO1xuXG5pbXBvcnQgdHlwZSB7Q29udGV4dCwgTWlkZGxld2FyZX0gZnJvbSAnLi4vdHlwZXMnO1xuXG50eXBlIFN0YWNrc0Zvcm1hdCA9IHtcbiAgdHlwZTogJ3Rva2VuJyB8ICdyZWdpc3RlcicgfCAncGx1Z2luJztcbiAgc3RhY2s6IHN0cmluZztcbn07XG5cbmNvbnN0IGdldFNvdXJjZXMgPSAoc3RhY2tzOiBBcnJheTxTdGFja3NGb3JtYXQ+KSA9PiB7XG4gIC8vIHN0YWNrIGlzIG9mIGZvcm1hdDogJ2F0IGZpbGVfeHl6LmpzICgvc29tZS9maWxlL3N5c3RlbS9wYXRoLmpzOjMwOjEpXFxuJ1xuICByZXR1cm4gc3RhY2tzLm1hcCgoe3R5cGUsIHN0YWNrID0gJyd9KSA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGUsXG4gICAgICBzb3VyY2U6IHN0YWNrXG4gICAgICAgIC5zcGxpdCgnXFxuJylcbiAgICAgICAgLm1hcCgobGluZSkgPT4gbGluZS5tYXRjaCgvXFwoKC4qPylcXCkvKSlcbiAgICAgICAgLmZpbHRlcigobWF0Y2gpID0+IG1hdGNoICYmIG1hdGNoWzFdKVxuICAgICAgICAubWFwKChtYXRjaCkgPT4gKG1hdGNoIGFzIGFueSBhcyBBcnJheTxzdHJpbmc+KVsxXSlcbiAgICAgICAgLm1hcCgodG8pID0+IChfX05PREVfXyA/IHBhdGgucmVsYXRpdmUocHJvY2Vzcy5jd2QoKSwgdG8pIDogdG8pKVxuICAgICAgICAuc2hpZnQoKSxcbiAgICB9O1xuICB9KTtcbn07XG5cbi8vIFdyYXBzIG1pZGRsZXdhcmUgZm9yIG1lYXN1cmluZyBtaWRkbGV3YXJlIHRpbWluZ1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gd3JhcE1pZGRsZXdhcmUoXG4gIGV4aXN0aW5nTWlkZGxld2FyZTogTWlkZGxld2FyZSxcbiAgdG9rZW46IGFueVxuKTogTWlkZGxld2FyZSB7XG4gIHJldHVybiBhc3luYyAoY3R4OiBDb250ZXh0LCBuZXh0KSA9PiB7XG4gICAgY29uc3QgZG93bnN0cmVhbVN0YXJ0ID0gbm93KCk7XG4gICAgbGV0IHVwc3RyZWFtU3RhcnQgPSAwO1xuXG4gICAgY29uc3QgdGltaW5nID0ge1xuICAgICAgdG9rZW46IHRva2VuLm5hbWUsXG4gICAgICBzb3VyY2U6IEpTT04uc3RyaW5naWZ5KGdldFNvdXJjZXModG9rZW4uc3RhY2tzKSksXG4gICAgICBkb3duc3RyZWFtOiAtMSxcbiAgICAgIHVwc3RyZWFtOiAtMSxcbiAgICB9O1xuICAgIGlmIChjdHgudGltaW5nKSB7XG4gICAgICBjdHgudGltaW5nLm1pZGRsZXdhcmUucHVzaCh0aW1pbmcpO1xuICAgIH1cblxuICAgIGNvbnN0IHdyYXBOZXh0ID0gYXN5bmMgKCkgPT4ge1xuICAgICAgdGltaW5nLmRvd25zdHJlYW0gPSBub3coKSAtIGRvd25zdHJlYW1TdGFydDtcbiAgICAgIGF3YWl0IG5leHQoKTtcbiAgICAgIHVwc3RyZWFtU3RhcnQgPSBub3coKTtcbiAgICB9O1xuICAgIGF3YWl0IGV4aXN0aW5nTWlkZGxld2FyZShjdHgsIHdyYXBOZXh0KTtcbiAgICB0aW1pbmcudXBzdHJlYW0gPSBub3coKSAtIHVwc3RyZWFtU3RhcnQ7XG4gIH07XG59XG4iXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxTQUFRQSxHQUFHLFFBQU8sT0FBTztBQVN6QixNQUFNQyxVQUFVLEdBQUlDLE1BQTJCLElBQUs7RUFDbEQ7RUFDQSxPQUFPQSxNQUFNLENBQUNDLEdBQUcsQ0FBQyxDQUFDO0lBQUNDLElBQUk7SUFBRUMsS0FBSyxHQUFHO0VBQUUsQ0FBQyxLQUFLO0lBQ3hDLE9BQU87TUFDTEQsSUFBSTtNQUNKRSxNQUFNLEVBQUVELEtBQUssQ0FDVkUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUNYSixHQUFHLENBQUVLLElBQUksSUFBS0EsSUFBSSxDQUFDQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FDdENDLE1BQU0sQ0FBRUQsS0FBSyxJQUFLQSxLQUFLLElBQUlBLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUNwQ04sR0FBRyxDQUFFTSxLQUFLLElBQU1BLEtBQUssQ0FBMEIsQ0FBQyxDQUFDLENBQUMsQ0FDbEROLEdBQUcsQ0FBRVEsRUFBRSxJQUFNLFFBQVdDLElBQUksQ0FBQ0MsUUFBUSxDQUFDQyxPQUFPLENBQUNDLEdBQUcsRUFBRSxFQUFFSixFQUFFLENBQUMsR0FBR0EsRUFBRyxDQUFDLENBQy9ESyxLQUFLO0lBQ1YsQ0FBQztFQUNILENBQUMsQ0FBQztBQUNKLENBQUM7O0FBRUQ7QUFDQSxlQUFlLFNBQVNDLGNBQWMsQ0FDcENDLGtCQUE4QixFQUM5QkMsS0FBVSxFQUNFO0VBQ1osT0FBTyxPQUFPQyxHQUFZLEVBQUVDLElBQUksS0FBSztJQUNuQyxNQUFNQyxlQUFlLEdBQUd0QixHQUFHLEVBQUU7SUFDN0IsSUFBSXVCLGFBQWEsR0FBRyxDQUFDO0lBRXJCLE1BQU1DLE1BQU0sR0FBRztNQUNiTCxLQUFLLEVBQUVBLEtBQUssQ0FBQ00sSUFBSTtNQUNqQm5CLE1BQU0sRUFBRW9CLElBQUksQ0FBQ0MsU0FBUyxDQUFDMUIsVUFBVSxDQUFDa0IsS0FBSyxDQUFDakIsTUFBTSxDQUFDLENBQUM7TUFDaEQwQixVQUFVLEVBQUUsQ0FBQyxDQUFDO01BQ2RDLFFBQVEsRUFBRSxDQUFDO0lBQ2IsQ0FBQztJQUNELElBQUlULEdBQUcsQ0FBQ0ksTUFBTSxFQUFFO01BQ2RKLEdBQUcsQ0FBQ0ksTUFBTSxDQUFDTSxVQUFVLENBQUNDLElBQUksQ0FBQ1AsTUFBTSxDQUFDO0lBQ3BDO0lBRUEsTUFBTVEsUUFBUSxHQUFHLFlBQVk7TUFDM0JSLE1BQU0sQ0FBQ0ksVUFBVSxHQUFHNUIsR0FBRyxFQUFFLEdBQUdzQixlQUFlO01BQzNDLE1BQU1ELElBQUksRUFBRTtNQUNaRSxhQUFhLEdBQUd2QixHQUFHLEVBQUU7SUFDdkIsQ0FBQztJQUNELE1BQU1rQixrQkFBa0IsQ0FBQ0UsR0FBRyxFQUFFWSxRQUFRLENBQUM7SUFDdkNSLE1BQU0sQ0FBQ0ssUUFBUSxHQUFHN0IsR0FBRyxFQUFFLEdBQUd1QixhQUFhO0VBQ3pDLENBQUM7QUFDSCJ9