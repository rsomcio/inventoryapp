/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

import App from '../index';
import { compose } from '../compose';
test('context composition', async () => {
  const element = 'hello';
  const render = el => `<h1>${el}</h1>`;
  const wrap = (ctx, next) => {
    ctx.element = ctx.element.toUpperCase();
    return next();
  };
  const chunkUrlMap = new Map();
  const chunkIdZero = new Map();
  chunkIdZero.set('es5', 'es5-file.js');
  chunkUrlMap.set(0, chunkIdZero);
  const context = {
    method: 'GET',
    headers: {
      accept: 'text/html'
    },
    path: '/',
    syncChunks: [0],
    preloadChunks: [],
    chunkUrlMap,
    webpackPublicPath: '/',
    element: null,
    rendered: null,
    render: null,
    type: null,
    body: null
  };
  const app = new App(element, render);
  app.middleware(wrap);
  app.resolve();
  const middleware = compose(app.plugins);
  await expect(
  // @ts-expect-errors
  middleware(context, () => Promise.resolve())).resolves.not.toThrow();
  expect(typeof context.rendered).toBe('string');
  expect(context.rendered.includes('<h1>HELLO</h1>')).toBeTruthy();
});
test('context composition with a cdn', async () => {
  const element = 'hello';
  const render = el => `<h1>${el}</h1>`;
  const wrap = () => (ctx, next) => {
    ctx.element = ctx.element.toUpperCase();
    return next();
  };
  const chunkUrlMap = new Map();
  const chunkIdZero = new Map();
  chunkIdZero.set('es5', 'es5-file.js');
  chunkUrlMap.set(0, chunkIdZero);
  const context = {
    method: 'GET',
    headers: {
      accept: 'text/html'
    },
    path: '/',
    syncChunks: [0],
    preloadChunks: [],
    chunkUrlMap,
    webpackPublicPath: 'https://something.com/lol',
    element: null,
    rendered: null,
    render: null,
    type: null,
    body: null
  };
  const app = new App(element, render);
  app.middleware(wrap());
  app.resolve();
  const middleware = compose(app.plugins);
  await expect(middleware(context, () => Promise.resolve())).resolves.not.toThrow();
  expect(context.body.includes('https://something.com/lol/es5-file.js')).toBeTruthy();
});
test('prepare boundary works', async () => {
  const element = 'hello';
  const render = el => `<h1>${el}</h1>`;
  const app = new App(element, render);
  let done = false;
  app.prepareBoundary.addEffect(() => {
    done = true;
  });
  app.prepareBoundary.done();
  expect(done).toEqual(true);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJBcHAiLCJjb21wb3NlIiwidGVzdCIsImVsZW1lbnQiLCJyZW5kZXIiLCJlbCIsIndyYXAiLCJjdHgiLCJuZXh0IiwidG9VcHBlckNhc2UiLCJjaHVua1VybE1hcCIsIk1hcCIsImNodW5rSWRaZXJvIiwic2V0IiwiY29udGV4dCIsIm1ldGhvZCIsImhlYWRlcnMiLCJhY2NlcHQiLCJwYXRoIiwic3luY0NodW5rcyIsInByZWxvYWRDaHVua3MiLCJ3ZWJwYWNrUHVibGljUGF0aCIsInJlbmRlcmVkIiwidHlwZSIsImJvZHkiLCJhcHAiLCJtaWRkbGV3YXJlIiwicmVzb2x2ZSIsInBsdWdpbnMiLCJleHBlY3QiLCJQcm9taXNlIiwicmVzb2x2ZXMiLCJub3QiLCJ0b1Rocm93IiwidG9CZSIsImluY2x1ZGVzIiwidG9CZVRydXRoeSIsImRvbmUiLCJwcmVwYXJlQm91bmRhcnkiLCJhZGRFZmZlY3QiLCJ0b0VxdWFsIl0sInNvdXJjZXMiOlsic3JjL19fdGVzdHNfXy9hcHAubm9kZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKiogQ29weXJpZ2h0IChjKSAyMDE4IFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICovXG5cbmltcG9ydCBBcHAgZnJvbSAnLi4vaW5kZXgnO1xuaW1wb3J0IHtjb21wb3NlfSBmcm9tICcuLi9jb21wb3NlJztcblxuaW1wb3J0IHR5cGUge0NvbnRleHR9IGZyb20gJy4uL3R5cGVzJztcblxudGVzdCgnY29udGV4dCBjb21wb3NpdGlvbicsIGFzeW5jICgpID0+IHtcbiAgY29uc3QgZWxlbWVudCA9ICdoZWxsbyc7XG4gIGNvbnN0IHJlbmRlciA9IChlbCkgPT4gYDxoMT4ke2VsfTwvaDE+YDtcbiAgY29uc3Qgd3JhcCA9IChjdHgsIG5leHQpID0+IHtcbiAgICBjdHguZWxlbWVudCA9IGN0eC5lbGVtZW50LnRvVXBwZXJDYXNlKCk7XG4gICAgcmV0dXJuIG5leHQoKTtcbiAgfTtcbiAgY29uc3QgY2h1bmtVcmxNYXAgPSBuZXcgTWFwKCk7XG4gIGNvbnN0IGNodW5rSWRaZXJvID0gbmV3IE1hcCgpO1xuICBjaHVua0lkWmVyby5zZXQoJ2VzNScsICdlczUtZmlsZS5qcycpO1xuICBjaHVua1VybE1hcC5zZXQoMCwgY2h1bmtJZFplcm8pO1xuICBjb25zdCBjb250ZXh0ID0ge1xuICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgaGVhZGVyczoge2FjY2VwdDogJ3RleHQvaHRtbCd9LFxuICAgIHBhdGg6ICcvJyxcbiAgICBzeW5jQ2h1bmtzOiBbMF0sXG4gICAgcHJlbG9hZENodW5rczogW10sXG4gICAgY2h1bmtVcmxNYXAsXG4gICAgd2VicGFja1B1YmxpY1BhdGg6ICcvJyxcbiAgICBlbGVtZW50OiBudWxsLFxuICAgIHJlbmRlcmVkOiBudWxsLFxuICAgIHJlbmRlcjogbnVsbCxcbiAgICB0eXBlOiBudWxsLFxuICAgIGJvZHk6IG51bGwsXG4gIH07XG5cbiAgY29uc3QgYXBwID0gbmV3IEFwcChlbGVtZW50LCByZW5kZXIpO1xuICBhcHAubWlkZGxld2FyZSh3cmFwKTtcbiAgYXBwLnJlc29sdmUoKTtcbiAgY29uc3QgbWlkZGxld2FyZSA9IGNvbXBvc2UoYXBwLnBsdWdpbnMpO1xuICBhd2FpdCBleHBlY3QoXG4gICAgLy8gQHRzLWV4cGVjdC1lcnJvcnNcbiAgICBtaWRkbGV3YXJlKGNvbnRleHQsICgpID0+IFByb21pc2UucmVzb2x2ZSgpKVxuICApLnJlc29sdmVzLm5vdC50b1Rocm93KCk7XG4gIGV4cGVjdCh0eXBlb2YgY29udGV4dC5yZW5kZXJlZCkudG9CZSgnc3RyaW5nJyk7XG4gIGV4cGVjdChjb250ZXh0LnJlbmRlcmVkLmluY2x1ZGVzKCc8aDE+SEVMTE88L2gxPicpKS50b0JlVHJ1dGh5KCk7XG59KTtcblxudGVzdCgnY29udGV4dCBjb21wb3NpdGlvbiB3aXRoIGEgY2RuJywgYXN5bmMgKCkgPT4ge1xuICBjb25zdCBlbGVtZW50ID0gJ2hlbGxvJztcbiAgY29uc3QgcmVuZGVyID0gKGVsKSA9PiBgPGgxPiR7ZWx9PC9oMT5gO1xuICBjb25zdCB3cmFwID0gKCkgPT4gKGN0eDogQ29udGV4dCwgbmV4dDogKCkgPT4gUHJvbWlzZTx2b2lkPikgPT4ge1xuICAgIGN0eC5lbGVtZW50ID0gY3R4LmVsZW1lbnQudG9VcHBlckNhc2UoKTtcbiAgICByZXR1cm4gbmV4dCgpO1xuICB9O1xuICBjb25zdCBjaHVua1VybE1hcCA9IG5ldyBNYXAoKTtcbiAgY29uc3QgY2h1bmtJZFplcm8gPSBuZXcgTWFwKCk7XG4gIGNodW5rSWRaZXJvLnNldCgnZXM1JywgJ2VzNS1maWxlLmpzJyk7XG4gIGNodW5rVXJsTWFwLnNldCgwLCBjaHVua0lkWmVybyk7XG4gIGNvbnN0IGNvbnRleHQgPSB7XG4gICAgbWV0aG9kOiAnR0VUJyxcbiAgICBoZWFkZXJzOiB7YWNjZXB0OiAndGV4dC9odG1sJ30sXG4gICAgcGF0aDogJy8nLFxuICAgIHN5bmNDaHVua3M6IFswXSxcbiAgICBwcmVsb2FkQ2h1bmtzOiBbXSxcbiAgICBjaHVua1VybE1hcCxcbiAgICB3ZWJwYWNrUHVibGljUGF0aDogJ2h0dHBzOi8vc29tZXRoaW5nLmNvbS9sb2wnLFxuICAgIGVsZW1lbnQ6IG51bGwsXG4gICAgcmVuZGVyZWQ6IG51bGwsXG4gICAgcmVuZGVyOiBudWxsLFxuICAgIHR5cGU6IG51bGwsXG4gICAgYm9keTogbnVsbCxcbiAgfTtcblxuICBjb25zdCBhcHAgPSBuZXcgQXBwKGVsZW1lbnQsIHJlbmRlcik7XG4gIGFwcC5taWRkbGV3YXJlKHdyYXAoKSk7XG4gIGFwcC5yZXNvbHZlKCk7XG4gIGNvbnN0IG1pZGRsZXdhcmUgPSBjb21wb3NlKGFwcC5wbHVnaW5zKTtcbiAgYXdhaXQgZXhwZWN0KFxuICAgIG1pZGRsZXdhcmUoY29udGV4dCBhcyBhbnkgYXMgQ29udGV4dCwgKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkpXG4gICkucmVzb2x2ZXMubm90LnRvVGhyb3coKTtcbiAgZXhwZWN0KFxuICAgIGNvbnRleHQuYm9keS5pbmNsdWRlcygnaHR0cHM6Ly9zb21ldGhpbmcuY29tL2xvbC9lczUtZmlsZS5qcycpXG4gICkudG9CZVRydXRoeSgpO1xufSk7XG5cbnRlc3QoJ3ByZXBhcmUgYm91bmRhcnkgd29ya3MnLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IGVsZW1lbnQgPSAnaGVsbG8nO1xuICBjb25zdCByZW5kZXIgPSAoZWwpID0+IGA8aDE+JHtlbH08L2gxPmA7XG5cbiAgY29uc3QgYXBwID0gbmV3IEFwcChlbGVtZW50LCByZW5kZXIpO1xuXG4gIGxldCBkb25lID0gZmFsc2U7XG4gIGFwcC5wcmVwYXJlQm91bmRhcnkuYWRkRWZmZWN0KCgpID0+IHtcbiAgICBkb25lID0gdHJ1ZTtcbiAgfSk7XG4gIGFwcC5wcmVwYXJlQm91bmRhcnkuZG9uZSgpO1xuICBleHBlY3QoZG9uZSkudG9FcXVhbCh0cnVlKTtcbn0pO1xuIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsR0FBRyxNQUFNLFVBQVU7QUFDMUIsU0FBUUMsT0FBTyxRQUFPLFlBQVk7QUFJbENDLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxZQUFZO0VBQ3RDLE1BQU1DLE9BQU8sR0FBRyxPQUFPO0VBQ3ZCLE1BQU1DLE1BQU0sR0FBSUMsRUFBRSxJQUFNLE9BQU1BLEVBQUcsT0FBTTtFQUN2QyxNQUFNQyxJQUFJLEdBQUcsQ0FBQ0MsR0FBRyxFQUFFQyxJQUFJLEtBQUs7SUFDMUJELEdBQUcsQ0FBQ0osT0FBTyxHQUFHSSxHQUFHLENBQUNKLE9BQU8sQ0FBQ00sV0FBVyxFQUFFO0lBQ3ZDLE9BQU9ELElBQUksRUFBRTtFQUNmLENBQUM7RUFDRCxNQUFNRSxXQUFXLEdBQUcsSUFBSUMsR0FBRyxFQUFFO0VB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