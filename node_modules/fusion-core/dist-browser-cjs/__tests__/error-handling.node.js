"use strict";

var _clientApp = _interopRequireDefault(require("../client-app"));
var _testHelper = require("./test-helper");
var _tokens = require("../tokens");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
const App = true ? (0, _clientApp.default)() : ServerAppFactory();
afterEach(() => {
  jest.clearAllMocks();
});

// in tests we don't invoke koa's error handler as apposed to dev/prod env hence error is picked up by node
// https://github.com/koajs/koa/blob/9d2afef286c9b2a1bc456d70fd1e8136fcf91c83/lib/application.js#L142-L145
test('by default there is no error listner so error is picked up by node', async () => {
  expect.assertions(1);
  const element = 'hi';
  const renderFn = el => {
    return el;
  };
  const app = new App(element, renderFn);
  const socketErr = new Error('boom');
  app.middleware(ctx => {
    // @ts-expect-error  using undocumented api for the test
    app._app.emit('error', socketErr, ctx);
  });
  await (0, _testHelper.run)(app).catch(e => {
    expect(e.code).toBe('ERR_UNHANDLED_ERROR');
  });
});
test('overrides default console error with  a custom function', async () => {
  expect.assertions(1);
  const element = 'hi';
  const renderFn = el => {
    return el;
  };
  const app = new App(element, renderFn);
  const socketErr = new Error('boom');
  const errorHandler = jest.fn();
  app.register(_tokens.ErrorHandlerToken, errorHandler);
  app.middleware(ctx => {
    // @ts-expect-error  using undocumented api for the test
    app._app.emit('error', socketErr, ctx);
  });
  await (0, _testHelper.run)(app);
  expect(errorHandler).toHaveBeenCalledWith(socketErr, 'request', expect.any(Object));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJBcHAiLCJDbGllbnRBcHBGYWN0b3J5IiwiU2VydmVyQXBwRmFjdG9yeSIsImFmdGVyRWFjaCIsImplc3QiLCJjbGVhckFsbE1vY2tzIiwidGVzdCIsImV4cGVjdCIsImFzc2VydGlvbnMiLCJlbGVtZW50IiwicmVuZGVyRm4iLCJlbCIsImFwcCIsInNvY2tldEVyciIsIkVycm9yIiwibWlkZGxld2FyZSIsImN0eCIsIl9hcHAiLCJlbWl0IiwicnVuIiwiY2F0Y2giLCJlIiwiY29kZSIsInRvQmUiLCJlcnJvckhhbmRsZXIiLCJmbiIsInJlZ2lzdGVyIiwiRXJyb3JIYW5kbGVyVG9rZW4iLCJ0b0hhdmVCZWVuQ2FsbGVkV2l0aCIsImFueSIsIk9iamVjdCJdLCJzb3VyY2VzIjpbInNyYy9fX3Rlc3RzX18vZXJyb3ItaGFuZGxpbmcubm9kZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQ2xpZW50QXBwRmFjdG9yeSBmcm9tICcuLi9jbGllbnQtYXBwJztcbmltcG9ydCBTZXJ2ZXJBcHBGYWN0b3J5IGZyb20gJy4uL3NlcnZlci1hcHAnO1xuaW1wb3J0IHtydW59IGZyb20gJy4vdGVzdC1oZWxwZXInO1xuaW1wb3J0IHtFcnJvckhhbmRsZXJUb2tlbn0gZnJvbSAnLi4vdG9rZW5zJztcblxuY29uc3QgQXBwID0gX19CUk9XU0VSX18gPyBDbGllbnRBcHBGYWN0b3J5KCkgOiBTZXJ2ZXJBcHBGYWN0b3J5KCk7XG5cbmFmdGVyRWFjaCgoKSA9PiB7XG4gIGplc3QuY2xlYXJBbGxNb2NrcygpO1xufSk7XG5cbi8vIGluIHRlc3RzIHdlIGRvbid0IGludm9rZSBrb2EncyBlcnJvciBoYW5kbGVyIGFzIGFwcG9zZWQgdG8gZGV2L3Byb2QgZW52IGhlbmNlIGVycm9yIGlzIHBpY2tlZCB1cCBieSBub2RlXG4vLyBodHRwczovL2dpdGh1Yi5jb20va29hanMva29hL2Jsb2IvOWQyYWZlZjI4NmM5YjJhMWJjNDU2ZDcwZmQxZTgxMzZmY2Y5MWM4My9saWIvYXBwbGljYXRpb24uanMjTDE0Mi1MMTQ1XG50ZXN0KCdieSBkZWZhdWx0IHRoZXJlIGlzIG5vIGVycm9yIGxpc3RuZXIgc28gZXJyb3IgaXMgcGlja2VkIHVwIGJ5IG5vZGUnLCBhc3luYyAoKSA9PiB7XG4gIGV4cGVjdC5hc3NlcnRpb25zKDEpO1xuICBjb25zdCBlbGVtZW50ID0gJ2hpJztcbiAgY29uc3QgcmVuZGVyRm4gPSAoZWwpID0+IHtcbiAgICByZXR1cm4gZWw7XG4gIH07XG4gIGNvbnN0IGFwcCA9IG5ldyBBcHAoZWxlbWVudCwgcmVuZGVyRm4pO1xuICBjb25zdCBzb2NrZXRFcnIgPSBuZXcgRXJyb3IoJ2Jvb20nKTtcbiAgYXBwLm1pZGRsZXdhcmUoKGN0eCkgPT4ge1xuICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgIHVzaW5nIHVuZG9jdW1lbnRlZCBhcGkgZm9yIHRoZSB0ZXN0XG4gICAgYXBwLl9hcHAuZW1pdCgnZXJyb3InLCBzb2NrZXRFcnIsIGN0eCk7XG4gIH0pO1xuXG4gIGF3YWl0IHJ1bihhcHApLmNhdGNoKChlKSA9PiB7XG4gICAgZXhwZWN0KGUuY29kZSkudG9CZSgnRVJSX1VOSEFORExFRF9FUlJPUicpO1xuICB9KTtcbn0pO1xuXG50ZXN0KCdvdmVycmlkZXMgZGVmYXVsdCBjb25zb2xlIGVycm9yIHdpdGggIGEgY3VzdG9tIGZ1bmN0aW9uJywgYXN5bmMgKCkgPT4ge1xuICBleHBlY3QuYXNzZXJ0aW9ucygxKTtcbiAgY29uc3QgZWxlbWVudCA9ICdoaSc7XG4gIGNvbnN0IHJlbmRlckZuID0gKGVsKSA9PiB7XG4gICAgcmV0dXJuIGVsO1xuICB9O1xuICBjb25zdCBhcHAgPSBuZXcgQXBwKGVsZW1lbnQsIHJlbmRlckZuKTtcbiAgY29uc3Qgc29ja2V0RXJyID0gbmV3IEVycm9yKCdib29tJyk7XG4gIGNvbnN0IGVycm9ySGFuZGxlciA9IGplc3QuZm4oKTtcbiAgYXBwLnJlZ2lzdGVyKEVycm9ySGFuZGxlclRva2VuLCBlcnJvckhhbmRsZXIpO1xuICBhcHAubWlkZGxld2FyZSgoY3R4KSA9PiB7XG4gICAgLy8gQHRzLWV4cGVjdC1lcnJvciAgdXNpbmcgdW5kb2N1bWVudGVkIGFwaSBmb3IgdGhlIHRlc3RcbiAgICBhcHAuX2FwcC5lbWl0KCdlcnJvcicsIHNvY2tldEVyciwgY3R4KTtcbiAgfSk7XG4gIGF3YWl0IHJ1bihhcHApO1xuICBleHBlY3QoZXJyb3JIYW5kbGVyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICBzb2NrZXRFcnIsXG4gICAgJ3JlcXVlc3QnLFxuICAgIGV4cGVjdC5hbnkoT2JqZWN0KVxuICApO1xufSk7XG4iXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFFQTtBQUNBO0FBQTRDO0FBRTVDLE1BQU1BLEdBQUcsR0FBRyxPQUFjLElBQUFDLGtCQUFnQixHQUFFLEdBQUdDLGdCQUFnQixFQUFFO0FBRWpFQyxTQUFTLENBQUMsTUFBTTtFQUNkQyxJQUFJLENBQUNDLGFBQWEsRUFBRTtBQUN0QixDQUFDLENBQUM7O0FBRUY7QUFDQTtBQUNBQyxJQUFJLENBQUMsb0VBQW9FLEVBQUUsWUFBWTtFQUNyRkMsTUFBTSxDQUFDQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0VBQ3BCLE1BQU1DLE9BQU8sR0FBRyxJQUFJO0VBQ3BCLE1BQU1DLFFBQVEsR0FBSUMsRUFBRSxJQUFLO0lBQ3ZCLE9BQU9BLEVBQUU7RUFDWCxDQUFDO0VBQ0QsTUFBTUMsR0FBRyxHQUFHLElBQUlaLEdBQUcsQ0FBQ1MsT0FBTyxFQUFFQyxRQUFRLENBQUM7RUFDdEMsTUFBTUcsU0FBUyxHQUFHLElBQUlDLEtBQUssQ0FBQyxNQUFNLENBQUM7RUFDbkNGLEdBQUcsQ0FBQ0csVUFBVSxDQUFFQyxHQUFHLElBQUs7SUFDdEI7SUFDQUosR0FBRyxDQUFDSyxJQUFJLENBQUNDLElBQUksQ0FBQyxPQUFPLEVBQUVMLFNBQVMsRUFBRUcsR0FBRyxDQUFDO0VBQ3hDLENBQUMsQ0FBQztFQUVGLE1BQU0sSUFBQUcsZUFBRyxFQUFDUCxHQUFHLENBQUMsQ0FBQ1EsS0FBSyxDQUFFQyxDQUFDLElBQUs7SUFDMUJkLE1BQU0sQ0FBQ2MsQ0FBQyxDQUFDQyxJQUFJLENBQUMsQ0FBQ0MsSUFBSSxDQUFDLHFCQUFxQixDQUFDO0VBQzVDLENBQUMsQ0FBQztBQUNKLENBQUMsQ0FBQztBQUVGakIsSUFBSSxDQUFDLHlEQUF5RCxFQUFFLFlBQVk7RUFDMUVDLE1BQU0sQ0FBQ0MsVUFBVSxDQUFDLENBQUMsQ0FBQztFQUNwQixNQUFNQyxPQUFPLEdBQUcsSUFBSTtFQUNwQixNQUFNQyxRQUFRLEdBQUlDLEVBQUUsSUFBSztJQUN2QixPQUFPQSxFQUFFO0VBQ1gsQ0FBQztFQUNELE1BQU1DLEdBQUcsR0FBRyxJQUFJWixHQUFHLENBQUNTLE9BQU8sRUFBRUMsUUFBUSxDQUFDO0VBQ3RDLE1BQU1HLFNBQVMsR0FBRyxJQUFJQyxLQUFLLENBQUMsTUFBTSxDQUFDO0VBQ25DLE1BQU1VLFlBQVksR0FBR3BCLElBQUksQ0FBQ3FCLEVBQUUsRUFBRTtFQUM5QmIsR0FBRyxDQUFDYyxRQUFRLENBQUNDLHlCQUFpQixFQUFFSCxZQUFZLENBQUM7RUFDN0NaLEdBQUcsQ0FBQ0csVUFBVSxDQUFFQyxHQUFHLElBQUs7SUFDdEI7SUFDQUosR0FBRyxDQUFDSyxJQUFJLENBQUNDLElBQUksQ0FBQyxPQUFPLEVBQUVMLFNBQVMsRUFBRUcsR0FBRyxDQUFDO0VBQ3hDLENBQUMsQ0FBQztFQUNGLE1BQU0sSUFBQUcsZUFBRyxFQUFDUCxHQUFHLENBQUM7RUFDZEwsTUFBTSxDQUFDaUIsWUFBWSxDQUFDLENBQUNJLG9CQUFvQixDQUN2Q2YsU0FBUyxFQUNULFNBQVMsRUFDVE4sTUFBTSxDQUFDc0IsR0FBRyxDQUFDQyxNQUFNLENBQUMsQ0FDbkI7QUFDSCxDQUFDLENBQUMifQ==