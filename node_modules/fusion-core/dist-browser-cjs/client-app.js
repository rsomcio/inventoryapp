"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;
var _compose = require("./compose");
var _timing = _interopRequireWildcard(require("./plugins/timing"));
var _baseApp = _interopRequireDefault(require("./base-app"));
var _clientHydrate = _interopRequireWildcard(require("./plugins/client-hydrate"));
var _clientRenderer = _interopRequireDefault(require("./plugins/client-renderer"));
var _tokens = require("./tokens");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }
function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }
/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */
/* eslint-env browser */

function _default() {
  return class ClientApp extends _baseApp.default {
    constructor(el, render) {
      super(el, render);
      this.register(_timing.TimingToken, _timing.default);
      this.middleware({
        element: _tokens.ElementToken
      }, _clientHydrate.default);
    }
    resolve() {
      this.middleware({
        render: _tokens.RenderToken
      }, (0, _clientRenderer.default)(this));
      return super.resolve();
    }
    callback() {
      this.resolve();
      const middleware = (0, _compose.compose)(this.plugins);
      return () => {
        // TODO(#62): Create noop context object to match server api
        const routePrefix = (0, _clientHydrate.getSerializedRoutePrefix)();
        const replaceRouteRegex = new RegExp(`^${routePrefix}`);
        const ctx = {
          url: (window.location.pathname + window.location.search).replace(replaceRouteRegex, ''),
          element: null,
          body: null
        };
        return middleware(ctx, () => Promise.resolve()).then(() => ctx);
      };
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJDbGllbnRBcHAiLCJCYXNlQXBwIiwiY29uc3RydWN0b3IiLCJlbCIsInJlbmRlciIsInJlZ2lzdGVyIiwiVGltaW5nVG9rZW4iLCJ0aW1pbmciLCJtaWRkbGV3YXJlIiwiZWxlbWVudCIsIkVsZW1lbnRUb2tlbiIsImNyZWF0ZUNsaWVudEh5ZHJhdGUiLCJyZXNvbHZlIiwiUmVuZGVyVG9rZW4iLCJjcmVhdGVDbGllbnRSZW5kZXJlciIsImNhbGxiYWNrIiwiY29tcG9zZSIsInBsdWdpbnMiLCJyb3V0ZVByZWZpeCIsImdldFNlcmlhbGl6ZWRSb3V0ZVByZWZpeCIsInJlcGxhY2VSb3V0ZVJlZ2V4IiwiUmVnRXhwIiwiY3R4IiwidXJsIiwid2luZG93IiwibG9jYXRpb24iLCJwYXRobmFtZSIsInNlYXJjaCIsInJlcGxhY2UiLCJib2R5IiwiUHJvbWlzZSIsInRoZW4iXSwic291cmNlcyI6WyJzcmMvY2xpZW50LWFwcC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKiogQ29weXJpZ2h0IChjKSAyMDE4IFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICovXG4vKiBlc2xpbnQtZW52IGJyb3dzZXIgKi9cbmltcG9ydCB7Y29tcG9zZX0gZnJvbSAnLi9jb21wb3NlJztcbmltcG9ydCB0aW1pbmcsIHtUaW1pbmdUb2tlbn0gZnJvbSAnLi9wbHVnaW5zL3RpbWluZyc7XG5pbXBvcnQgQmFzZUFwcCBmcm9tICcuL2Jhc2UtYXBwJztcbmltcG9ydCBjcmVhdGVDbGllbnRIeWRyYXRlLCB7XG4gIGdldFNlcmlhbGl6ZWRSb3V0ZVByZWZpeCxcbn0gZnJvbSAnLi9wbHVnaW5zL2NsaWVudC1oeWRyYXRlJztcbmltcG9ydCBjcmVhdGVDbGllbnRSZW5kZXJlciBmcm9tICcuL3BsdWdpbnMvY2xpZW50LXJlbmRlcmVyJztcbmltcG9ydCB7UmVuZGVyVG9rZW4sIEVsZW1lbnRUb2tlbn0gZnJvbSAnLi90b2tlbnMnO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiAoKSB7XG4gIHJldHVybiBjbGFzcyBDbGllbnRBcHAgZXh0ZW5kcyBCYXNlQXBwIHtcbiAgICBjb25zdHJ1Y3RvcihlbDogYW55LCByZW5kZXI6IGFueSkge1xuICAgICAgc3VwZXIoZWwsIHJlbmRlcik7XG4gICAgICB0aGlzLnJlZ2lzdGVyKFRpbWluZ1Rva2VuLCB0aW1pbmcpO1xuICAgICAgdGhpcy5taWRkbGV3YXJlKHtlbGVtZW50OiBFbGVtZW50VG9rZW59LCBjcmVhdGVDbGllbnRIeWRyYXRlKTtcbiAgICB9XG4gICAgcmVzb2x2ZSgpIHtcbiAgICAgIHRoaXMubWlkZGxld2FyZSh7cmVuZGVyOiBSZW5kZXJUb2tlbn0sIGNyZWF0ZUNsaWVudFJlbmRlcmVyKHRoaXMpKTtcbiAgICAgIHJldHVybiBzdXBlci5yZXNvbHZlKCk7XG4gICAgfVxuICAgIGNhbGxiYWNrKCkge1xuICAgICAgdGhpcy5yZXNvbHZlKCk7XG4gICAgICBjb25zdCBtaWRkbGV3YXJlID0gY29tcG9zZSh0aGlzLnBsdWdpbnMpO1xuICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgLy8gVE9ETygjNjIpOiBDcmVhdGUgbm9vcCBjb250ZXh0IG9iamVjdCB0byBtYXRjaCBzZXJ2ZXIgYXBpXG4gICAgICAgIGNvbnN0IHJvdXRlUHJlZml4ID0gZ2V0U2VyaWFsaXplZFJvdXRlUHJlZml4KCk7XG4gICAgICAgIGNvbnN0IHJlcGxhY2VSb3V0ZVJlZ2V4ID0gbmV3IFJlZ0V4cChgXiR7cm91dGVQcmVmaXh9YCk7XG4gICAgICAgIGNvbnN0IGN0eDogYW55ID0ge1xuICAgICAgICAgIHVybDogKHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZSArIHdpbmRvdy5sb2NhdGlvbi5zZWFyY2gpLnJlcGxhY2UoXG4gICAgICAgICAgICByZXBsYWNlUm91dGVSZWdleCxcbiAgICAgICAgICAgICcnXG4gICAgICAgICAgKSxcbiAgICAgICAgICBlbGVtZW50OiBudWxsLFxuICAgICAgICAgIGJvZHk6IG51bGwsXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBtaWRkbGV3YXJlKGN0eCwgKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkpLnRoZW4oKCkgPT4gY3R4KTtcbiAgICAgIH07XG4gICAgfVxuICB9O1xufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFPQTtBQUNBO0FBQ0E7QUFDQTtBQUdBO0FBQ0E7QUFBbUQ7QUFBQTtBQUFBO0FBZG5EO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQVVlLG9CQUFZO0VBQ3pCLE9BQU8sTUFBTUEsU0FBUyxTQUFTQyxnQkFBTyxDQUFDO0lBQ3JDQyxXQUFXLENBQUNDLEVBQU8sRUFBRUMsTUFBVyxFQUFFO01BQ2hDLEtBQUssQ0FBQ0QsRUFBRSxFQUFFQyxNQUFNLENBQUM7TUFDakIsSUFBSSxDQUFDQyxRQUFRLENBQUNDLG1CQUFXLEVBQUVDLGVBQU0sQ0FBQztNQUNsQyxJQUFJLENBQUNDLFVBQVUsQ0FBQztRQUFDQyxPQUFPLEVBQUVDO01BQVksQ0FBQyxFQUFFQyxzQkFBbUIsQ0FBQztJQUMvRDtJQUNBQyxPQUFPLEdBQUc7TUFDUixJQUFJLENBQUNKLFVBQVUsQ0FBQztRQUFDSixNQUFNLEVBQUVTO01BQVcsQ0FBQyxFQUFFLElBQUFDLHVCQUFvQixFQUFDLElBQUksQ0FBQyxDQUFDO01BQ2xFLE9BQU8sS0FBSyxDQUFDRixPQUFPLEVBQUU7SUFDeEI7SUFDQUcsUUFBUSxHQUFHO01BQ1QsSUFBSSxDQUFDSCxPQUFPLEVBQUU7TUFDZCxNQUFNSixVQUFVLEdBQUcsSUFBQVEsZ0JBQU8sRUFBQyxJQUFJLENBQUNDLE9BQU8sQ0FBQztNQUN4QyxPQUFPLE1BQU07UUFDWDtRQUNBLE1BQU1DLFdBQVcsR0FBRyxJQUFBQyx1Q0FBd0IsR0FBRTtRQUM5QyxNQUFNQyxpQkFBaUIsR0FBRyxJQUFJQyxNQUFNLENBQUUsSUFBR0gsV0FBWSxFQUFDLENBQUM7UUFDdkQsTUFBTUksR0FBUSxHQUFHO1VBQ2ZDLEdBQUcsRUFBRSxDQUFDQyxNQUFNLENBQUNDLFFBQVEsQ0FBQ0MsUUFBUSxHQUFHRixNQUFNLENBQUNDLFFBQVEsQ0FBQ0UsTUFBTSxFQUFFQyxPQUFPLENBQzlEUixpQkFBaUIsRUFDakIsRUFBRSxDQUNIO1VBQ0RYLE9BQU8sRUFBRSxJQUFJO1VBQ2JvQixJQUFJLEVBQUU7UUFDUixDQUFDO1FBQ0QsT0FBT3JCLFVBQVUsQ0FBQ2MsR0FBRyxFQUFFLE1BQU1RLE9BQU8sQ0FBQ2xCLE9BQU8sRUFBRSxDQUFDLENBQUNtQixJQUFJLENBQUMsTUFBTVQsR0FBRyxDQUFDO01BQ2pFLENBQUM7SUFDSDtFQUNGLENBQUM7QUFDSCJ9