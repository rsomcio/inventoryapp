"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = wrapMiddleware;
var _now = require("./now");
/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

const getSources = stacks => {
  // stack is of format: 'at file_xyz.js (/some/file/system/path.js:30:1)\n'
  return stacks.map(({
    type,
    stack = ''
  }) => {
    return {
      type,
      source: stack.split('\n').map(line => line.match(/\((.*?)\)/)).filter(match => match && match[1]).map(match => match[1]).map(to => false ? path.relative(process.cwd(), to) : to).shift()
    };
  });
};

// Wraps middleware for measuring middleware timing
function wrapMiddleware(existingMiddleware, token) {
  return async (ctx, next) => {
    const downstreamStart = (0, _now.now)();
    let upstreamStart = 0;
    const timing = {
      token: token.name,
      source: JSON.stringify(getSources(token.stacks)),
      downstream: -1,
      upstream: -1
    };
    if (ctx.timing) {
      ctx.timing.middleware.push(timing);
    }
    const wrapNext = async () => {
      timing.downstream = (0, _now.now)() - downstreamStart;
      await next();
      upstreamStart = (0, _now.now)();
    };
    await existingMiddleware(ctx, wrapNext);
    timing.upstream = (0, _now.now)() - upstreamStart;
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJnZXRTb3VyY2VzIiwic3RhY2tzIiwibWFwIiwidHlwZSIsInN0YWNrIiwic291cmNlIiwic3BsaXQiLCJsaW5lIiwibWF0Y2giLCJmaWx0ZXIiLCJ0byIsInBhdGgiLCJyZWxhdGl2ZSIsInByb2Nlc3MiLCJjd2QiLCJzaGlmdCIsIndyYXBNaWRkbGV3YXJlIiwiZXhpc3RpbmdNaWRkbGV3YXJlIiwidG9rZW4iLCJjdHgiLCJuZXh0IiwiZG93bnN0cmVhbVN0YXJ0Iiwibm93IiwidXBzdHJlYW1TdGFydCIsInRpbWluZyIsIm5hbWUiLCJKU09OIiwic3RyaW5naWZ5IiwiZG93bnN0cmVhbSIsInVwc3RyZWFtIiwibWlkZGxld2FyZSIsInB1c2giLCJ3cmFwTmV4dCJdLCJzb3VyY2VzIjpbInNyYy91dGlscy93cmFwLW1pZGRsZXdhcmUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqIENvcHlyaWdodCAoYykgMjAxOCBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqL1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQge25vd30gZnJvbSAnLi9ub3cnO1xuXG5pbXBvcnQgdHlwZSB7Q29udGV4dCwgTWlkZGxld2FyZX0gZnJvbSAnLi4vdHlwZXMnO1xuXG50eXBlIFN0YWNrc0Zvcm1hdCA9IHtcbiAgdHlwZTogJ3Rva2VuJyB8ICdyZWdpc3RlcicgfCAncGx1Z2luJztcbiAgc3RhY2s6IHN0cmluZztcbn07XG5cbmNvbnN0IGdldFNvdXJjZXMgPSAoc3RhY2tzOiBBcnJheTxTdGFja3NGb3JtYXQ+KSA9PiB7XG4gIC8vIHN0YWNrIGlzIG9mIGZvcm1hdDogJ2F0IGZpbGVfeHl6LmpzICgvc29tZS9maWxlL3N5c3RlbS9wYXRoLmpzOjMwOjEpXFxuJ1xuICByZXR1cm4gc3RhY2tzLm1hcCgoe3R5cGUsIHN0YWNrID0gJyd9KSA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGUsXG4gICAgICBzb3VyY2U6IHN0YWNrXG4gICAgICAgIC5zcGxpdCgnXFxuJylcbiAgICAgICAgLm1hcCgobGluZSkgPT4gbGluZS5tYXRjaCgvXFwoKC4qPylcXCkvKSlcbiAgICAgICAgLmZpbHRlcigobWF0Y2gpID0+IG1hdGNoICYmIG1hdGNoWzFdKVxuICAgICAgICAubWFwKChtYXRjaCkgPT4gKG1hdGNoIGFzIGFueSBhcyBBcnJheTxzdHJpbmc+KVsxXSlcbiAgICAgICAgLm1hcCgodG8pID0+IChfX05PREVfXyA/IHBhdGgucmVsYXRpdmUocHJvY2Vzcy5jd2QoKSwgdG8pIDogdG8pKVxuICAgICAgICAuc2hpZnQoKSxcbiAgICB9O1xuICB9KTtcbn07XG5cbi8vIFdyYXBzIG1pZGRsZXdhcmUgZm9yIG1lYXN1cmluZyBtaWRkbGV3YXJlIHRpbWluZ1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gd3JhcE1pZGRsZXdhcmUoXG4gIGV4aXN0aW5nTWlkZGxld2FyZTogTWlkZGxld2FyZSxcbiAgdG9rZW46IGFueVxuKTogTWlkZGxld2FyZSB7XG4gIHJldHVybiBhc3luYyAoY3R4OiBDb250ZXh0LCBuZXh0KSA9PiB7XG4gICAgY29uc3QgZG93bnN0cmVhbVN0YXJ0ID0gbm93KCk7XG4gICAgbGV0IHVwc3RyZWFtU3RhcnQgPSAwO1xuXG4gICAgY29uc3QgdGltaW5nID0ge1xuICAgICAgdG9rZW46IHRva2VuLm5hbWUsXG4gICAgICBzb3VyY2U6IEpTT04uc3RyaW5naWZ5KGdldFNvdXJjZXModG9rZW4uc3RhY2tzKSksXG4gICAgICBkb3duc3RyZWFtOiAtMSxcbiAgICAgIHVwc3RyZWFtOiAtMSxcbiAgICB9O1xuICAgIGlmIChjdHgudGltaW5nKSB7XG4gICAgICBjdHgudGltaW5nLm1pZGRsZXdhcmUucHVzaCh0aW1pbmcpO1xuICAgIH1cblxuICAgIGNvbnN0IHdyYXBOZXh0ID0gYXN5bmMgKCkgPT4ge1xuICAgICAgdGltaW5nLmRvd25zdHJlYW0gPSBub3coKSAtIGRvd25zdHJlYW1TdGFydDtcbiAgICAgIGF3YWl0IG5leHQoKTtcbiAgICAgIHVwc3RyZWFtU3RhcnQgPSBub3coKTtcbiAgICB9O1xuICAgIGF3YWl0IGV4aXN0aW5nTWlkZGxld2FyZShjdHgsIHdyYXBOZXh0KTtcbiAgICB0aW1pbmcudXBzdHJlYW0gPSBub3coKSAtIHVwc3RyZWFtU3RhcnQ7XG4gIH07XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQU9BO0FBUEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQVdBLE1BQU1BLFVBQVUsR0FBSUMsTUFBMkIsSUFBSztFQUNsRDtFQUNBLE9BQU9BLE1BQU0sQ0FBQ0MsR0FBRyxDQUFDLENBQUM7SUFBQ0MsSUFBSTtJQUFFQyxLQUFLLEdBQUc7RUFBRSxDQUFDLEtBQUs7SUFDeEMsT0FBTztNQUNMRCxJQUFJO01BQ0pFLE1BQU0sRUFBRUQsS0FBSyxDQUNWRSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQ1hKLEdBQUcsQ0FBRUssSUFBSSxJQUFLQSxJQUFJLENBQUNDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUN0Q0MsTUFBTSxDQUFFRCxLQUFLLElBQUtBLEtBQUssSUFBSUEsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQ3BDTixHQUFHLENBQUVNLEtBQUssSUFBTUEsS0FBSyxDQUEwQixDQUFDLENBQUMsQ0FBQyxDQUNsRE4sR0FBRyxDQUFFUSxFQUFFLElBQU0sUUFBV0MsSUFBSSxDQUFDQyxRQUFRLENBQUNDLE9BQU8sQ0FBQ0MsR0FBRyxFQUFFLEVBQUVKLEVBQUUsQ0FBQyxHQUFHQSxFQUFHLENBQUMsQ0FDL0RLLEtBQUs7SUFDVixDQUFDO0VBQ0gsQ0FBQyxDQUFDO0FBQ0osQ0FBQzs7QUFFRDtBQUNlLFNBQVNDLGNBQWMsQ0FDcENDLGtCQUE4QixFQUM5QkMsS0FBVSxFQUNFO0VBQ1osT0FBTyxPQUFPQyxHQUFZLEVBQUVDLElBQUksS0FBSztJQUNuQyxNQUFNQyxlQUFlLEdBQUcsSUFBQUMsUUFBRyxHQUFFO0lBQzdCLElBQUlDLGFBQWEsR0FBRyxDQUFDO0lBRXJCLE1BQU1DLE1BQU0sR0FBRztNQUNiTixLQUFLLEVBQUVBLEtBQUssQ0FBQ08sSUFBSTtNQUNqQnBCLE1BQU0sRUFBRXFCLElBQUksQ0FBQ0MsU0FBUyxDQUFDM0IsVUFBVSxDQUFDa0IsS0FBSyxDQUFDakIsTUFBTSxDQUFDLENBQUM7TUFDaEQyQixVQUFVLEVBQUUsQ0FBQyxDQUFDO01BQ2RDLFFBQVEsRUFBRSxDQUFDO0lBQ2IsQ0FBQztJQUNELElBQUlWLEdBQUcsQ0FBQ0ssTUFBTSxFQUFFO01BQ2RMLEdBQUcsQ0FBQ0ssTUFBTSxDQUFDTSxVQUFVLENBQUNDLElBQUksQ0FBQ1AsTUFBTSxDQUFDO0lBQ3BDO0lBRUEsTUFBTVEsUUFBUSxHQUFHLFlBQVk7TUFDM0JSLE1BQU0sQ0FBQ0ksVUFBVSxHQUFHLElBQUFOLFFBQUcsR0FBRSxHQUFHRCxlQUFlO01BQzNDLE1BQU1ELElBQUksRUFBRTtNQUNaRyxhQUFhLEdBQUcsSUFBQUQsUUFBRyxHQUFFO0lBQ3ZCLENBQUM7SUFDRCxNQUFNTCxrQkFBa0IsQ0FBQ0UsR0FBRyxFQUFFYSxRQUFRLENBQUM7SUFDdkNSLE1BQU0sQ0FBQ0ssUUFBUSxHQUFHLElBQUFQLFFBQUcsR0FBRSxHQUFHQyxhQUFhO0VBQ3pDLENBQUM7QUFDSCJ9